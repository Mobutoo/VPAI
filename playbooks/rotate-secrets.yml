---
# playbooks/rotate-secrets.yml — Rotate all passwords and keys
#
# Usage:
#   ansible-playbook playbooks/rotate-secrets.yml -e "target_env=prod"
#
# NOTE: This playbook generates new secrets and redeploys affected services.
#       n8n_encryption_key is NEVER rotated (would break encrypted workflows).

- name: Rotate Secrets
  hosts: "{{ target_env | default('prod') }}"
  gather_facts: true

  vars_prompt:
    - name: confirm_rotation
      prompt: "This will rotate ALL secrets and restart affected services. Type 'yes' to confirm"
      private: false

  pre_tasks:
    - name: Validate confirmation
      ansible.builtin.assert:
        that: confirm_rotation == 'yes'
        fail_msg: "Secret rotation aborted — confirmation required"

    - name: Display rotation info
      ansible.builtin.debug:
        msg: |
          ========================================
          SECRET ROTATION — {{ project_display_name }}
          Environment: {{ target_env | default('prod') }}
          WARNING: n8n_encryption_key will NOT be rotated
          Date: {{ ansible_date_time.iso8601 }}
          ========================================

  tasks:
    - name: Generate new PostgreSQL password
      ansible.builtin.set_fact:
        new_postgresql_password: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"

    - name: Generate new Redis password
      ansible.builtin.set_fact:
        new_redis_password: "{{ lookup('ansible.builtin.password', '/dev/null length=32 chars=ascii_letters,digits') }}"

    - name: Generate new Grafana admin password
      ansible.builtin.set_fact:
        new_grafana_admin_password: "{{ lookup('ansible.builtin.password', '/dev/null length=24 chars=ascii_letters,digits') }}"

    - name: Generate new LiteLLM master key
      ansible.builtin.set_fact:
        new_litellm_master_key: "sk-{{ lookup('ansible.builtin.password', '/dev/null length=48 chars=ascii_letters,digits') }}"

    - name: Generate new Qdrant API key
      ansible.builtin.set_fact:
        new_qdrant_api_key: "{{ lookup('ansible.builtin.password', '/dev/null length=48 chars=ascii_letters,digits') }}"

    - name: Generate new OpenClaw API key
      ansible.builtin.set_fact:
        new_openclaw_api_key: "{{ lookup('ansible.builtin.password', '/dev/null length=48 chars=ascii_letters,digits') }}"

    - name: Display new secrets (SAVE THESE)
      ansible.builtin.debug:
        msg: |
          ========================================
          NEW SECRETS — SAVE THESE IN ANSIBLE VAULT
          ========================================
          postgresql_password: {{ new_postgresql_password }}
          redis_password: {{ new_redis_password }}
          grafana_admin_password: {{ new_grafana_admin_password }}
          litellm_master_key: {{ new_litellm_master_key }}
          qdrant_api_key: {{ new_qdrant_api_key }}
          openclaw_api_key: {{ new_openclaw_api_key }}
          ========================================
          Run: ansible-vault edit inventory/group_vars/all/secrets.yml
          Update the above values, then re-run the full deploy.
          ========================================

    - name: Remind about vault update
      ansible.builtin.pause:
        prompt: |
          IMPORTANT: Update the secrets in Ansible Vault with the values above.
          Then run: make deploy-prod
          Press Enter to acknowledge.
