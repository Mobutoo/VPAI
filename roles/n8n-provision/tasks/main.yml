---
# n8n-provision — tasks
# Provisionne le compte owner n8n via API (après docker-stack)

- name: Check if n8n container exists
  ansible.builtin.command:
    cmd: "docker ps -q -f name={{ project_name }}_n8n"
  register: n8n_container_check
  changed_when: false
  failed_when: false
  become: true

- name: Skip n8n provisioning if container doesn't exist
  ansible.builtin.debug:
    msg: "⚠️  n8n container not found, skipping owner provisioning"
  when: n8n_container_check.stdout | default('') | length == 0

- name: Check if n8n owner is already provisioned
  ansible.builtin.command:
    cmd: >-
      docker exec {{ project_name }}_n8n
      sh -c 'curl -sf http://localhost:5678/rest/settings 2>/dev/null || echo "{}"'
  register: n8n_settings_check
  changed_when: false
  failed_when: false
  become: true
  when:
    - n8n_owner_email | default('') | length > 0
    - n8n_container_check.stdout | default('') | length > 0

- name: Set n8n setup state fact
  ansible.builtin.set_fact:
    n8n_setup_needed: >-
      {{ n8n_owner_email | default('') | length > 0 and
         n8n_container_check.stdout | default('') | length > 0 and
         '"showSetupPage":false' not in (n8n_settings_check.stdout | default('')) }}

- name: Wait for n8n container to be healthy
  ansible.builtin.command:
    cmd: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ project_name }}_n8n"
  register: n8n_health_status
  changed_when: false
  failed_when: false
  retries: 30
  delay: 5
  until: n8n_health_status.stdout | default('') == 'healthy'
  become: true
  when: n8n_setup_needed | bool

- name: Provision n8n owner account via API
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      docker exec {{ project_name }}_n8n sh -c '
        curl -sf -o /dev/null -w "%{http_code}" \
          -X POST http://localhost:5678/rest/owner/setup \
          -H "Content-Type: application/json" \
          -d "{
            \"email\":\"{{ n8n_owner_email }}\",
            \"firstName\":\"{{ n8n_owner_first_name }}\",
            \"lastName\":\"{{ n8n_owner_last_name }}\",
            \"password\":\"{{ n8n_owner_password }}\"
          }"
      '
  register: n8n_owner_result
  changed_when: n8n_owner_result.stdout | default('') == '200'
  failed_when: false
  no_log: true
  become: true
  when:
    - n8n_setup_needed | bool
    - n8n_health_status.stdout | default('') == 'healthy'

- name: Display n8n owner provisioning result
  ansible.builtin.debug:
    msg: >-
      {% if n8n_owner_result.stdout | default('') == '200' %}
      ✅ n8n owner account created successfully.
      {% elif n8n_owner_result.stdout | default('') == '400' %}
      ℹ️  n8n owner already exists (setup already completed). Skipping.
      {% elif not (n8n_setup_needed | bool) %}
      ℹ️  n8n owner already provisioned or not configured. Skipping.
      {% else %}
      ⚠️  WARNING: n8n owner provisioning returned HTTP {{ n8n_owner_result.stdout | default('unknown') }}.
      Manual setup may be needed at https://{{ caddy_admin_domain }}/n8n/
      {% endif %}

# ========================================================================
# Credential provisioning — PostgreSQL Main (pg-main)
# Required by Budget Monitor workflow to query litellm_spendlogs.
# Creates the credential if absent, skips if already present (idempotent).
# ========================================================================

- name: Provision PostgreSQL Main credential in n8n (pg-main for Budget Monitor)
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      cat > /tmp/n8n-cred-pg.js << 'CREDSCRIPT'
      const http = require('http');
      const [email, pw, pgPass] = process.argv.slice(2);

      function req(method, path, body, cookie) {
        return new Promise((resolve, reject) => {
          const h = { 'Content-Type': 'application/json' };
          if (cookie) h['Cookie'] = cookie;
          const opts = { hostname: '127.0.0.1', port: 5678, path, method, headers: h };
          const r = http.request(opts, (res) => {
            let d = ''; res.on('data', c => d += c);
            res.on('end', () => {
              const sc = res.headers['set-cookie'];
              resolve({ s: res.statusCode, d, c: sc ? sc[0].split(';')[0] : null });
            });
          });
          r.on('error', reject);
          if (body) r.write(JSON.stringify(body));
          r.end();
        });
      }

      (async () => {
        const login = await req('POST', '/rest/login', { emailOrLdapLoginId: email, password: pw });
        if (login.s !== 200 || !login.c) { console.log('LOGIN_FAILED'); process.exit(1); }

        // Check if credential already exists
        const list = await req('GET', '/rest/credentials', null, login.c);
        const creds = JSON.parse(list.d);
        const existing = (creds.data || []).find(c => c.name === 'PostgreSQL Main');
        if (existing) { console.log('EXISTS:' + existing.id); process.exit(0); }

        // Create new credential
        const result = await req('POST', '/rest/credentials', {
          name: 'PostgreSQL Main',
          type: 'postgres',
          data: {
            host: 'postgresql',
            port: 5432,
            database: 'litellm',
            user: 'litellm',
            password: pgPass,
            ssl: 'disable',
            allowUnauthorizedCerts: false
          }
        }, login.c);

        const created = JSON.parse(result.d);
        if (created.id) {
          console.log('CREATED:' + created.id);
        } else {
          console.log('FAIL:' + result.s + ':' + result.d.substring(0, 200));
          process.exit(1);
        }
      })().catch(e => { console.log('ERROR:' + e.message); process.exit(1); });
      CREDSCRIPT

      docker cp /tmp/n8n-cred-pg.js {{ project_name }}_n8n:/home/node/n8n-cred-pg.js
      RESULT=$(docker exec {{ project_name }}_n8n node /home/node/n8n-cred-pg.js \
        "{{ n8n_owner_email }}" "{{ n8n_owner_password }}" "{{ postgresql_password }}" 2>&1)
      echo "$RESULT"
  register: n8n_pg_cred_result
  changed_when: "'CREATED:' in (n8n_pg_cred_result.stdout | default(''))"
  failed_when: >-
    'LOGIN_FAILED' in (n8n_pg_cred_result.stdout | default('')) or
    'ERROR:' in (n8n_pg_cred_result.stdout | default(''))
  no_log: true
  become: true
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - n8n_owner_email | default('') | length > 0

- name: Display PostgreSQL credential provisioning result
  ansible.builtin.debug:
    msg: >-
      {% if 'CREATED:' in (n8n_pg_cred_result.stdout | default('')) %}
      ✅ n8n credential "PostgreSQL Main" créé (litellm DB).
      {% elif 'EXISTS:' in (n8n_pg_cred_result.stdout | default('')) %}
      ℹ️  n8n credential "PostgreSQL Main" déjà présent — skipping.
      {% else %}
      ⚠️  Résultat inattendu : {{ n8n_pg_cred_result.stdout | default('skipped') }}
      {% endif %}
  when: n8n_container_check.stdout | default('') | length > 0

# ========================================================================
# AI Workflow Import (OpenClaw -> n8n delegation)
# Supports both initial import AND updates via checksum comparison.
# Strategy: compare md5 of local JSON vs stored checksum on server.
# If different or new: delete old workflow via n8n API, reimport, publish.
# ========================================================================

- name: Ensure n8n workflow checksum directory exists
  ansible.builtin.file:
    path: "/opt/{{ project_name }}/configs/n8n/workflow-checksums"
    state: directory
    mode: "0755"
  become: true
  when: n8n_container_check.stdout | default('') | length > 0

# Pre-register RPi SSH host key in n8n container known_hosts
# Eliminates StrictHostKeyChecking=accept-new TOFU risk for github-autofix and code-review workflows.
# Runs only when WORKSTATION_PI_IP is configured and n8n container is up.
- name: Pre-register RPi SSH host key in n8n container known_hosts
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      PI_IP="{{ workstation_pi_tailscale_ip | default('') }}"
      if [ -z "$PI_IP" ]; then
        echo "SKIP: workstation_pi_tailscale_ip not configured"
        exit 0
      fi
      # Scan host key and add to n8n container known_hosts
      KNOWN_HOSTS=$(docker exec {{ project_name }}_n8n sh -c \
        "ssh-keyscan -T 5 $PI_IP 2>/dev/null")
      if [ -z "$KNOWN_HOSTS" ]; then
        echo "WARN: ssh-keyscan returned nothing for $PI_IP — container may not reach Pi yet"
        exit 0
      fi
      docker exec {{ project_name }}_n8n sh -c "
        mkdir -p /home/node/.ssh && chmod 700 /home/node/.ssh
        touch /home/node/.ssh/known_hosts && chmod 600 /home/node/.ssh/known_hosts
        grep -qF '$PI_IP' /home/node/.ssh/known_hosts || echo '$KNOWN_HOSTS' >> /home/node/.ssh/known_hosts
      "
      echo "OK: host key registered for $PI_IP"
  register: n8n_known_hosts_result
  changed_when: "'OK:' in (n8n_known_hosts_result.stdout | default(''))"
  failed_when: false
  become: true
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - workstation_pi_tailscale_ip | default('') | length > 0

# Template workflows that require Ansible variable substitution (cross-host URLs)
- name: Template creative-pipeline workflow (resolves workstation Caddy URLs)
  ansible.builtin.template:
    src: "workflows/creative-pipeline.json.j2"
    dest: "/tmp/n8n-workflow-creative-pipeline.json"
    mode: "0644"
  become: true
  when: n8n_container_check.stdout | default('') | length > 0

- name: Template plan-dispatch workflow (resolves KANEO_PUBLIC_URL + Jinja2 vars)
  ansible.builtin.template:
    src: "workflows/plan-dispatch.json.j2"
    dest: "/tmp/n8n-workflow-plan-dispatch.json"
    mode: "0644"
  become: true
  when: n8n_container_check.stdout | default('') | length > 0

- name: Copy n8n workflow files to server
  ansible.builtin.copy:
    src: "workflows/{{ item }}.json"
    dest: "/tmp/n8n-workflow-{{ item }}.json"
    mode: "0644"
  become: true
  loop:
    - ai-translate
    - ai-summarize
    - ai-format
    - ai-model-scoring
    - cve-watcher
    - openclaw-delegate
    - ig-comment-reply
    - ig-dm-reply
    - video-generate
    - email-cleanup
    - email-reply-suggest
    - content-generate
    - budget-monitor
    - budget-control
    - github-autofix
    - stack-health
    - asset-register
    - opencut-control
    - code-review
    - error-to-task
    - project-status
    - litellm-credit-alert
    - palais-standup
    - palais-insight-alert
    - launch-claude-code
  when: n8n_container_check.stdout | default('') | length > 0

- name: Check workflow update status (checksum comparison)
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      CHECKSUM_DIR="/opt/{{ project_name }}/configs/n8n/workflow-checksums"
      FILE="/tmp/n8n-workflow-{{ item.file }}.json"
      NEW_MD5=$(md5sum "$FILE" | cut -d' ' -f1)
      OLD_MD5=""
      if [ -f "$CHECKSUM_DIR/{{ item.file }}.md5" ]; then
        OLD_MD5=$(cat "$CHECKSUM_DIR/{{ item.file }}.md5")
      fi
      # Store checksum now — file is guaranteed to exist (md5sum would have failed otherwise)
      echo "$NEW_MD5" > "$CHECKSUM_DIR/{{ item.file }}.md5"
      if [ "$NEW_MD5" = "$OLD_MD5" ]; then
        echo "UNCHANGED"
      else
        echo "NEEDS_UPDATE"
      fi
  register: n8n_workflow_check
  changed_when: false
  become: true
  loop:
    - {file: "ai-translate", name: "AI Translate"}
    - {file: "ai-summarize", name: "AI Summarize"}
    - {file: "ai-format", name: "AI Format"}
    - {file: "ai-model-scoring", name: "AI Model Scoring"}
    - {file: "cve-watcher", name: "CVE Watcher"}
    - {file: "openclaw-delegate", name: "OpenClaw Delegate"}
    - {file: "ig-comment-reply", name: "Instagram Comment Reply"}
    - {file: "ig-dm-reply", name: "Instagram DM Reply"}
    - {file: "video-generate", name: "Video Generate (Seedance)"}
    - {file: "email-cleanup", name: "Email Cleanup & Classifier"}
    - {file: "email-reply-suggest", name: "Email Reply Suggest"}
    - {file: "content-generate", name: "Content Generate"}
    - {file: "budget-monitor", name: "Budget Monitor"}
    - {file: "budget-control", name: "Budget Control"}
    - {file: "github-autofix", name: "GitHub Auto-Fix"}
    - {file: "stack-health", name: "Stack Health Check"}
    - {file: "creative-pipeline", name: "Creative Pipeline"}
    - {file: "asset-register", name: "Asset Register"}
    - {file: "opencut-control", name: "OpenCut Control"}
    - {file: "code-review", name: "OpenClaw Code Review"}
    - {file: "error-to-task", name: "OpenClaw Error to Task"}
    - {file: "project-status", name: "OpenClaw Project Status"}
    - {file: "plan-dispatch", name: "OpenClaw Plan Dispatch"}
    - {file: "litellm-credit-alert", name: "LiteLLM Credit Alert"}
    - {file: "palais-standup", name: "Palais Daily Standup"}
    - {file: "palais-insight-alert", name: "Palais Insight Alert"}
    - {file: "launch-claude-code", name: "Palais Launch Claude Code"}
  loop_control:
    label: "{{ item.name }}"
  when: n8n_container_check.stdout | default('') | length > 0

- name: Display workflow update status
  ansible.builtin.debug:
    msg: >-
      {% for result in n8n_workflow_check.results | default([]) %}
      {{ result.item.name }}: {{ result.stdout | default('skipped') }}
      {% endfor %}
  when: n8n_container_check.stdout | default('') | length > 0

- name: Copy workflow files into n8n container
  ansible.builtin.command:
    cmd: >-
      docker cp /tmp/n8n-workflow-{{ item.item.file }}.json
      {{ project_name }}_n8n:/tmp/n8n-workflow-{{ item.item.file }}.json
  become: true
  changed_when: false
  loop: "{{ n8n_workflow_check.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - item.stdout | default('') == 'NEEDS_UPDATE'

- name: Delete existing workflows that need update via n8n API
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      WORKFLOW_NAME="{{ item.item.name }}"

      # Get workflow ID from list
      WORKFLOW_ID=$(docker exec {{ project_name }}_n8n n8n list:workflow 2>/dev/null | \
        grep -F "$WORKFLOW_NAME" | head -1 | cut -d'|' -f1 | xargs)

      if [ -z "$WORKFLOW_ID" ]; then
        echo "NEW: Workflow '$WORKFLOW_NAME' does not exist yet"
        exit 0
      fi

      # n8n v2.7+: Deactivate -> Archive -> Delete (via Node.js, no curl in container)
      cat > /tmp/n8n-delete-wf.js << 'DELSCRIPT'
      const http = require('http');
      const [wfId, email, pw] = process.argv.slice(2);
      function req(method, path, body, cookie) {
        return new Promise((resolve, reject) => {
          const h = { 'Content-Type': 'application/json' };
          if (cookie) h['Cookie'] = cookie;
          const r = http.request({ hostname: '127.0.0.1', port: 5678, path, method, headers: h }, (res) => {
            let d = ''; res.on('data', c => d += c);
            res.on('end', () => {
              const sc = res.headers['set-cookie'];
              resolve({ s: res.statusCode, d, c: sc ? sc[0].split(';')[0] : null });
            });
          });
          r.on('error', reject);
          if (body) r.write(JSON.stringify(body));
          r.end();
        });
      }
      (async () => {
        const login = await req('POST', '/rest/login', { emailOrLdapLoginId: email, password: pw });
        if (login.s !== 200 || !login.c) { console.log('LOGIN_FAILED'); process.exit(1); }
        await req('PATCH', '/rest/workflows/' + wfId, { active: false }, login.c);
        await req('POST', '/rest/workflows/' + wfId + '/archive', null, login.c);
        const del = await req('DELETE', '/rest/workflows/' + wfId, null, login.c);
        console.log(del.s === 200 ? 'DELETED' : 'FAIL:' + del.s);
      })().catch(() => { console.log('ERROR'); process.exit(1); });
      DELSCRIPT

      docker cp /tmp/n8n-delete-wf.js {{ project_name }}_n8n:/home/node/n8n-delete-wf.js
      RESULT=$(docker exec {{ project_name }}_n8n node /home/node/n8n-delete-wf.js \
        "$WORKFLOW_ID" "{{ n8n_owner_email }}" "{{ n8n_owner_password }}" 2>&1)

      if [ "$RESULT" = "DELETED" ]; then
        echo "DELETED: $WORKFLOW_NAME (ID: $WORKFLOW_ID)"
      else
        echo "WARN: $RESULT for $WORKFLOW_NAME (ID: $WORKFLOW_ID)"
      fi
  register: n8n_workflow_delete
  changed_when: "'DELETED:' in (n8n_workflow_delete.stdout | default(''))"
  failed_when: false
  no_log: true
  become: true
  loop: "{{ n8n_workflow_check.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - item.stdout | default('') == 'NEEDS_UPDATE'

- name: Import n8n AI workflows via CLI
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      WORKFLOW_NAME="{{ item.item.name }}"
      WORKFLOW_FILE="/tmp/n8n-workflow-{{ item.item.file }}.json"

      # Import the workflow
      docker exec {{ project_name }}_n8n n8n import:workflow --input="$WORKFLOW_FILE" 2>&1
      echo "IMPORTED: $WORKFLOW_NAME"
  register: n8n_workflow_import
  changed_when: "'IMPORTED:' in n8n_workflow_import.stdout"
  failed_when: false
  become: true
  loop: "{{ n8n_workflow_check.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - item.stdout | default('') == 'NEEDS_UPDATE'

- name: Activate imported n8n AI workflows
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      WORKFLOW_NAME="{{ item.item.name }}"

      # Get workflow ID from list (format: "ID|Name")
      WORKFLOW_ID=$(docker exec {{ project_name }}_n8n n8n list:workflow 2>/dev/null | \
        grep -F "$WORKFLOW_NAME" | head -1 | cut -d'|' -f1 | xargs)

      if [ -z "$WORKFLOW_ID" ]; then
        echo "SKIP: Workflow '$WORKFLOW_NAME' not found, cannot activate"
        exit 0
      fi

      # Publish (activate) via n8n CLI (v2.7+ uses publish:workflow)
      docker exec {{ project_name }}_n8n n8n publish:workflow --id="$WORKFLOW_ID" 2>&1 || true
      echo "ACTIVATED: $WORKFLOW_NAME (ID: $WORKFLOW_ID)"
  register: n8n_workflow_activate
  changed_when: "'ACTIVATED:' in n8n_workflow_activate.stdout"
  failed_when: false
  become: true
  loop: "{{ n8n_workflow_check.results | default([]) }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - item.stdout | default('') == 'NEEDS_UPDATE'

- name: Store workflow checksums after successful deploy
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      CHECKSUM_DIR="/opt/{{ project_name }}/configs/n8n/workflow-checksums"
      FILE="/tmp/n8n-workflow-{{ item.file }}.json"
      md5sum "$FILE" | cut -d' ' -f1 > "$CHECKSUM_DIR/{{ item.file }}.md5"
  become: true
  changed_when: false
  failed_when: false  # /tmp files may not exist on partial/diagnostic runs — safe to skip
  loop:
    - {file: "ai-translate", name: "AI Translate"}
    - {file: "ai-summarize", name: "AI Summarize"}
    - {file: "ai-format", name: "AI Format"}
    - {file: "ai-model-scoring", name: "AI Model Scoring"}
    - {file: "cve-watcher", name: "CVE Watcher"}
    - {file: "openclaw-delegate", name: "OpenClaw Delegate"}
    - {file: "ig-comment-reply", name: "Instagram Comment Reply"}
    - {file: "ig-dm-reply", name: "Instagram DM Reply"}
    - {file: "video-generate", name: "Video Generate (Seedance)"}
    - {file: "email-cleanup", name: "Email Cleanup & Classifier"}
    - {file: "email-reply-suggest", name: "Email Reply Suggest"}
    - {file: "content-generate", name: "Content Generate"}
    - {file: "budget-monitor", name: "Budget Monitor"}
    - {file: "budget-control", name: "Budget Control"}
    - {file: "github-autofix", name: "GitHub Auto-Fix"}
    - {file: "stack-health", name: "Stack Health Check"}
    - {file: "creative-pipeline", name: "Creative Pipeline"}
    - {file: "asset-register", name: "Asset Register"}
    - {file: "opencut-control", name: "OpenCut Control"}
    - {file: "code-review", name: "OpenClaw Code Review"}
    - {file: "error-to-task", name: "OpenClaw Error to Task"}
    - {file: "project-status", name: "OpenClaw Project Status"}
    - {file: "plan-dispatch", name: "OpenClaw Plan Dispatch"}
    - {file: "litellm-credit-alert", name: "LiteLLM Credit Alert"}
    - {file: "palais-standup", name: "Palais Daily Standup"}
    - {file: "palais-insight-alert", name: "Palais Insight Alert"}
    - {file: "launch-claude-code", name: "Palais Launch Claude Code"}
  loop_control:
    label: "{{ item.name }}"
  when: n8n_container_check.stdout | default('') | length > 0

- name: Restart n8n to activate published workflows
  ansible.builtin.command:
    cmd: "docker restart {{ project_name }}_n8n"
  become: true
  changed_when: true
  when:
    - n8n_container_check.stdout | default('') | length > 0
    - n8n_workflow_check.results | default([]) | selectattr('stdout', 'equalto', 'NEEDS_UPDATE') | list | length > 0

- name: Clean up temporary workflow files
  ansible.builtin.file:
    path: "/tmp/n8n-workflow-{{ item }}.json"
    state: absent
  become: true
  loop:
    - ai-translate
    - ai-summarize
    - ai-format
    - ai-model-scoring
    - cve-watcher
    - openclaw-delegate
    - ig-comment-reply
    - ig-dm-reply
    - video-generate
    - email-cleanup
    - email-reply-suggest
    - content-generate
    - budget-monitor
    - budget-control
    - github-autofix
    - stack-health
    - creative-pipeline
    - asset-register
    - opencut-control
    - code-review
    - error-to-task
    - project-status
    - plan-dispatch
    - palais-standup
    - palais-insight-alert
    - launch-claude-code
  when: n8n_container_check.stdout | default('') | length > 0

- name: Display n8n workflow update results
  ansible.builtin.debug:
    msg: >-
      {% set updated = n8n_workflow_check.results | default([]) | selectattr('stdout', 'equalto', 'NEEDS_UPDATE') | list %}
      {% if updated | length > 0 %}
      Updated {{ updated | length }} workflow(s):
      {% for result in n8n_workflow_import.results | default([]) %}
      {{ result.item.item.name | default('?') }}: {{ result.stdout | default('skipped') }}
      {% endfor %}
      {% else %}
      All workflows up to date (checksums match).
      {% endif %}
  when:
    - n8n_container_check.stdout | default('') | length > 0

# ========================================================================
# WORKFLOW NUKE — delete ALL workflows (use with --tags n8n-nuke)
# Sequence per workflow: deactivate → archive → delete
# Also resets checksums so next deploy reimports everything.
# Usage: ansible-playbook playbooks/site.yml --tags n8n-nuke
# ========================================================================

- name: "[nuke] Check n8n container exists"
  ansible.builtin.command:
    cmd: "docker ps -q -f name={{ project_name }}_n8n"
  register: n8n_nuke_container_check
  changed_when: false
  failed_when: false
  become: true
  tags: [n8n-nuke, never]

- name: "[nuke] Delete ALL n8n workflows (deactivate → archive → delete each)"
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      cat > /tmp/n8n-nuke-all.js << 'NUKESCRIPT'
      const http = require('http');
      const [email, pw] = process.argv.slice(2);

      function req(method, path, body, cookie) {
        return new Promise((resolve, reject) => {
          const h = { 'Content-Type': 'application/json' };
          if (cookie) h['Cookie'] = cookie;
          const opts = { hostname: '127.0.0.1', port: 5678, path, method, headers: h };
          const r = http.request(opts, (res) => {
            let d = ''; res.on('data', c => d += c);
            res.on('end', () => {
              const sc = res.headers['set-cookie'];
              resolve({ s: res.statusCode, d, c: sc ? sc[0].split(';')[0] : null });
            });
          });
          r.on('error', reject);
          if (body) r.write(JSON.stringify(body));
          r.end();
        });
      }

      (async () => {
        const login = await req('POST', '/rest/login', { emailOrLdapLoginId: email, password: pw });
        if (login.s !== 200 || !login.c) { console.log('LOGIN_FAILED'); process.exit(1); }

        let allWorkflows = [];
        let skip = 0;
        while (true) {
          const res = await req('GET', '/rest/workflows?limit=50&skip=' + skip, null, login.c);
          const data = JSON.parse(res.d);
          const items = data.data || [];
          allWorkflows = allWorkflows.concat(items);
          if (items.length < 50) break;
          skip += 50;
        }
        console.log('FOUND:' + allWorkflows.length);

        for (const wf of allWorkflows) {
          try {
            await req('PATCH', '/rest/workflows/' + wf.id, { active: false }, login.c);
            await req('POST', '/rest/workflows/' + wf.id + '/archive', null, login.c);
            const del = await req('DELETE', '/rest/workflows/' + wf.id, null, login.c);
            console.log(del.s === 200 ? 'DELETED:' + wf.name : 'FAIL:' + del.s + ':' + wf.name);
          } catch (e) {
            console.log('ERROR:' + wf.name + ':' + e.message);
          }
        }
        console.log('NUKE_COMPLETE');
      })().catch(e => { console.log('FATAL:' + e.message); process.exit(1); });
      NUKESCRIPT

      docker cp /tmp/n8n-nuke-all.js {{ project_name }}_n8n:/home/node/n8n-nuke-all.js
      RESULT=$(docker exec {{ project_name }}_n8n node /home/node/n8n-nuke-all.js \
        "{{ n8n_owner_email }}" "{{ n8n_owner_password }}" 2>&1)
      echo "$RESULT"
  register: n8n_nuke_result
  changed_when: "'NUKE_COMPLETE' in (n8n_nuke_result.stdout | default(''))"
  failed_when: >-
    'LOGIN_FAILED' in (n8n_nuke_result.stdout | default('')) or
    'FATAL:' in (n8n_nuke_result.stdout | default(''))
  no_log: true
  become: true
  tags: [n8n-nuke, never]
  when: n8n_nuke_container_check.stdout | default('') | length > 0

- name: "[nuke] Display results"
  ansible.builtin.debug:
    msg: "{{ n8n_nuke_result.stdout_lines | default(['skipped']) }}"
  tags: [n8n-nuke, never]
  when: n8n_nuke_container_check.stdout | default('') | length > 0

- name: "[nuke] Reset workflow checksums (force full reimport on next deploy)"
  ansible.builtin.file:
    path: "/opt/{{ project_name }}/configs/n8n/workflow-checksums"
    state: absent
  become: true
  tags: [n8n-nuke, never]
  when: n8n_nuke_container_check.stdout | default('') | length > 0

- name: "[nuke] Recreate empty checksum directory"
  ansible.builtin.file:
    path: "/opt/{{ project_name }}/configs/n8n/workflow-checksums"
    state: directory
    mode: "0755"
  become: true
  tags: [n8n-nuke, never]
  when: n8n_nuke_container_check.stdout | default('') | length > 0
