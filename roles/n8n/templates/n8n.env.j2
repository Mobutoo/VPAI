# {{ ansible_managed }}
# n8n environment configuration

# Database
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgresql
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD={{ postgresql_password }}

# Encryption
N8N_ENCRYPTION_KEY={{ n8n_encryption_key }}

# URLs
N8N_HOST=0.0.0.0
N8N_PORT=5678
N8N_PROTOCOL=https
# Proxy trust — Caddy reverse proxy adds X-Forwarded-For (1 hop)
# Without this, express-rate-limit throws ERR_ERL_UNEXPECTED_X_FORWARDED_FOR
N8N_PROXY_HOPS=1
{% if n8n_subdomain | default('') | length > 0 %}
# Dedicated subdomain — n8n on root path (no sub-path issues)
WEBHOOK_URL=https://{{ n8n_subdomain }}.{{ domain_name }}/
N8N_EDITOR_BASE_URL=https://{{ n8n_subdomain }}.{{ domain_name }}/
{% else %}
# Sub-path mode (limited — see n8n issue #19635)
WEBHOOK_URL=https://{{ domain_name }}/n8n/
N8N_EDITOR_BASE_URL=https://{{ caddy_admin_domain }}/n8n/
{% endif %}

# User management
N8N_USER_MANAGEMENT_DISABLED=false

# Task Runners (v2.0 security)
N8N_RUNNERS_ENABLED=true
N8N_RUNNERS_MODE=internal

# Code node permissions (n8n 2.0+ blocks these by default)
# fs: read/write JSON cache, path: file operations, crypto: HMAC validation
NODE_FUNCTION_ALLOW_BUILTIN=fs,path,crypto
# pg: PostgreSQL client (already installed in n8n image as internal dependency)
# Used by ai-model-scoring workflow to read/write model_scores table
NODE_FUNCTION_ALLOW_EXTERNAL=pg
# Allow Code nodes to access env vars via $env (needed for webhook secret validation)
# Security: only custom env vars are exposed (N8N_WEBHOOK_HMAC_SECRET, LITELLM_API_KEY)
N8N_BLOCK_ENV_ACCESS_IN_NODE=false

# Timezone
GENERIC_TIMEZONE={{ timezone }}
TZ={{ timezone }}

# Executions
EXECUTIONS_DATA_PRUNE=true
EXECUTIONS_DATA_MAX_AGE=168

# OpenClaw <-> n8n webhook integration
# Custom env var read by n8n workflows via {{ '$env.N8N_WEBHOOK_HMAC_SECRET' }}
# to validate incoming webhook calls from OpenClaw (not a built-in n8n feature)
{% if n8n_webhook_secret | default('') | length > 0 %}
N8N_WEBHOOK_HMAC_SECRET={{ n8n_webhook_secret }}
{% endif %}

# LiteLLM API key — used by AI workflows (translate, summarize, format)
# to call LiteLLM proxy at http://litellm:4000 via $env.LITELLM_API_KEY
LITELLM_API_KEY={{ litellm_master_key }}

# Telegram monitoring bot — used by budget-monitor + budget-control workflows
# to send alerts and budget status notifications
{% if telegram_monitoring_bot_token | default('') | length > 0 %}
TELEGRAM_MONITORING_BOT_TOKEN={{ telegram_monitoring_bot_token }}
TELEGRAM_MONITORING_CHAT_ID={{ telegram_monitoring_chat_id }}
{% endif %}
