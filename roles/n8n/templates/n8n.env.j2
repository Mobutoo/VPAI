# {{ ansible_managed }}
# n8n environment configuration

# Database
DB_TYPE=postgresdb
DB_POSTGRESDB_HOST=postgresql
DB_POSTGRESDB_PORT=5432
DB_POSTGRESDB_DATABASE=n8n
DB_POSTGRESDB_USER=n8n
DB_POSTGRESDB_PASSWORD={{ postgresql_password }}

# Encryption
N8N_ENCRYPTION_KEY={{ n8n_encryption_key }}

# URLs
N8N_HOST=0.0.0.0
N8N_PORT=5678
N8N_PROTOCOL=https
# Proxy trust — Caddy reverse proxy adds X-Forwarded-For (1 hop)
# Without this, express-rate-limit throws ERR_ERL_UNEXPECTED_X_FORWARDED_FOR
N8N_PROXY_HOPS=1
{% if n8n_subdomain | default('') | length > 0 %}
# Dedicated subdomain — n8n on root path (no sub-path issues)
WEBHOOK_URL=https://{{ n8n_subdomain }}.{{ domain_name }}/
N8N_EDITOR_BASE_URL=https://{{ n8n_subdomain }}.{{ domain_name }}/
{% else %}
# Sub-path mode (limited — see n8n issue #19635)
WEBHOOK_URL=https://{{ domain_name }}/n8n/
N8N_EDITOR_BASE_URL=https://{{ caddy_admin_domain }}/n8n/
{% endif %}

# User management
N8N_USER_MANAGEMENT_DISABLED=false

# Task Runners (v2.0 security)
N8N_RUNNERS_ENABLED=true
N8N_RUNNERS_MODE=internal

# Code node permissions (n8n 2.0+ blocks these by default)
# fs: read/write JSON cache, path: file operations, crypto: HMAC validation
# child_process: replaces deprecated executeCommand node (removed in n8n 2.x)
NODE_FUNCTION_ALLOW_BUILTIN=fs,path,crypto,child_process
# pg: PostgreSQL client (already installed in n8n image as internal dependency)
# Used by ai-model-scoring workflow to read/write model_scores table
NODE_FUNCTION_ALLOW_EXTERNAL=pg
# Allow Code nodes to access env vars via $env (needed for webhook secret validation)
# Security: only custom env vars are exposed (N8N_WEBHOOK_HMAC_SECRET, LITELLM_API_KEY)
N8N_BLOCK_ENV_ACCESS_IN_NODE=false

# Timezone
GENERIC_TIMEZONE={{ timezone }}
TZ={{ timezone }}

# Executions
EXECUTIONS_DATA_PRUNE=true
EXECUTIONS_DATA_MAX_AGE=168

# OpenClaw <-> n8n webhook integration
# Custom env var read by n8n workflows via {{ '$env.N8N_WEBHOOK_HMAC_SECRET' }}
# to validate incoming webhook calls from OpenClaw (not a built-in n8n feature)
{% if n8n_webhook_secret | default('') | length > 0 %}
N8N_WEBHOOK_HMAC_SECRET={{ n8n_webhook_secret }}
{% endif %}

# LiteLLM API key — used by AI workflows (translate, summarize, format)
# to call LiteLLM proxy at http://litellm:4000 via $env.LITELLM_API_KEY
LITELLM_API_KEY={{ litellm_master_key }}

# Telegram monitoring bot — used by budget-monitor + budget-control workflows
# to send alerts and budget status notifications
{% if telegram_monitoring_bot_token | default('') | length > 0 %}
TELEGRAM_MONITORING_BOT_TOKEN={{ telegram_monitoring_bot_token }}
TELEGRAM_MONITORING_CHAT_ID={{ telegram_monitoring_chat_id }}
{% endif %}

# GitHub webhook secret — used by github-autofix workflow to validate HMAC signatures
# (X-Hub-Signature-256) from GitHub webhook events
{% if github_webhook_secret | default('') | length > 0 %}
GITHUB_WEBHOOK_SECRET={{ github_webhook_secret }}
{% endif %}

# Workstation Pi SSH — used by github-autofix + code-review workflows to execute commands remotely
# Uses Tailscale IP (not LAN IP) — n8n runs on VPS and reaches RPi via mesh VPN
{% if workstation_pi_tailscale_ip | default('') | length > 0 %}
WORKSTATION_PI_IP={{ workstation_pi_tailscale_ip }}
WORKSTATION_PI_USER={{ workstation_pi_user | default('pi') }}
WORKSTATION_SSH_KEY_PATH={{ workstation_ssh_key_path | default('/home/node/.ssh/id_ed25519') }}
{% if opencut_subdomain | default('') | length > 0 %}
OPENCUT_DOMAIN={{ opencut_subdomain }}.{{ domain_name }}
{% endif %}
{% endif %}

# Kaneo agent credentials — used by kaneo-agents-sync, code-review, error-to-task, project-status
# workflows to authenticate against the Kaneo BetterAuth API
KANEO_API_URL=http://kaneo-api:1337
{% if kaneo_agent_email | default('') | length > 0 %}
KANEO_AGENT_EMAIL={{ kaneo_agent_email }}
KANEO_AGENT_PASSWORD={{ kaneo_agent_password }}
{% endif %}
{% if kaneo_agents_password | default('') | length > 0 %}
# Shared password for 10 OpenClaw agent service accounts (agent-<id>@<domain>)
KANEO_AGENTS_PASSWORD={{ kaneo_agents_password }}
KANEO_AGENT_DOMAIN={{ domain_name }}
{% endif %}

# Boîte à Idées — plan-dispatch webhook (called by Messenger approve_idea command)
# Triggers n8n plan-dispatch workflow to decompose approved plans into Kaneo tasks
KANEO_PLAN_DISPATCH_WEBHOOK=http://n8n:5678/webhook/plan-dispatch
# Public Kaneo URL — used in Telegram notification links from plan-dispatch workflow
KANEO_PUBLIC_URL=https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}
