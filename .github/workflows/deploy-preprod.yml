---
# .github/workflows/deploy-preprod.yml — Deploy to pre-production
name: Deploy Pre-production

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: true
        type: choice
        options:
          - fast
          - normal
        default: fast
  push:
    branches: [main]
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'inventory/**'
      - 'templates/**'

env:
  ANSIBLE_FORCE_COLOR: "1"
  PREPROD_SERVER_NAME: "vpai-preprod"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install ansible ansible-lint yamllint
      - run: ansible-galaxy install -r requirements.yml
      - run: yamllint -c .yamllint.yml .
      - run: ansible-lint playbooks/site.yml

  provision:
    name: Provision Hetzner Server
    needs: lint
    runs-on: ubuntu-latest
    outputs:
      server_ip: ${{ steps.resolve.outputs.ip }}
      server_id: ${{ steps.resolve.outputs.id }}
      was_created: ${{ steps.resolve.outputs.was_created }}
    steps:
      - uses: actions/checkout@v4

      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Resolve or create preprod server
        id: resolve
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_CLOUD_TOKEN }}
        run: |
          set -euo pipefail

          # Check if a persistent preprod server already exists
          EXISTING=$(hcloud server list --selector project=vpai-preprod \
            -o json 2>/dev/null | jq -r '.[0] // empty')

          if [ -n "$EXISTING" ] && [ "$EXISTING" != "null" ]; then
            IP=$(echo "$EXISTING" | jq -r '.public_net.ipv4.ip')
            ID=$(echo "$EXISTING" | jq -r '.id')
            echo "Reusing existing server: $IP (ID: $ID)"
            echo "ip=$IP" >> "$GITHUB_OUTPUT"
            echo "id=$ID" >> "$GITHUB_OUTPUT"
            echo "was_created=false" >> "$GITHUB_OUTPUT"
          else
            echo "No existing preprod server found, creating one..."

            # Try to restore from snapshot
            SNAPSHOT_ID=$(hcloud image list --type snapshot \
              --selector project=vpai \
              -o json 2>/dev/null | jq -r '.[0].id // empty') || true

            if [ -n "$SNAPSHOT_ID" ]; then
              echo "Restoring from snapshot $SNAPSHOT_ID"
              SERVER_JSON=$(hcloud server create \
                --name "${{ env.PREPROD_SERVER_NAME }}" \
                --type cx23 \
                --location fsn1 \
                --image "$SNAPSHOT_ID" \
                --ssh-key deploy \
                --label project=vpai-preprod \
                -o json)
            else
              echo "Creating from scratch"
              SERVER_JSON=$(hcloud server create \
                --name "${{ env.PREPROD_SERVER_NAME }}" \
                --type cx23 \
                --location fsn1 \
                --image debian-13 \
                --ssh-key deploy \
                --label project=vpai-preprod \
                -o json)
            fi

            IP=$(echo "$SERVER_JSON" | jq -r '.server.public_net.ipv4.ip')
            ID=$(echo "$SERVER_JSON" | jq -r '.server.id')
            echo "ip=$IP" >> "$GITHUB_OUTPUT"
            echo "id=$ID" >> "$GITHUB_OUTPUT"
            echo "was_created=true" >> "$GITHUB_OUTPUT"
            echo "Server created: $IP (ID: $ID)"
          fi

      - name: Wait for SSH
        run: |
          for i in $(seq 1 30); do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
              root@${{ steps.resolve.outputs.ip }} echo "SSH ready"; then
              exit 0
            fi
            sleep 10
          done
          echo "SSH timeout" && exit 1

  deploy:
    name: Deploy via Ansible
    needs: provision
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install ansible jmespath
          ansible-galaxy install -r requirements.yml

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ needs.provision.outputs.server_ip }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create vault password file
        run: |
          printf '%s' "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_password
          chmod 600 .vault_password

      - name: Deploy
        run: |
          ansible-playbook playbooks/site.yml \
            -i "${{ needs.provision.outputs.server_ip }}," \
            -e "target_env=preprod" \
            -e "ansible_user=root" \
            --diff

  smoke-tests:
    name: Smoke Tests
    needs: [provision, deploy]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Wait for services to stabilize
        run: sleep 30

      - name: Run smoke tests
        run: |
          bash scripts/smoke-test.sh \
            "https://${{ needs.provision.outputs.server_ip }}"
        env:
          LITELLM_KEY: ${{ secrets.LITELLM_MASTER_KEY }}

  snapshot:
    name: Create Golden Snapshot
    needs: [provision, smoke-tests]
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Create snapshot
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_CLOUD_TOKEN }}
        run: |
          hcloud server create-image \
            --type snapshot \
            --description "Golden $(date +%Y%m%d-%H%M)" \
            --label project=vpai \
            ${{ needs.provision.outputs.server_id }}

  cleanup:
    name: Cleanup
    needs: [provision, smoke-tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      # Determine effective mode:
      # - workflow_dispatch: use the selected mode input
      # - push event: default to 'fast' (keep server alive)
      - name: Determine deployment mode
        id: mode
        run: |
          MODE="${{ github.event.inputs.mode }}"
          if [ -z "$MODE" ]; then
            MODE="fast"
          fi
          echo "value=$MODE" >> "$GITHUB_OUTPUT"
          echo "Deployment mode: $MODE"

      - name: Destroy server (normal mode only)
        if: steps.mode.outputs.value == 'normal'
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_CLOUD_TOKEN }}
        run: |
          echo "Normal mode — destroying preprod server"
          hcloud server delete ${{ needs.provision.outputs.server_id }} || true

      - name: Keep server alive (fast mode)
        if: steps.mode.outputs.value == 'fast'
        run: |
          echo "Fast mode — server ${{ needs.provision.outputs.server_ip }} kept alive for next run"
          echo "To switch to normal mode: run workflow_dispatch with mode=normal"
