{% raw %}{
  "name": "OpenClaw ‚Äî Plan Dispatch",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "plan-dispatch",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000001",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [260, 300]
    },
    {
      "parameters": {
        "jsCode": "const payload = $input.first().json;\n\nconst required = ['task_id'];\nfor (const field of required) {\n  if (!payload[field]) throw new Error(`Missing required field: ${field}`);\n}\n\nreturn [{ json: {\n  task_id: payload.task_id,\n  org_id: payload.org_id || ''\n}}];"
      },
      "id": "pd-0001-0000-0000-0000-000000000002",
      "name": "Validate payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [480, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"status\": \"accepted\", \"task_id\": \"{{ $json.task_id }}\" }"
      },
      "id": "pd-0001-0000-0000-0000-000000000003",
      "name": "Webhook Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [700, 460]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://kaneo-api:1337/api/auth/sign-in/email",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"email\": \"{{ $env.KANEO_AGENT_EMAIL }}\", \"password\": \"{{ $env.KANEO_AGENT_PASSWORD }}\" }",
        "options": {
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "pd-0001-0000-0000-0000-000000000005",
      "name": "Auth Kaneo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst headers = response.headers || {};\nconst setCookie = headers['set-cookie'] || [];\nlet cookie = '';\nif (Array.isArray(setCookie)) {\n  cookie = setCookie.map(c => c.split(';')[0]).join('; ');\n} else if (typeof setCookie === 'string') {\n  cookie = setCookie.split(';')[0];\n}\nif (!cookie) throw new Error('Kaneo auth failed ‚Äî check KANEO_AGENT_EMAIL/PASSWORD');\nconst ctx = $('Validate payload').first().json;\nreturn [{ json: { ...ctx, cookie } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000006",
      "name": "Extract cookie",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [920, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://kaneo-api:1337/api/task/{{ $json.task_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" }
          ]
        },
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000007",
      "name": "Get idea task",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1140, 300],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Parse plan from idea task description\n// Extract last IDEA-PLAN-VN-START block\nconst response = $input.first().json;\nconst ctx = $('Extract cookie').first().json;\n\nconst taskData = response.task || response.data || response;\nconst description = taskData.description || taskData.desc || '';\nconst taskTitle = taskData.title || 'Untitled Idea';\n\nif (!description) {\n  throw new Error(`No description found for task ${ctx.task_id}`);\n}\n\n// Extract last plan version using regex\nconst planMatches = [...description.matchAll(/---IDEA-PLAN-V(\\d+)-START---([\\s\\S]*?)---IDEA-PLAN-V\\d+-END---/g)];\nif (!planMatches.length) {\n  throw new Error(`No plan found in task ${ctx.task_id} description`);\n}\nconst lastPlan = planMatches[planMatches.length - 1];\nconst planVersion = parseInt(lastPlan[1]);\nconst planRaw = lastPlan[2].trim();\n\nlet plan;\ntry {\n  plan = JSON.parse(planRaw);\n} catch (e) {\n  throw new Error(`Invalid plan JSON in task ${ctx.task_id}: ${e.message}`);\n}\n\n// Check idempotence via task labels\nconst labels = taskData.labels || [];\nconst alreadyDispatched = labels.some(l => l.name === 'idea:dispatched');\nif (alreadyDispatched) {\n  return [{ json: { skip: true, reason: 'already_dispatched', task_id: ctx.task_id } }];\n}\n\nreturn [{ json: {\n  ...ctx,\n  plan,\n  plan_version: planVersion,\n  task_title: taskTitle,\n  task_description: description,\n  skip: false\n} }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000008",
      "name": "Parse plan",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1360, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "leftValue": "", "typeValidation": "strict" },
          "conditions": [
            {
              "id": "cond-skip",
              "leftValue": "={{ $json.skip }}",
              "rightValue": true,
              "operator": { "type": "boolean", "operation": "equals" }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000009",
      "name": "Already dispatched?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1580, 300]
    },
    {
      "parameters": {
        "jsCode": "// Decompose implementation_steps into Kaneo tasks using LiteLLM\n// Use deepseek-v3 (cheap model) for intelligent decomposition\nconst http = require('http');\nconst ctx = $input.first().json;\nconst { plan } = ctx;\n\nconst steps = (plan.implementation_steps || []).join('\\n');\nconst raci = plan.raci || {};\nconst responsible = Array.isArray(raci.responsible) ? raci.responsible : [raci.responsible || 'user'];\nconst domain = plan.domain || 'autre';\n\n// Determine agents from RACI\nconst agentMap = {\n  builder: 'builder',\n  cfo: 'cfo',\n  explorer: 'explorer',\n  writer: 'writer',\n  artist: 'artist',\n  tutor: 'tutor',\n  maintainer: 'maintainer',\n  messenger: 'messenger'\n};\nconst responsibleAgents = responsible.map(r => {\n  for (const [k,v] of Object.entries(agentMap)) {\n    if (r.toLowerCase().includes(k)) return v;\n  }\n  return 'user';\n});\n\n// Call LiteLLM to decompose steps intelligently\nconst prompt = `Tu es un gestionnaire de projet. Decompose ces √©tapes en t√¢ches Kaneo pr√©cises et assignables.\\n\\nProjet: ${plan.title}\\nDomaine: ${domain}\\nEtapes: ${steps}\\n\\nAgents RACI responsables: ${responsibleAgents.join(', ')}\\n\\nR√©ponds UNIQUEMENT avec un JSON valide:\\n[{\"title\": \"Titre court <10 mots\", \"description\": \"Description 1-2 phrases\", \"agentId\": \"<agentId ou 'user'>\"}]\\n\\nMax 8 t√¢ches. Si domaine non-tech: agentId = 'user' par d√©faut.`;\n\nfunction callLiteLLM(prompt) {\n  return new Promise((resolve, reject) => {\n    const body = JSON.stringify({\n      model: 'custom-litellm/deepseek-v3',\n      messages: [{ role: 'user', content: prompt }],\n      max_tokens: 1000,\n      temperature: 0.1\n    });\n    const opts = {\n      hostname: 'litellm',\n      port: 4000,\n      path: '/v1/chat/completions',\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${process.env.LITELLM_API_KEY}`,\n        'Content-Length': Buffer.byteLength(body)\n      }\n    };\n    const req = http.request(opts, (res) => {\n      let data = '';\n      res.on('data', c => data += c);\n      res.on('end', () => resolve({ status: res.statusCode, body: data }));\n    });\n    req.on('error', reject);\n    req.write(body);\n    req.end();\n  });\n}\n\nlet tasks;\ntry {\n  const resp = await callLiteLLM(prompt);\n  const result = JSON.parse(resp.body);\n  const content = result.choices?.[0]?.message?.content || '[]';\n  // Extract JSON from potential markdown code blocks\n  const jsonMatch = content.match(/\\[([\\s\\S]*?)\\]/);\n  tasks = jsonMatch ? JSON.parse('[' + jsonMatch[1] + ']') : JSON.parse(content);\n} catch (e) {\n  // Fallback: convert steps directly without LLM\n  tasks = (plan.implementation_steps || []).slice(0, 8).map((step, i) => ({\n    title: step.slice(0, 80),\n    description: step,\n    agentId: responsibleAgents[0] || 'user'\n  }));\n}\n\nreturn [{ json: { ...ctx, decomposed_tasks: tasks, responsible_agents: responsibleAgents } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000010",
      "name": "Decompose plan (LLM)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://kaneo-api:1337/api/project",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" }
          ]
        },
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000011",
      "name": "Get all projects",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2020, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Create new project for the approved plan\nconst ctx = $('Decompose plan (LLM)').first().json;\nconst projects = $input.first().json;\n\nconst projectsArr = Array.isArray(projects) ? projects\n  : (projects.projects || projects.data || []);\n\n// Check if project already exists (idempotence)\nconst existing = projectsArr.find(p =>\n  p.name && p.name.toLowerCase() === (ctx.plan.title || '').toLowerCase()\n);\n\nreturn [{ json: { ...ctx, existing_project: existing || null } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000012",
      "name": "Check project exists",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2240, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://kaneo-api:1337/api/project",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"name\": \"{{ $json.plan.title }}\",\n  \"description\": \"{{ $json.plan.summary }}\",\n  \"icon\": \"{{ $json.plan.domain === 'tech' ? '‚öôÔ∏è' : $json.plan.domain === 'business' ? 'üíº' : $json.plan.domain === 'finance' ? 'üí∞' : $json.plan.domain === 'physique' ? 'üèóÔ∏è' : 'üí°' }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "pd-0001-0000-0000-0000-000000000013",
      "name": "Create project",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2460, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Get project id (new or existing)\nconst ctx = $('Check project exists').first().json;\nconst newProject = $input.first().json;\n\nlet projectId = ctx.existing_project?.id;\nif (!projectId) {\n  projectId = newProject.id || newProject.data?.id;\n}\nif (!projectId) {\n  throw new Error('Failed to create or find project for plan: ' + ctx.plan.title);\n}\n\nreturn [{ json: { ...ctx, project_id: projectId, project_is_new: !ctx.existing_project } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000014",
      "name": "Set project id",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2680, 200]
    },
    {
      "parameters": {
        "jsCode": "// Create columns only for new projects\nconst ctx = $input.first().json;\nif (!ctx.project_is_new) {\n  return [{ json: ctx }];\n}\n\nconst http = require('http');\nconst columns = ['Backlog', 'In Progress', 'Review', 'Done'];\nconst created = [];\n\nfor (const col of columns) {\n  const body = JSON.stringify({ name: col });\n  await new Promise((resolve) => {\n    const opts = {\n      hostname: 'kaneo-api',\n      port: 1337,\n      path: `/api/column/${ctx.project_id}`,\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Cookie': ctx.cookie,\n        'Content-Length': Buffer.byteLength(body)\n      }\n    };\n    const req = http.request(opts, (res) => {\n      let d = '';\n      res.on('data', c => d += c);\n      res.on('end', () => { created.push({ col, status: res.statusCode }); resolve(); });\n    });\n    req.on('error', () => { created.push({ col, status: 'error' }); resolve(); });\n    req.write(body);\n    req.end();\n  });\n}\n\nreturn [{ json: { ...ctx, columns_created: created } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000015",
      "name": "Create columns",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2900, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=http://kaneo-api:1337/api/column/{{ $json.project_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" }
          ]
        },
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000016",
      "name": "Get columns",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3120, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Get backlog column id\nconst cols = $input.first().json;\nconst ctx = $('Create columns').first().json;\n\nconst colsArr = Array.isArray(cols) ? cols\n  : (cols.columns || cols.data || []);\nconst backlogCol = colsArr.find(c => c.name === 'Backlog');\nconst backlogColId = backlogCol?.id || colsArr[0]?.id;\n\nif (!backlogColId) {\n  throw new Error(`No Backlog column found for project ${ctx.project_id}`);\n}\n\nreturn [{ json: { ...ctx, backlog_col_id: backlogColId } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000017",
      "name": "Set backlog col",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3340, 200]
    },
    {
      "parameters": {
        "jsCode": "// Load userId map from REGISTRY task (cached in Redis via kaneo-agents-sync)\n// Format: {\"concierge\":\"uid-xxx\",\"builder\":\"uid-yyy\",...}\nconst ctx = $input.first().json;\nconst http = require('http');\n\nfunction httpGet(path, cookie) {\n  return new Promise((resolve) => {\n    const opts = { hostname: 'kaneo-api', port: 1337, path, method: 'GET',\n      headers: { 'Cookie': cookie } };\n    const req = http.request(opts, (res) => {\n      let d = '';\n      res.on('data', c => d += c);\n      res.on('end', () => {\n        try { resolve({ status: res.statusCode, body: JSON.parse(d) }); }\n        catch { resolve({ status: res.statusCode, body: {} }); }\n      });\n    });\n    req.on('error', () => resolve({ status: 0, body: {} }));\n    req.end();\n  });\n}\n\nconst allProjects = await httpGet('/api/project', ctx.cookie);\nconst projectsArr = Array.isArray(allProjects.body) ? allProjects.body\n  : (allProjects.body.projects || allProjects.body.data || []);\nconst agentsProject = projectsArr.find(p =>\n  (p.name || '').toLowerCase().includes('openclaw agents') ||\n  (p.name || '').toLowerCase().includes('openclaw agent')\n);\n\nlet userIdMap = {};\nif (agentsProject) {\n  const tasks = await httpGet(`/api/task/tasks/${agentsProject.id}`, ctx.cookie);\n  const tasksArr = Array.isArray(tasks.body) ? tasks.body\n    : (tasks.body.tasks || tasks.body.data || []);\n  const registryTask = tasksArr.find(t =>\n    (t.description || '').startsWith('[registry]')\n  );\n  if (registryTask) {\n    try {\n      const jsonPart = registryTask.description.replace(/^\\[registry\\]\\s*/, '');\n      userIdMap = JSON.parse(jsonPart);\n    } catch {}\n  }\n}\n\nreturn [{ json: { ...ctx, user_id_map: userIdMap } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000018",
      "name": "Load userId map",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3560, 200]
    },
    {
      "parameters": {
        "jsCode": "// Prepare tasks for SplitInBatches\nconst ctx = $input.first().json;\nconst tasks = ctx.decomposed_tasks || [];\n\nconst prepared = tasks.map((task, i) => ({\n  ...ctx,\n  current_task: task,\n  task_index: i,\n  total_tasks: tasks.length\n}));\n\nreturn prepared.map(t => ({ json: t }));"
      },
      "id": "pd-0001-0000-0000-0000-000000000019",
      "name": "Prepare task items",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3780, 200]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000020",
      "name": "For each task",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [4000, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://kaneo-api:1337/api/task/{{ $json.project_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"title\": \"{{ $json.current_task.title }}\",\n  \"description\": \"{{ $json.current_task.description }}\",\n  \"columnId\": \"{{ $json.backlog_col_id }}\"\n}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "id": "pd-0001-0000-0000-0000-000000000021",
      "name": "Create task",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4220, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Assign task to agent userId\nconst taskResp = $input.first().json;\nconst ctx = $('For each task').first().json;\n\nconst newTaskId = taskResp.id || taskResp.data?.id;\nif (!newTaskId) {\n  return [{ json: { ...ctx, created_task_id: null, assignment_skipped: true } }];\n}\n\nconst agentId = ctx.current_task.agentId || 'user';\nconst userId = ctx.user_id_map[agentId] || '';\n\nreturn [{ json: { ...ctx, created_task_id: newTaskId, agent_id: agentId, user_id: userId } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000022",
      "name": "Prepare assignment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4440, 200]
    },
    {
      "parameters": {
        "method": "PUT",
        "url": "=http://kaneo-api:1337/api/task/assignee/{{ $json.created_task_id }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"userId\": \"{{ $json.user_id }}\" }",
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000023",
      "name": "Assign to agent",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4660, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://kaneo-api:1337/api/label",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"taskId\": \"{{ $('Prepare assignment').first().json.created_task_id }}\", \"name\": \"agent:{{ $('Prepare assignment').first().json.agent_id }}\", \"color\": \"#6366f1\" }",
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000024",
      "name": "Add agent label",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4880, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// After all tasks: pass context forward for final steps\nconst ctx = $input.first().json;\nreturn [{ json: ctx }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000025",
      "name": "After all tasks",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5100, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "http://kaneo-api:1337/api/project",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Cookie", "value": "={{ $json.cookie }}" }
          ]
        },
        "options": {}
      },
      "id": "pd-0001-0000-0000-0000-000000000026",
      "name": "Get projects (find ideas)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5320, 200],
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Find Implemented column in Boite a Idees project and move original task there\nconst ctx = $('After all tasks').first().json;\nconst projects = $input.first().json;\nconst http = require('http');\n\nfunction httpReq(method, path, body, cookie) {\n  return new Promise((resolve) => {\n    const bodyStr = body ? JSON.stringify(body) : null;\n    const opts = {\n      hostname: 'kaneo-api', port: 1337, path, method,\n      headers: {\n        'Content-Type': 'application/json',\n        'Cookie': cookie,\n        ...(bodyStr ? { 'Content-Length': Buffer.byteLength(bodyStr) } : {})\n      }\n    };\n    const req = http.request(opts, (res) => {\n      let d = '';\n      res.on('data', c => d += c);\n      res.on('end', () => {\n        try { resolve({ status: res.statusCode, body: JSON.parse(d) }); }\n        catch { resolve({ status: res.statusCode, body: {} }); }\n      });\n    });\n    req.on('error', () => resolve({ status: 0, body: {} }));\n    if (bodyStr) req.write(bodyStr);\n    req.end();\n  });\n}\n\nconst projectsArr = Array.isArray(projects) ? projects\n  : (projects.projects || projects.data || []);\n\nconst ideasProject = projectsArr.find(p =>\n  p.name === 'Bo√Æte √† Id√©es' || p.name === 'Boite a Idees'\n);\n\nlet moved = false;\nlet labelAdded = false;\n\nif (ideasProject) {\n  const colsResp = await httpReq('GET', `/api/column/${ideasProject.id}`, null, ctx.cookie);\n  const colsArr = Array.isArray(colsResp.body) ? colsResp.body\n    : (colsResp.body.columns || colsResp.body.data || []);\n  const implCol = colsArr.find(c => c.name === 'Implemented');\n  if (implCol) {\n    await httpReq('PUT', `/api/task/column/${ctx.task_id}`, { columnId: implCol.id }, ctx.cookie);\n    moved = true;\n  }\n}\n\n// Add idea:dispatched label to original task (idempotence marker)\nawait httpReq('POST', '/api/label', {\n  taskId: ctx.task_id,\n  name: 'idea:dispatched',\n  color: '#0ea5e9'\n}, ctx.cookie);\nlabelAdded = true;\n\nreturn [{ json: { ...ctx, original_task_moved: moved, dispatched_label_added: labelAdded } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000027",
      "name": "Mark Implemented",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5540, 200]
    },
    {
      "parameters": {
        "jsCode": "// Build final Telegram notification\n// Uses $env.KANEO_PUBLIC_URL instead of hardcoded domain (set in n8n.env)\nconst ctx = $input.first().json;\nconst plan = ctx.plan || {};\nconst tasks = ctx.decomposed_tasks || [];\n\nconst domain = plan.domain || 'autre';\nconst domainEmoji = {\n  tech: '‚öôÔ∏è', business: 'üíº', finance: 'üí∞', physique: 'üèóÔ∏è', perso: 'üè†', autre: 'üí°'\n}[domain] || 'üí°';\n\nconst timeline = plan.resources?.timeline || '?';\nconst budget = plan.resources?.budget_estimated || '?';\nconst kaneoUrl = process.env.KANEO_PUBLIC_URL || 'https://hq.example.com';\n\nconst message = [\n  `‚úÖ Projet cr√©√© : <b>${plan.title}</b> ${domainEmoji}`,\n  ``,\n  `üìã ${plan.summary || ''}`,\n  ``,\n  `üìä <b>${tasks.length} t√¢ches</b> cr√©√©es dans Kaneo`,\n  `‚è±Ô∏è Timeline estim√©e : ${timeline}`,\n  `üí∞ Budget estim√© : ${budget}`,\n  ``,\n  `üéØ KPI : ${(plan.kpi_victoire || [])[0] || '?'}`,\n  ``,\n  `üîó Projet : <a href=\"${kaneoUrl}/\">Kaneo</a>`\n].join('\\n');\n\nreturn [{ json: { message, tasks_count: tasks.length, plan_title: plan.title } }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000028",
      "name": "Build notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [5760, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.telegram.org/bot{{ $env.TELEGRAM_MONITORING_BOT_TOKEN }}/sendMessage",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            { "name": "chat_id", "value": "={{ $env.TELEGRAM_MONITORING_CHAT_ID }}" },
            { "name": "text", "value": "={{ $json.message }}" },
            { "name": "parse_mode", "value": "HTML" }
          ]
        },
        "options": {},
        "continueOnFail": true
      },
      "id": "pd-0001-0000-0000-0000-000000000029",
      "name": "Telegram notify success",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [5980, 200]
    },
    {
      "parameters": {
        "jsCode": "// Handle already dispatched case ‚Äî send skip notification\nconst ctx = $input.first().json;\nreturn [{ json: {\n  message: `‚ÑπÔ∏è Plan d√©j√† dispatch√© pour task ${ctx.task_id} ‚Äî ignor√© (idempotent)`,\n  skipped: true\n} }];"
      },
      "id": "pd-0001-0000-0000-0000-000000000030",
      "name": "Skip notification",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1800, 400]
    }
  ],
  "connections": {
    "Webhook Trigger": {
      "main": [[{ "node": "Validate payload", "type": "main", "index": 0 }]]
    },
    "Validate payload": {
      "main": [[
        { "node": "Webhook Response", "type": "main", "index": 0 },
        { "node": "Auth Kaneo", "type": "main", "index": 0 }
      ]]
    },
    "Auth Kaneo": {
      "main": [[{ "node": "Extract cookie", "type": "main", "index": 0 }]]
    },
    "Extract cookie": {
      "main": [[{ "node": "Get idea task", "type": "main", "index": 0 }]]
    },
    "Get idea task": {
      "main": [[{ "node": "Parse plan", "type": "main", "index": 0 }]]
    },
    "Parse plan": {
      "main": [[{ "node": "Already dispatched?", "type": "main", "index": 0 }]]
    },
    "Already dispatched?": {
      "main": [
        [{ "node": "Skip notification", "type": "main", "index": 0 }],
        [{ "node": "Decompose plan (LLM)", "type": "main", "index": 0 }]
      ]
    },
    "Decompose plan (LLM)": {
      "main": [[{ "node": "Get all projects", "type": "main", "index": 0 }]]
    },
    "Get all projects": {
      "main": [[{ "node": "Check project exists", "type": "main", "index": 0 }]]
    },
    "Check project exists": {
      "main": [[{ "node": "Create project", "type": "main", "index": 0 }]]
    },
    "Create project": {
      "main": [[{ "node": "Set project id", "type": "main", "index": 0 }]]
    },
    "Set project id": {
      "main": [[{ "node": "Create columns", "type": "main", "index": 0 }]]
    },
    "Create columns": {
      "main": [[{ "node": "Get columns", "type": "main", "index": 0 }]]
    },
    "Get columns": {
      "main": [[{ "node": "Set backlog col", "type": "main", "index": 0 }]]
    },
    "Set backlog col": {
      "main": [[{ "node": "Load userId map", "type": "main", "index": 0 }]]
    },
    "Load userId map": {
      "main": [[{ "node": "Prepare task items", "type": "main", "index": 0 }]]
    },
    "Prepare task items": {
      "main": [[{ "node": "For each task", "type": "main", "index": 0 }]]
    },
    "For each task": {
      "main": [
        [{ "node": "After all tasks", "type": "main", "index": 0 }],
        [{ "node": "Create task", "type": "main", "index": 0 }]
      ]
    },
    "Create task": {
      "main": [[{ "node": "Prepare assignment", "type": "main", "index": 0 }]]
    },
    "Prepare assignment": {
      "main": [[{ "node": "Assign to agent", "type": "main", "index": 0 }]]
    },
    "Assign to agent": {
      "main": [[{ "node": "Add agent label", "type": "main", "index": 0 }]]
    },
    "Add agent label": {
      "main": [[{ "node": "For each task", "type": "main", "index": 0 }]]
    },
    "After all tasks": {
      "main": [[{ "node": "Get projects (find ideas)", "type": "main", "index": 0 }]]
    },
    "Get projects (find ideas)": {
      "main": [[{ "node": "Mark Implemented", "type": "main", "index": 0 }]]
    },
    "Mark Implemented": {
      "main": [[{ "node": "Build notification", "type": "main", "index": 0 }]]
    },
    "Build notification": {
      "main": [[{ "node": "Telegram notify success", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": false,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": ""
  },
  "staticData": null,
  "tags": ["openclaw", "kaneo", "idea-planning"],
  "triggerCount": 0,
  "updatedAt": "2026-02-23T00:00:00.000Z",
  "versionId": "pd-0001-0000-0000-0000-000000000001"
}{% endraw %}
