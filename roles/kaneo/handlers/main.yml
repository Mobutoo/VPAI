---
# kaneo — handlers
# Pattern: grep-guard before restart — checks that kaneo-api service is declared
# in docker-compose.yml (i.e. docker-stack Phase B has been deployed).

- name: Check kaneo service is in compose file
  ansible.builtin.command:
    cmd: grep -q "kaneo-api" /opt/{{ project_name }}/docker-compose.yml
  register: _kaneo_in_compose
  failed_when: false
  changed_when: false
  listen: Restart kaneo stack

- name: Restart kaneo containers
  community.docker.docker_compose_v2:
    project_src: "/opt/{{ project_name }}"
    files:
      - docker-compose.yml
    services:
      - kaneo-api
      - kaneo-web
    state: restarted
  become: true
  when:
    - not ansible_check_mode
    - _kaneo_in_compose.rc | default(1) == 0
  listen: Restart kaneo stack
