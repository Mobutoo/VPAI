---
# caddy â€” tasks

- name: Create Caddy config directory
  ansible.builtin.file:
    path: "{{ caddy_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Create Caddy data directories
  ansible.builtin.file:
    path: "{{ caddy_data_dir }}/{{ item }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  loop:
    - data
    - config
  become: true

- name: Create Caddy logs directory for Fail2Ban
  ansible.builtin.file:
    path: "/opt/{{ project_name }}/logs/caddy"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Deploy Caddyfile
  ansible.builtin.template:
    src: Caddyfile.j2
    dest: "{{ caddy_config_dir }}/Caddyfile"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0644"
  become: true
  notify: Restart caddy stack
