---
# vpn-dns — defaults
# Headscale extra_records for Split DNS (admin domains -> VPS Tailscale IP)
#
# REX #33 (GOLDEN-PROMPT) : Sans Split DNS, le navigateur résout vers l'IP publique
# du VPS → le trafic passe par Internet → Caddy voit l'IP publique du client
# → blocage même si VPN actif. Le Split DNS force la résolution vers l'IP Tailscale
# du VPS → le trafic passe par le tunnel WireGuard → Caddy voit l'IP VPN → OK.
#
# TOUS les domaines doivent être listés, pas seulement les admin UIs :
# le domaine principal (ewutelo.cloud) sert /health et les webhooks.
#
# ARCHITECTURE Seko-VPN : Headscale tourne dans Docker.
#   Config sur l'hôte : /opt/services/headscale/config/config.yaml
#   Montée dans le container : /etc/headscale/config.yaml
#   Le restart se fait via docker compose (pas systemd).

# Chemin du config.yaml Headscale SUR L'HÔTE (pas dans le container)
vpn_dns_headscale_config_path: "/opt/services/headscale/config/config.yaml"

# Chemin docker-compose Headscale (pour restart)
vpn_dns_headscale_compose_path: "/opt/services/headscale"

# Admin domains to register (built from inventory variables)
# Each entry maps a domain to the Tailscale IP of the target VPS
vpn_dns_records: "{{ _vpn_dns_records_default }}"

# Internal: build default records list from standard variables
# Uses the tailscale_ip fact set by headscale-node role on prod-server
# I3 fix : garde defensif — evite un crash Jinja2 opaque si prod vide ou tailscale_ip absent
_vpn_dns_vps_ts_ip: >-
  {{
    hostvars[groups['prod'][0]]['tailscale_ip']
    if (groups['prod'] | default([]) | length > 0
        and 'tailscale_ip' in hostvars[groups['prod'][0]])
    else ''
  }}

# Tailscale IP du Pi (connue apres enregistrement Tailscale — vide sinon)
# Les records workstation sont ajoutes seulement si l'IP est disponible
_vpn_dns_workstation_ts_ip: >-
  {{
    hostvars[groups['workstation'][0]]['tailscale_ip']
    if (groups['workstation'] | default([]) | length > 0
        and 'tailscale_ip' in hostvars[groups['workstation'][0]])
    else ''
  }}

_vpn_dns_records_default: >-
  {{
    [
      {"name": domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}
    ]
    +
    ([{"name": admin_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (admin_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": grafana_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (grafana_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": n8n_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (n8n_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": litellm_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (litellm_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": qdrant_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (qdrant_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": kaneo_subdomain_override ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (kaneo_subdomain_override | default('')) | length > 0
     else [])
    +
    ([{"name": sure_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (sure_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": palais_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_vps_ts_ip}]
     if (palais_subdomain | default('')) | length > 0
     else [])
    +
    ([{"name": oc_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_workstation_ts_ip}]
     if (oc_subdomain | default('')) | length > 0
        and _vpn_dns_workstation_ts_ip | length > 0
     else [])
    +
    ([{"name": comfyui_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_workstation_ts_ip}]
     if (comfyui_subdomain | default('')) | length > 0
        and _vpn_dns_workstation_ts_ip | length > 0
     else [])
    +
    ([{"name": remotion_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_workstation_ts_ip}]
     if (remotion_subdomain | default('')) | length > 0
        and _vpn_dns_workstation_ts_ip | length > 0
     else [])
    +
    ([{"name": opencut_subdomain ~ "." ~ domain_name, "type": "A",
       "value": _vpn_dns_workstation_ts_ip}]
     if (opencut_subdomain | default('')) | length > 0
        and _vpn_dns_workstation_ts_ip | length > 0
     else [])
  }}
