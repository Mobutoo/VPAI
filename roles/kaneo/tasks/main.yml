---
# kaneo — tasks
# Kaneo PM tool (API + Web frontend in Docker)

- name: Create Kaneo config directory
  ansible.builtin.file:
    path: "{{ kaneo_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Create Kaneo data directory
  ansible.builtin.file:
    path: "{{ kaneo_data_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true

- name: Deploy Kaneo environment file
  ansible.builtin.template:
    src: kaneo.env.j2
    dest: "{{ kaneo_config_dir }}/kaneo.env"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0600"
  become: true
  notify: Restart kaneo stack

# Provision Kaneo agent service account (used by n8n workflows + OpenClaw Messenger)
# This account is used for internal API calls only — not for human access.
# Only runs once if kaneo_agent_email is defined and container is running.
# ⚠️  WARNING: Changing kaneo_agent_password in vault AFTER first provisioning will NOT update
# the account password — BetterAuth sign-in still returns HTTP 200 with old password, so the
# provisioning task detects the account as existing and skips. To update the password, use the
# Kaneo admin UI (https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}) or
# re-provision manually: docker exec <kaneo-api> sh -c 'curl -X POST .../api/auth/update-user ...'
- name: Check if Kaneo container is running
  ansible.builtin.command:
    cmd: "docker ps -q -f name={{ project_name }}_kaneo_api"
  register: kaneo_container_check
  changed_when: false
  failed_when: false
  become: true
  when: kaneo_agent_email | default('') | length > 0

- name: Check if Kaneo agent user already exists
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      docker exec {{ project_name }}_kaneo_api sh -c '
        curl -sf -o /dev/null -w "%{http_code}" \
          -X POST http://localhost:1337/api/auth/sign-in \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"{{ kaneo_agent_email }}\",\"password\":\"{{ kaneo_agent_password }}\"}" 2>/dev/null
      '
  register: kaneo_agent_check
  changed_when: false
  failed_when: false
  no_log: true
  become: true
  when:
    - kaneo_agent_email | default('') | length > 0
    - kaneo_container_check.stdout | default('') | length > 0

- name: Provision Kaneo agent service account
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      docker exec {{ project_name }}_kaneo_api sh -c '
        curl -sf -o /dev/null -w "%{http_code}" \
          -X POST http://localhost:1337/api/auth/sign-up \
          -H "Content-Type: application/json" \
          -d "{\"email\":\"{{ kaneo_agent_email }}\",\"password\":\"{{ kaneo_agent_password }}\",\"name\":\"Agent Service\"}" 2>/dev/null
      '
  register: kaneo_agent_provision
  changed_when: kaneo_agent_provision.stdout | default('') in ['200', '201']
  failed_when: false
  no_log: true
  become: true
  when:
    - kaneo_agent_email | default('') | length > 0
    - kaneo_container_check.stdout | default('') | length > 0
    - kaneo_agent_check.stdout | default('') != '200'

- name: Display Kaneo agent provisioning result
  ansible.builtin.debug:
    msg: >-
      {% if not (kaneo_agent_email | default('') | length > 0) %}
      ℹ️  kaneo_agent_email not configured — skipping agent user provisioning.
      Add kaneo_agent_email + kaneo_agent_password to secrets.yml.
      {% elif kaneo_agent_check.stdout | default('') == '200' %}
      ℹ️  Kaneo agent user already exists. Skipping.
      {% elif kaneo_agent_provision.stdout | default('') in ['200', '201'] %}
      ✅ Kaneo agent service account created successfully.
      {% else %}
      ⚠️  Kaneo agent provisioning returned: {{ kaneo_agent_provision.stdout | default('unknown') }}.
      Manual creation may be needed.
      {% endif %}
  when: kaneo_agent_email | default('') | length > 0 or kaneo_container_check is defined

# =============================================================================
# OpenClaw Agents — Kaneo workspace membership (native userId assignment)
# =============================================================================
# Provisions 10 BetterAuth accounts (one per OpenClaw agent) and adds them
# as Kaneo workspace members so tasks can be natively assigned via userId.
#
# Pattern: email = agent-<id>@<domain_name>, name = persona (Imhotep, Thot...)
# Rôles: member (all), admin (maintainer only)
#
# ⚠️  Changing vault_kaneo_agents_password AFTER first provisioning will NOT update
#     passwords — BetterAuth sign-in returns 200 with old password → task skips.
#     Reset via Kaneo Admin UI or: --extra-vars kaneo_force_password_reset=true
#     (dedicated task to be added in V2)
# =============================================================================

- name: Check Kaneo API is reachable (agents provisioning)
  ansible.builtin.uri:
    url: "https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}/api/health"
    method: GET
    status_code: [200, -1]
    return_content: false
  register: kaneo_health_check
  delegate_to: localhost
  retries: 3
  delay: 5
  until: kaneo_health_check.status | default(0) == 200
  failed_when: false
  when: kaneo_openclaw_agents | default([]) | length > 0

- name: Sign in as Kaneo service account to get organizationId
  ansible.builtin.uri:
    url: "https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}/api/auth/sign-in/email"
    method: POST
    body_format: json
    body:
      email: "{{ kaneo_agent_email }}"
      password: "{{ kaneo_agent_password }}"
    status_code: [200, 401, -1]
    return_content: true
  register: kaneo_svc_signin
  delegate_to: localhost
  no_log: true
  failed_when: false
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - kaneo_health_check.status | default(0) == 200

- name: Fetch Kaneo organizationId for workspace membership
  ansible.builtin.uri:
    url: "https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}/api/auth/organization/list"
    method: GET
    headers:
      Cookie: "{{ kaneo_svc_signin.set_cookie | default('') }}"
    status_code: [200, -1]
    return_content: true
  register: kaneo_org_list
  delegate_to: localhost
  no_log: true
  failed_when: false
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - kaneo_svc_signin.status | default(0) == 200

- name: Set kaneo_org_id fact
  ansible.builtin.set_fact:
    kaneo_org_id_val: "{{ (kaneo_org_list.json | default([]))[0].id | default('') }}"
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - kaneo_org_list.json is defined

- name: Probe sign-in for each agent (check account exists)
  ansible.builtin.uri:
    url: "https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}/api/auth/sign-in/email"
    method: POST
    body_format: json
    body:
      email: "{{ kaneo_agent_email_prefix }}{{ item.id }}@{{ domain_name }}"
      password: "{{ kaneo_agents_password }}"
    status_code: [200, 401, 403, -1]
    return_content: false
  register: kaneo_agent_probe
  delegate_to: localhost
  no_log: true
  failed_when: false
  loop: "{{ kaneo_openclaw_agents }}"
  loop_control:
    label: "{{ item.id }}"
    pause: 3
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - kaneo_health_check.status | default(0) == 200
    - kaneo_agents_password | default('') | length > 0

- name: Create missing Kaneo agent accounts (name set to persona)
  ansible.builtin.uri:
    url: "https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}/api/auth/sign-up/email"
    method: POST
    body_format: json
    body:
      email: "{{ kaneo_agent_email_prefix }}{{ item.item.id }}@{{ domain_name }}"
      password: "{{ kaneo_agents_password }}"
      name: "{{ item.item.name }}"
    status_code: [200, 201, 409, -1]
    return_content: false
  register: kaneo_agent_create
  delegate_to: localhost
  no_log: true
  failed_when: false
  changed_when: kaneo_agent_create.status | default(0) in [200, 201]
  loop: "{{ kaneo_agent_probe.results | default([]) }}"
  loop_control:
    label: "{{ item.item.id }}"
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - item.status | default(0) != 200

- name: Fetch userId for each Kaneo agent (sign-in — rate-limited, 5s pause)
  ansible.builtin.uri:
    url: "https://{{ kaneo_subdomain_override | default('hq') }}.{{ domain_name }}/api/auth/sign-in/email"
    method: POST
    body_format: json
    body:
      email: "{{ kaneo_agent_email_prefix }}{{ item.id }}@{{ domain_name }}"
      password: "{{ kaneo_agents_password }}"
    status_code: [200, -1]
    return_content: true
  register: kaneo_agent_cookies
  delegate_to: localhost
  no_log: true
  failed_when: false
  loop: "{{ kaneo_openclaw_agents }}"
  loop_control:
    label: "{{ item.id }}"
    pause: 5
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - kaneo_health_check.status | default(0) == 200
    - kaneo_agents_password | default('') | length > 0

# NOTE: BetterAuth /api/auth/organization/add-member returns 404 in this Kaneo version.
# Membership is provisioned via direct PostgreSQL INSERT (idempotent via ON CONFLICT DO NOTHING).
# workspace_member.id uses deterministic pattern ag<NN>ag... (32 chars) for idempotence.
- name: Add Kaneo agents to workspace via DB (idempotent — ON CONFLICT DO NOTHING)
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      IDX="{{ '%02d' | format(loop_index + 1) }}"
      MEMBER_ID="kaneo-agent-member-${IDX}-${IDX}-${IDX}-${IDX}-${IDX}"
      USER_ID="{{ item.json.user.id | default('') }}"
      WS_ID="{{ kaneo_workspace_id }}"
      ROLE="{{ kaneo_openclaw_agents[loop_index].role }}"
      RESULT=$(docker exec {{ project_name }}_postgresql psql -U kaneo -d kaneo -t \
        -c "INSERT INTO workspace_member (id, user_id, workspace_id, role, joined_at) \
            VALUES ('${MEMBER_ID}', '${USER_ID}', '${WS_ID}', '${ROLE}', NOW()) \
            ON CONFLICT (id) DO NOTHING;" 2>&1)
      echo "$RESULT"
  register: kaneo_add_member
  changed_when: "'INSERT 0 1' in kaneo_add_member.stdout"
  failed_when: false
  no_log: true
  become: true
  loop: "{{ kaneo_agent_cookies.results | default([]) }}"
  loop_control:
    label: "{{ kaneo_openclaw_agents[loop_index].id }}"
    index_var: loop_index
  when:
    - kaneo_openclaw_agents | default([]) | length > 0
    - kaneo_workspace_id | default('') | length > 0
    - item.json.user.id | default('') | length > 0

- name: Display Kaneo agents provisioning summary
  ansible.builtin.debug:
    msg: >-
      {% if not (kaneo_openclaw_agents | default([]) | length > 0) %}
      ℹ️  kaneo_openclaw_agents not configured.
      {% elif not (kaneo_agents_password | default('') | length > 0) %}
      ⚠️  kaneo_agents_password not set — add vault_kaneo_agents_password to secrets.yml.
      {% else %}
      Kaneo agents sync — workspace: {{ kaneo_workspace_id | default('?') }}
      Accounts created: {{ kaneo_agent_create.results | default([]) | selectattr('changed') |
      map(attribute='item.item.id') | list | join(', ') | default('none') }}
      Members added (DB): {{ kaneo_add_member.results | default([]) | selectattr('changed') |
      map(attribute='_ansible_item_label') | list | join(', ') | default('none') }}
      Already members: {{ kaneo_agent_probe.results | default([]) | selectattr('status', 'equalto', 200) |
      map(attribute='item.id') | list | join(', ') | default('none') }}
      {% endif %}
  when: kaneo_openclaw_agents | default([]) | length > 0
