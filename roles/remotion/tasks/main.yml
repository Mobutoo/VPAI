---
# remotion — tasks
# Remotion render server on RPi 5 (ARM64)
# Based on official template: remotion-dev/template-render-server
# Uses TypeScript + tsx + system Chromium (ARM64 native)
# REX: Playwright CDN blocks ARM64 browser download → use apt chromium instead

- name: Create Remotion install directory
  ansible.builtin.file:
    path: "{{ remotion_install_dir }}"
    state: directory
    owner: "{{ workstation_pi_user }}"
    group: "{{ workstation_pi_user }}"
    mode: "0755"
  become: true

- name: Create Remotion data directories
  ansible.builtin.file:
    path: "{{ remotion_data_dir }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop:
    - output
    - renders

- name: Create Remotion source subdirectories
  ansible.builtin.file:
    path: "{{ remotion_install_dir }}/{{ item }}"
    state: directory
    owner: "{{ workstation_pi_user }}"
    group: "{{ workstation_pi_user }}"
    mode: "0755"
  become: true
  loop:
    - server
    - remotion
    - remotion/HelloWorld

- name: Copy Remotion root files
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ remotion_install_dir }}/{{ item.dest }}"
    owner: "{{ workstation_pi_user }}"
    group: "{{ workstation_pi_user }}"
    mode: "0644"
  become: true
  loop:
    - { src: "Dockerfile", dest: "Dockerfile" }
    - { src: "package.json", dest: "package.json" }
    - { src: "remotion.config.ts", dest: "remotion.config.ts" }
    - { src: "tsconfig.json", dest: "tsconfig.json" }
  register: remotion_root_files

- name: Copy Remotion server source (TypeScript)
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ remotion_install_dir }}/{{ item.dest }}"
    owner: "{{ workstation_pi_user }}"
    group: "{{ workstation_pi_user }}"
    mode: "0644"
  become: true
  loop:
    - { src: "server/index.ts", dest: "server/index.ts" }
    - { src: "server/render-queue.ts", dest: "server/render-queue.ts" }
  register: remotion_server_files

- name: Copy Remotion compositions (TypeScript/React)
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ remotion_install_dir }}/{{ item.dest }}"
    owner: "{{ workstation_pi_user }}"
    group: "{{ workstation_pi_user }}"
    mode: "0644"
  become: true
  loop:
    - { src: "remotion/index.ts", dest: "remotion/index.ts" }
    - { src: "remotion/Root.tsx", dest: "remotion/Root.tsx" }
    - { src: "remotion/HelloWorld/HelloWorld.tsx", dest: "remotion/HelloWorld/HelloWorld.tsx" }
  register: remotion_composition_files

- name: Build Remotion Docker image (ARM64 — system Chromium)
  community.docker.docker_image:
    name: "remotion-local"
    tag: "{{ remotion_version }}"
    source: build
    build:
      path: "{{ remotion_install_dir }}"
      platform: "linux/arm64"
    force_source: >-
      {{ remotion_root_files.changed
         or remotion_server_files.changed
         or remotion_composition_files.changed }}
  become: true
  notify: Restart creative stack

- name: Wait for Remotion port to be open
  ansible.builtin.wait_for:
    host: localhost
    port: "{{ remotion_port }}"
    timeout: 120
    state: started
  changed_when: false
  failed_when: false

- name: Check Remotion health endpoint
  ansible.builtin.uri:
    url: "http://localhost:{{ remotion_port }}/health"
    method: GET
    status_code: [200]
  retries: 6
  delay: 10
  register: remotion_health
  until: remotion_health.status == 200
  changed_when: false
  failed_when: false

- name: Display Remotion health status
  ansible.builtin.debug:
    msg: "Remotion: {{ 'healthy' if remotion_health.status == 200 else 'unhealthy (status: ' ~ remotion_health.status | default('unknown') ~ ')' }}"
