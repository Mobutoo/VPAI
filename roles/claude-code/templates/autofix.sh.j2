#!/bin/bash
# {{ ansible_managed }}
# Auto-fix pipeline: Claude Code processes a GitHub issue and creates a PR
#
# Usage (positional args — DEPRECATED, kept for backward compat):
#   claude-autofix "<repo_url>" "<issue_id>" "<issue_title>" "<issue_body>"
#
# Usage (stdin JSON — PREFERRED, prevents shell injection):
#   echo '<base64 json>' | base64 -d | claude-autofix --stdin
set -euo pipefail

# Error trap for better debugging in n8n logs
trap 'echo "AUTOFIX FAILED: repo=${REPO_URL:-unknown} issue=#${ISSUE_ID:-unknown} at line $LINENO" >&2' ERR

# Parse input — stdin JSON mode or positional args
if [ "${1:-}" = "--stdin" ]; then
  # SECURITY: Read JSON from stdin to avoid shell injection via issue title/body
  INPUT_JSON=$(cat)
  REPO_URL=$(echo "$INPUT_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['repo_url'])")
  ISSUE_ID=$(echo "$INPUT_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['issue_id'])")
  ISSUE_TITLE=$(echo "$INPUT_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['issue_title'])")
  ISSUE_BODY=$(echo "$INPUT_JSON" | python3 -c "import sys,json; print(json.load(sys.stdin)['issue_body'])")
else
  REPO_URL="$1"
  ISSUE_ID="$2"
  ISSUE_TITLE="$3"
  ISSUE_BODY="$4"
fi

WORKSPACE="{{ claude_code_auto_fix_workspace }}"

REPO_NAME=$(basename "$REPO_URL" .git)
mkdir -p "$WORKSPACE"
cd "$WORKSPACE"

# Clone ou pull selon si le repo existe deja
if [ -d "$REPO_NAME" ]; then
  cd "$REPO_NAME"
  # Check branch existence before checkout (avoid suppressing useful errors)
  if git rev-parse --verify main >/dev/null 2>&1; then
    git checkout main
  elif git rev-parse --verify master >/dev/null 2>&1; then
    git checkout master
  else
    echo "ERROR: Neither main nor master branch found" >&2
    exit 1
  fi
  git pull --ff-only
else
  git clone "$REPO_URL"
  cd "$REPO_NAME"
fi

# Creer la branche de fix (reset if exists from failed previous run)
BRANCH="fix/GH-${ISSUE_ID}"
git checkout -B "$BRANCH"

# Claude Code en mode non-interactif — analyse et fixe l'issue
# Timeout: 10 minutes max, 25 turns max
timeout 600 claude --dangerously-skip-permissions --max-turns 25 -p \
  "Fix GitHub issue #${ISSUE_ID}: ${ISSUE_TITLE}

${ISSUE_BODY}

Requirements:
- Fix the issue described above
- Run tests/lint if a Makefile or test config exists (e.g. 'make lint', 'make test')
- Create a single commit with message: fix: <concise description> (fixes #${ISSUE_ID})
- Include 'Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>' in the commit body
- Do NOT push or create a PR — the calling script handles that step
- Do NOT modify any files in .vault, secrets.yml, .env, or SSH keys"

# Verify that Claude Code actually produced commits
COMMIT_COUNT=$(git rev-list main..HEAD --count 2>/dev/null || git rev-list master..HEAD --count 2>/dev/null || echo "0")
if [ "$COMMIT_COUNT" -eq 0 ]; then
  echo "ERROR: Claude Code produced no commits. Nothing to push." >&2
  exit 1
fi

# Push la branche
git push -u origin "$BRANCH"

# Creer la PR via GitHub CLI — let errors propagate (set -e)
PR_URL=$(gh pr create \
  --title "fix: ${ISSUE_TITLE}" \
  --body "## Summary
Automated fix for #${ISSUE_ID}

## Changes
Auto-generated by Claude Code via the auto-fix pipeline.

## Test plan
- [ ] CI passes (lint + tests)
- [ ] Manual review of changes before merge

---
Co-Authored-By: Claude Opus 4.6 <noreply@anthropic.com>" \
  --base main 2>&1)

echo "$PR_URL"
