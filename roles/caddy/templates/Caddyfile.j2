{
    admin localhost:2019
    email {{ caddy_notification_email }}
    servers {
        protocols h1 h2 h3
    }
    log {
        output file /var/log/caddy/access.log {
            roll_size 50MiB
            roll_keep 3
            roll_keep_for 168h
        }
        format json
        level INFO
    }
}

{% if caddy_vpn_enforce | default(true) | bool %}
(vpn_only) {
    @blocked not remote_ip {{ caddy_vpn_cidr }}
    error @blocked 403
}

(vpn_error_page) {
    handle_errors {
        root * /srv
        rewrite * /restricted-zone.html
        file_server
    }
}
{% else %}
# VPN enforcement DISABLED (caddy_vpn_enforce=false)
# Admin UIs are publicly accessible — for initial validation only
(vpn_only) {
}
(vpn_error_page) {
}
{% endif %}

# === PUBLIC DOMAIN ===
{{ caddy_domain }} {
    handle /health {
        respond "OK" 200
    }

    handle {
        respond "Not Found" 404
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# === ADMIN DOMAIN (Grafana + OpenClaw) ===
{{ caddy_admin_domain }} {
    import vpn_only
    import vpn_error_page

    # Grafana — supports sub-path via GF_SERVER_SERVE_FROM_SUB_PATH=true
    # Do NOT strip_prefix: Grafana handles the /grafana/ prefix itself
    handle /grafana/* {
        reverse_proxy grafana:3000
    }

    # OpenClaw Gateway (Control UI + WebSocket on port 18789)
    # basePath=/openclaw in openclaw.json — Gateway serves UI at /openclaw/
    # Do NOT strip_prefix: Gateway expects the full path with prefix
    handle /openclaw/* {
        reverse_proxy openclaw:18789
    }

    handle {
        root * /srv
        try_files {path} /admin-landing.html
        file_server
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}

# === n8n — dedicated subdomain ===
# REX: n8n does NOT support sub-path deployment (GitHub issue #19635)
{% if n8n_subdomain | default('') | length > 0 %}
{{ caddy_n8n_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy n8n:5678

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}

# === LiteLLM — dedicated subdomain ===
# REX: LiteLLM UI does NOT support sub-path (SERVER_ROOT_PATH buggy: issues #11451, #11865)
{% if litellm_subdomain | default('') | length > 0 %}
{{ caddy_litellm_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy litellm:4000

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}

# === Qdrant — dedicated subdomain ===
# REX: Qdrant dashboard does NOT support sub-path (qdrant-web-ui issue #94, open since 2023)
{% if qdrant_subdomain | default('') | length > 0 %}
{{ caddy_qdrant_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy qdrant:6333

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}
