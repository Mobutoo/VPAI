{
    admin localhost:2019
    email {{ caddy_notification_email }}
    servers {
        protocols h1 h2 h3
    }
    log {
        output file /var/log/caddy/access.log {
            roll_size 50MiB
            roll_keep 3
            roll_keep_for 168h
        }
        format json
        level INFO
    }
}

{% if caddy_vpn_enforce | default(true) | bool %}
(vpn_only) {
    @blocked not remote_ip {{ caddy_vpn_cidr }}
    error @blocked 403
}

(vpn_error_page) {
    handle_errors {
        root * /srv
        rewrite * /restricted-zone.html
        file_server
    }
}
{% else %}
# VPN enforcement DISABLED (caddy_vpn_enforce=false)
# Admin UIs are publicly accessible — for initial validation only
(vpn_only) {
}
(vpn_error_page) {
}
{% endif %}

# === PUBLIC DOMAIN — Admin Portal ===
{{ caddy_domain }} {
    # /health is public (Uptime Kuma, smoke tests) — matched first by path specificity
    handle /health {
        respond "OK" 200
    }

    # Admin portal (catch-all) — VPN-protected
    handle {
{% if caddy_vpn_enforce | default(true) | bool %}
        @blocked_root not remote_ip {{ caddy_vpn_cidr }}
        error @blocked_root 403
{% endif %}
        root * /srv
        rewrite * /admin-landing.html
        file_server
    }

{% if caddy_vpn_enforce | default(true) | bool %}
    handle_errors {
        root * /srv
        rewrite * /restricted-zone.html
        file_server
    }
{% endif %}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }
}

# === OpenClaw — dedicated subdomain (javisi) ===
# OpenClaw Gateway (Control UI + WebSocket on port 18789)
# basePath=/ — Gateway serves UI at root of its own subdomain
#
# REX: OpenClaw Control UI stores the gateway token in browser localStorage.
# On first access, localStorage is empty → WebSocket rejected → "token missing" loop.
# The /__bootstrap__ route injects the token into localStorage and redirects to /.
# This route is VPN-protected like the rest. First-time setup:
#   open https://{{ caddy_admin_domain }}/__bootstrap__
{{ caddy_admin_domain }} {
    import vpn_only
    import vpn_error_page

    # Token bootstrap — first-time Control UI setup (sets localStorage token)
    handle /__bootstrap__ {
        header Content-Type "text/html; charset=utf-8"
        respond `<!DOCTYPE html><html><head><meta charset="utf-8"><title>OpenClaw Setup</title></head><body style="background:#1a1a2e;color:#eee;font-family:sans-serif;display:flex;align-items:center;justify-content:center;height:100vh;margin:0"><div style="text-align:center"><h2>OpenClaw Gateway</h2><p id="msg">Configuring token...</p><script>try{let s=JSON.parse(localStorage.getItem('openclaw.control.settings.v1')||'{}');s.token='{{ openclaw_gateway_token }}';s.gatewayUrl='wss://{{ caddy_admin_domain }}';localStorage.setItem('openclaw.control.settings.v1',JSON.stringify(s));document.getElementById('msg').textContent='Token configured. Redirecting...';setTimeout(()=>window.location.href='/',500)}catch(e){document.getElementById('msg').textContent='Error: '+e.message}</script></div></body></html>` 200
    }

    reverse_proxy openclaw:18789

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}

# === Grafana — dedicated subdomain (tala) ===
# REX: Grafana on its own subdomain — no need for SERVE_FROM_SUB_PATH
{% if grafana_subdomain | default('') | length > 0 %}
{{ caddy_grafana_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy grafana:3000

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}

# === n8n — dedicated subdomain ===
# REX: n8n does NOT support sub-path deployment (GitHub issue #19635)
{% if n8n_subdomain | default('') | length > 0 %}
{{ caddy_n8n_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy n8n:5678

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}

# === LiteLLM — dedicated subdomain ===
# REX: LiteLLM UI does NOT support sub-path (SERVER_ROOT_PATH buggy: issues #11451, #11865)
{% if litellm_subdomain | default('') | length > 0 %}
{{ caddy_litellm_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy litellm:4000

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}

# === Qdrant — dedicated subdomain ===
# REX: Qdrant dashboard does NOT support sub-path (qdrant-web-ui issue #94, open since 2023)
{% if qdrant_subdomain | default('') | length > 0 %}
{{ caddy_qdrant_domain }} {
    import vpn_only
    import vpn_error_page

    reverse_proxy qdrant:6333

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}
