---
# Palais — Main tasks

- name: Create palais config directory
  ansible.builtin.file:
    path: "{{ palais_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0750"
  become: true
  tags: [palais]

- name: Create palais data directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "1001"
    group: "1001"
    mode: "0750"
  become: true
  loop:
    - "{{ palais_data_dir }}"
    - "{{ palais_data_dir }}/deliverables"
    - "{{ palais_data_dir }}/avatars"
  tags: [palais]

- name: Deploy palais environment file
  ansible.builtin.template:
    src: palais.env.j2
    dest: "{{ palais_config_dir }}/palais.env"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0640"
  become: true
  notify: Restart palais
  tags: [palais]

- name: Ensure palais app directory is writable by deploy user
  ansible.builtin.file:
    path: "/opt/{{ project_name }}/palais-app"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true
  tags: [palais]

# ── Module 13: Claude Code MCP config on Pi ─────────────────────────────────

- name: Ensure Claude config dir exists on Pi
  ansible.builtin.file:
    path: "/home/{{ workstation_pi_user }}/.claude/servers"
    state: directory
    owner: "{{ workstation_pi_user }}"
    mode: "0750"
  delegate_to: workstation-pi
  when: workstation_pi_tailscale_ip | default('') != ''
  tags: [palais, palais-mcp]

- name: Deploy Palais MCP server config to Pi
  ansible.builtin.template:
    src: claude-mcp-config.json.j2
    dest: "/home/{{ workstation_pi_user }}/.claude/servers/palais.json"
    owner: "{{ workstation_pi_user }}"
    mode: "0640"
  delegate_to: workstation-pi
  when: workstation_pi_tailscale_ip | default('') != ''
  tags: [palais, palais-mcp]

# ── DB Migration: add columns + extend node_status enum ─────────────────────
# Idempotent (IF NOT EXISTS) — ALTER TYPE ADD VALUE must run outside a transaction

- name: Palais DB migration — add bio/local_ip/description columns
  ansible.builtin.command:
    cmd: >-
      docker exec {{ project_name }}_postgresql psql -U {{ palais_db_user }} -d {{ palais_db_name }}
      -c "ALTER TABLE agents ADD COLUMN IF NOT EXISTS bio text;
          ALTER TABLE nodes ADD COLUMN IF NOT EXISTS local_ip varchar(50);
          ALTER TABLE nodes ADD COLUMN IF NOT EXISTS description text;"
  become: true
  changed_when: false
  register: _palais_db_migrate
  failed_when: _palais_db_migrate.rc != 0
  tags: [palais]

- name: Palais DB migration — extend node_status enum with busy/degraded
  ansible.builtin.command:
    cmd: >-
      docker exec {{ project_name }}_postgresql psql -U {{ palais_db_user }} -d {{ palais_db_name }}
      -c "ALTER TYPE node_status ADD VALUE IF NOT EXISTS 'busy';
          ALTER TYPE node_status ADD VALUE IF NOT EXISTS 'degraded';"
  become: true
  changed_when: false
  register: _palais_db_enum
  failed_when: _palais_db_enum.rc != 0
  tags: [palais]

# ─────────────────────────────────────────────────────────────────────────────

- name: Sync palais application source
  ansible.posix.synchronize:
    src: "{{ palais_app_dir }}/"
    dest: "/opt/{{ project_name }}/palais-app/"
    rsync_opts:
      - "--exclude=node_modules"
      - "--exclude=.svelte-kit"
      - "--exclude=build"
    delete: true
    dest_port: "{{ prod_ssh_port | int }}"
  notify: Restart palais
  tags: [palais]
