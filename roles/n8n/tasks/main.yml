---
# n8n â€” tasks

- name: Create n8n config directory
  ansible.builtin.file:
    path: "{{ n8n_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Create n8n data directory
  ansible.builtin.file:
    path: "{{ n8n_data_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true

- name: Deploy n8n environment file
  ansible.builtin.template:
    src: n8n.env.j2
    dest: "{{ n8n_config_dir }}/n8n.env"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0600"
  become: true
  notify: Restart n8n stack

# --- n8n owner provisioning (idempotent, first deploy only) ---
- name: Check if n8n owner is already provisioned
  ansible.builtin.command:
    cmd: >-
      docker exec {{ project_name }}_n8n
      sh -c 'curl -sf http://localhost:5678/rest/settings 2>/dev/null || echo "{}"'
  register: n8n_settings_check
  changed_when: false
  failed_when: false
  become: true
  when: n8n_owner_email | default('') | length > 0

- name: Set n8n setup state fact
  ansible.builtin.set_fact:
    n8n_setup_needed: >-
      {{ n8n_owner_email | default('') | length > 0 and
         '"showSetupPage":false' not in (n8n_settings_check.stdout | default('')) }}

- name: Wait for n8n container to be healthy
  ansible.builtin.command:
    cmd: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ project_name }}_n8n"
  register: n8n_health_status
  changed_when: false
  failed_when: false
  retries: 30
  delay: 5
  until: n8n_health_status.stdout | default('') == 'healthy'
  become: true
  when: n8n_setup_needed | bool

- name: Provision n8n owner account via API
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      docker exec {{ project_name }}_n8n sh -c '
        curl -sf -o /dev/null -w "%{http_code}" \
          -X POST http://localhost:5678/rest/owner/setup \
          -H "Content-Type: application/json" \
          -d "{
            \"email\":\"{{ n8n_owner_email }}\",
            \"firstName\":\"{{ n8n_owner_first_name }}\",
            \"lastName\":\"{{ n8n_owner_last_name }}\",
            \"password\":\"{{ n8n_owner_password }}\"
          }"
      '
  register: n8n_owner_result
  changed_when: n8n_owner_result.stdout | default('') == '200'
  failed_when: false
  no_log: true
  become: true
  when:
    - n8n_setup_needed | bool
    - n8n_health_status.stdout | default('') == 'healthy'

- name: Display n8n owner provisioning result
  ansible.builtin.debug:
    msg: >-
      {% if n8n_owner_result.stdout | default('') == '200' %}
      n8n owner account created successfully.
      {% elif n8n_owner_result.stdout | default('') == '400' %}
      n8n owner already exists (setup already completed). Skipping.
      {% elif not (n8n_setup_needed | bool) %}
      n8n owner already provisioned. Skipping wait and API call.
      {% else %}
      WARNING: n8n owner provisioning returned HTTP {{ n8n_owner_result.stdout | default('unknown') }}.
      Manual setup may be needed at https://admin.{{ domain_name }}/n8n/
      {% endif %}
  when: n8n_owner_email | default('') | length > 0
