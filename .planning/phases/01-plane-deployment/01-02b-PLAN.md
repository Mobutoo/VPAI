---
wave: 2
depends_on: ["01-02a"]
files_modified:
  - inventory/group_vars/all/secrets.yml
  - docs/GUIDE-PLANE-PROVISIONING.md
autonomous: false
checkpoint: manual
---

# Plan 01-02b: Vault Configuration & Manual Provisioning Guide

**Goal**: Add API token placeholders to Ansible Vault and create operator guide for manual provisioning steps with token validation checkpoint.

**Requirements**: AUTH-03, AUTH-04

## Context

Plane API token management has a critical manual dependency: the instance admin token cannot be created programmatically in v1.2.2. This requires:
1. Manual first login via UI wizard (God Mode setup)
2. Manual admin token creation via Profile Settings
3. Vault update with real admin token value
4. Execution of provision script to auto-generate agent tokens

The checker identified that AUTH-03 requirement (agent tokens populated) could be violated if smoke tests skip validation when admin token is placeholder. This plan adds a manual checkpoint to ensure tokens are populated before phase completion.

**Critical constraints:**
- Admin token is prerequisite for all provisioning - empty placeholder prevents automation
- Checkpoint: manual task requires operator confirmation that provision script has been run and vault_plane_agent_tokens are populated
- Smoke tests must assert agent token values are non-empty (not just skip when admin token is placeholder)

## Tasks

<task id="01-02b-T1" name="vault-admin-token-placeholder">
Add to inventory/group_vars/all/secrets.yml (Ansible Vault):

```yaml
# Plane instance admin API token
# MANUAL STEP REQUIRED: After first Plane login, create token via UI:
# 1. Login to https://work.{{ domain_name }} with {{ admin_email }}
# 2. Go to Profile Settings > Personal Access Tokens
# 3. Create token named "ansible-provisioning" with no expiration
# 4. Copy token value here
vault_plane_admin_api_token: "REPLACE_AFTER_FIRST_LOGIN"

# Plane Concierge user account password (random-generated, used for account creation)
# CRITICAL: Ansible Vault does NOT evaluate Jinja2 lookup() - must be a literal value
# Generate before encrypting: openssl rand -base64 18 | tr -d /+=
vault_plane_concierge_password: "GENERATE_WITH_OPENSSL_BEFORE_VAULT_ENCRYPT"

# Plane agent API tokens (generated by provision script, stored here)
vault_plane_agent_tokens:
  concierge: ""
  imhotep: ""
  thot: ""
  basquiat: ""
  r2d2: ""
  shuri: ""
  piccolo: ""
  cfo: ""
  maintainer: ""
  hermes: ""
```

Add comment: "Provisioning is semi-automated - admin token requires manual creation, agent tokens auto-generated".
</task>

<task id="01-02b-T2" name="create-manual-provisioning-guide">
Create docs/GUIDE-PLANE-PROVISIONING.md with manual steps:

Sections:
1. First Login (manual UI setup required before automation):
   - Access https://work.{{ domain_name }} via VPN
   - Complete God Mode setup wizard (instance admin account creation)
   - Login with {{ admin_email }}

2. Admin API Token Creation:
   - Navigate to Profile Settings > Personal Access Tokens
   - Click "Create New Token"
   - Name: "ansible-provisioning"
   - Scope: Full access (instance admin)
   - Expiration: Never (internal VPN service)
   - Copy token value
   - Update secrets.yml: ansible-vault edit inventory/group_vars/all/secrets.yml
   - Replace vault_plane_admin_api_token: "REPLACE_AFTER_FIRST_LOGIN" with actual token

3. Run Provisioning Playbook:
   - Command: make deploy-role ROLE=plane-provision ENV=prod
   - Expected output: Workspace created, 10 agent tokens generated, 4 custom fields added, Onboarding project created
   - Script will update vault_plane_agent_tokens in secrets.yml with generated values

4. Verification:
   - Check Plane UI: Workspace "javisi" exists
   - Check projects: "Onboarding" project with 3 demo issues
   - Check custom fields: Settings > Custom Fields shows agent_id, cost_estimate, confidence_score, session_id
   - Verify vault: ansible-vault view inventory/group_vars/all/secrets.yml | grep -A 10 vault_plane_agent_tokens
   - Assert: All 10 agent token values are non-empty strings (not "")

5. Troubleshooting:
   - API returns 401: Admin token invalid or expired - regenerate via UI
   - Workspace already exists: Provisioning script is idempotent - rerun safe
   - Custom fields fail: Work item type ID mismatch - check GET /api/v1/workspaces/javisi/work-item-types/ response
   - Agent tokens empty after provision: Check provision script logs for errors, verify script has write access to vault file

Format: Markdown with step-by-step commands and expected outputs.
</task>

<task id="01-02b-T3" name="checkpoint-manual-token-validation">
CHECKPOINT: Manual operator action required before phase completion.

This task creates a blocking checkpoint that requires operator confirmation that:
1. Admin token has been created via UI and updated in secrets.yml
2. Provision script has been executed successfully (make deploy-role ROLE=plane-provision ENV=prod)
3. Agent tokens in vault_plane_agent_tokens are populated with non-empty values

Verification commands for operator:
```bash
# Check admin token is not placeholder
ansible-vault view inventory/group_vars/all/secrets.yml | grep vault_plane_admin_api_token | grep -v REPLACE

# Check agent tokens are populated (should return 10 non-empty token values)
ansible-vault view inventory/group_vars/all/secrets.yml | awk '/vault_plane_agent_tokens:/,/^[^ ]/ {if ($2 != "\"\"" && $2 != "") print}' | grep -c ':'

# Verify no empty tokens (should return 0 lines with "": "")
ansible-vault view inventory/group_vars/all/secrets.yml | grep -A 10 vault_plane_agent_tokens | grep -c '""'
```

CRITICAL FIX (BLOCKER #3): Checkpoint validation now uses awk to filter non-empty values, not grep -c 'plane_' which counts key names. The second command counts lines with non-empty values (should be 10). The third command counts empty string values (should be 0).

This checkpoint addresses AUTH-03 blocker: smoke tests cannot validate agent auth if tokens are empty. Manual confirmation ensures tokens are populated before execution proceeds to smoke tests (Plan 01-03).

**Execution note**: This task does NOT create files. It is a MANUAL CHECKPOINT that pauses execution until operator confirms token provisioning is complete. Executors must prompt operator and wait for confirmation before marking task complete.
</task>

## Verification Criteria

After execution:

1. **Vault configuration**:
   - secrets.yml has vault_plane_admin_api_token with "REPLACE_AFTER_FIRST_LOGIN" placeholder
   - secrets.yml has vault_plane_concierge_password with random-generated 24-char password (AUTH-01 requirement)
   - secrets.yml has vault_plane_agent_tokens dict with 10 agent keys (empty values initially)
   - Comment explains manual step requirement

2. **Documentation complete**:
   - docs/GUIDE-PLANE-PROVISIONING.md exists with 5 sections
   - Guide includes curl commands for manual testing and troubleshooting steps
   - Verification section includes commands to assert agent tokens are populated

3. **Checkpoint validated** (CRITICAL - AUTH-03 requirement):
   - Operator has confirmed admin token is not "REPLACE_AFTER_FIRST_LOGIN"
   - Operator has confirmed provision script executed successfully
   - Operator has confirmed all 10 vault_plane_agent_tokens values are non-empty strings using awk-based validation (BLOCKER #3 fix)
   - Vault verification command `grep -c '""'` returns 0 (no empty tokens)
   - Vault verification command with awk filter returns 10 (all tokens populated)

4. **Code quality**:
   - Vault comments clearly explain manual steps
   - Guide includes expected outputs for each command
   - Verification commands use grep/count patterns for programmatic validation

## Must-Haves

Derived from phase goal: "Agent tokens populated and validated before phase completion"

1. **Admin token placeholder created**: vault_plane_admin_api_token in secrets.yml with clear instructions
2. **Concierge password generated**: vault_plane_concierge_password contains random 24-char password for user account creation (AUTH-01 requirement)
3. **Agent token structure ready**: vault_plane_agent_tokens dict with 10 empty slots
4. **Manual steps documented**: GUIDE-PLANE-PROVISIONING.md provides step-by-step instructions for first login and token creation
5. **Checkpoint enforced**: Execution pauses until operator confirms tokens are populated using corrected validation commands (AUTH-03 blocker fix)
6. **Verification commands fixed**: awk-based filter correctly detects empty token values, not just YAML key names (BLOCKER #3 fix)
7. **No empty tokens pass validation**: Checkpoint ensures smoke tests (Plan 01-03) will have real tokens to validate
