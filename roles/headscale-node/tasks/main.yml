---
# headscale-node — tasks

- name: Create keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true

- name: Download Tailscale GPG key
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      TAILSCALE_GPG="https://pkgs.tailscale.com/stable/debian"
      curl -fsSL "${TAILSCALE_GPG}/{{ ansible_facts['distribution_release'] }}.noarmor.gpg" \
        | gpg --dearmor --yes -o /etc/apt/keyrings/tailscale-archive-keyring.gpg
      chmod a+r /etc/apt/keyrings/tailscale-archive-keyring.gpg
  args:
    creates: /etc/apt/keyrings/tailscale-archive-keyring.gpg
  changed_when: true
  become: true

- name: Add Tailscale repository
  ansible.builtin.apt_repository:
    repo: >-
      deb [signed-by=/etc/apt/keyrings/tailscale-archive-keyring.gpg]
      https://pkgs.tailscale.com/stable/debian
      {{ ansible_facts['distribution_release'] }} main
    state: present
    filename: tailscale
  become: true

- name: Install Tailscale
  ansible.builtin.apt:
    name: tailscale
    state: present
    update_cache: true
  become: true

- name: Enable and start Tailscale service
  ansible.builtin.systemd:
    name: tailscaled
    state: started
    enabled: true
  become: true

- name: Check Tailscale status
  ansible.builtin.command:
    cmd: tailscale status --json
  register: tailscale_status_raw
  changed_when: false
  failed_when: false
  become: true

- name: Parse Tailscale status
  ansible.builtin.set_fact:
    tailscale_status: "{{ tailscale_status_raw.stdout | from_json }}"
  when: tailscale_status_raw.rc == 0

- name: Authenticate with Headscale server
  ansible.builtin.command:
    cmd: >-
      tailscale up
      --login-server={{ headscale_login_server }}
      --authkey={{ headscale_auth_key_value }}
      --hostname={{ headscale_hostname }}
      {% if headscale_accept_routes %}--accept-routes{% endif %}
      {% if headscale_advertise_routes | length > 0 %}--advertise-routes={{ headscale_advertise_routes | join(',') }}{% endif %}
  become: true
  changed_when: true
  register: tailscale_up_result
  when: >-
    tailscale_status_raw.rc != 0 or
    (tailscale_status is defined and tailscale_status.BackendState != "Running")

- name: Get Tailscale IP address
  ansible.builtin.command:
    cmd: tailscale ip -4
  register: tailscale_ip_result
  changed_when: false
  become: true

- name: Save Tailscale IP as fact
  ansible.builtin.set_fact:
    tailscale_ip: "{{ tailscale_ip_result.stdout | trim }}"
    cacheable: true

- name: Verify VPN connectivity (non-blocking)
  ansible.builtin.command:
    cmd: "ping -c 3 -W 5 {{ headscale_vpn_ip }}"
  changed_when: false
  failed_when: false
  register: vpn_connectivity_check
  become: true

- name: Display VPN connectivity status
  ansible.builtin.debug:
    msg: >-
      {% if vpn_connectivity_check.rc == 0 %}
      ✓ VPN connectivity to Seko-VPN ({{ headscale_vpn_ip }}) is working
      {% else %}
      ⚠ VPN connectivity check failed - VPS will continue using its own routing.
      This is normal on first deployment. Configure routing rules manually if needed.
      {% endif %}

- name: Display Tailscale IP
  ansible.builtin.debug:
    msg: "Tailscale IP assigned: {{ tailscale_ip }}"
