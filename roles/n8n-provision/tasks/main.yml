---
# n8n-provision — tasks
# Provisionne le compte owner n8n via API (après docker-stack)

- name: Check if n8n container exists
  ansible.builtin.command:
    cmd: "docker ps -q -f name={{ project_name }}_n8n"
  register: n8n_container_check
  changed_when: false
  failed_when: false
  become: true

- name: Skip n8n provisioning if container doesn't exist
  ansible.builtin.debug:
    msg: "⚠️  n8n container not found, skipping owner provisioning"
  when: n8n_container_check.stdout | default('') | length == 0

- name: Check if n8n owner is already provisioned
  ansible.builtin.command:
    cmd: >-
      docker exec {{ project_name }}_n8n
      sh -c 'curl -sf http://localhost:5678/rest/settings 2>/dev/null || echo "{}"'
  register: n8n_settings_check
  changed_when: false
  failed_when: false
  become: true
  when:
    - n8n_owner_email | default('') | length > 0
    - n8n_container_check.stdout | default('') | length > 0

- name: Set n8n setup state fact
  ansible.builtin.set_fact:
    n8n_setup_needed: >-
      {{ n8n_owner_email | default('') | length > 0 and
         n8n_container_check.stdout | default('') | length > 0 and
         '"showSetupPage":false' not in (n8n_settings_check.stdout | default('')) }}

- name: Wait for n8n container to be healthy
  ansible.builtin.command:
    cmd: "docker inspect --format='{{ '{{' }}.State.Health.Status{{ '}}' }}' {{ project_name }}_n8n"
  register: n8n_health_status
  changed_when: false
  failed_when: false
  retries: 30
  delay: 5
  until: n8n_health_status.stdout | default('') == 'healthy'
  become: true
  when: n8n_setup_needed | bool

- name: Provision n8n owner account via API
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -o pipefail
      docker exec {{ project_name }}_n8n sh -c '
        curl -sf -o /dev/null -w "%{http_code}" \
          -X POST http://localhost:5678/rest/owner/setup \
          -H "Content-Type: application/json" \
          -d "{
            \"email\":\"{{ n8n_owner_email }}\",
            \"firstName\":\"{{ n8n_owner_first_name }}\",
            \"lastName\":\"{{ n8n_owner_last_name }}\",
            \"password\":\"{{ n8n_owner_password }}\"
          }"
      '
  register: n8n_owner_result
  changed_when: n8n_owner_result.stdout | default('') == '200'
  failed_when: false
  no_log: true
  become: true
  when:
    - n8n_setup_needed | bool
    - n8n_health_status.stdout | default('') == 'healthy'

- name: Display n8n owner provisioning result
  ansible.builtin.debug:
    msg: >-
      {% if n8n_owner_result.stdout | default('') == '200' %}
      ✅ n8n owner account created successfully.
      {% elif n8n_owner_result.stdout | default('') == '400' %}
      ℹ️  n8n owner already exists (setup already completed). Skipping.
      {% elif not (n8n_setup_needed | bool) %}
      ℹ️  n8n owner already provisioned or not configured. Skipping.
      {% else %}
      ⚠️  WARNING: n8n owner provisioning returned HTTP {{ n8n_owner_result.stdout | default('unknown') }}.
      Manual setup may be needed at https://{{ caddy_admin_domain }}/n8n/
      {% endif %}
