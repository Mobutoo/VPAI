---
# openclaw — tasks
# OpenClaw is a personal AI assistant Gateway (WebSocket on port 18789)
# It does NOT use PostgreSQL/Redis/Qdrant directly — it's file-based
# Models are routed through LiteLLM proxy via models.providers config
#
# Volume layout: /opt/<project>/data/openclaw/ maps to /home/node/.openclaw/
# OpenClaw needs full RW access to .openclaw/ (canvas, cron, sessions, plugins)

- name: Create OpenClaw config directory
  ansible.builtin.file:
    path: "{{ openclaw_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Create OpenClaw data directory
  ansible.builtin.file:
    path: "{{ openclaw_data_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true

- name: Create OpenClaw subdirectories
  ansible.builtin.file:
    path: "{{ openclaw_data_dir }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop:
    - workspace
    - canvas
    - cron

- name: Deploy OpenClaw Gateway configuration (openclaw.json)
  ansible.builtin.template:
    src: openclaw.json.j2
    dest: "{{ openclaw_data_dir }}/openclaw.json"
    owner: "1000"
    group: "1000"
    mode: "0600"
  become: true
  notify: Restart openclaw stack

- name: Deploy OpenClaw environment file
  ansible.builtin.template:
    src: openclaw.env.j2
    dest: "{{ openclaw_config_dir }}/openclaw.env"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0600"
  become: true
  notify: Restart openclaw stack
