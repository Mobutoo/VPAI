---
# .github/workflows/deploy-preprod.yml — Deploy to pre-production
# Strategy: Scenario B — Permanent CX23 server (see docs/PREPROD-STRATEGY.md)
#
# The preprod server is persistent and declared in inventory/hosts.yml.
# Ansible deploys diffs only (~5 min), no ephemeral provisioning.
#
# Required GitHub secrets:
#   SSH_PRIVATE_KEY          — SSH private key for deployment user
#   ANSIBLE_VAULT_PASSWORD   — Vault password
#   PREPROD_SERVER_IP        — Preprod server IP (from Hetzner CX23)
#   PREPROD_DOMAIN           — Preprod domain (e.g., preprod.example.com)
#   LITELLM_MASTER_KEY       — For smoke test API checks
#   HETZNER_CLOUD_TOKEN      — For snapshot creation (optional)

name: Deploy Pre-production

on:
  workflow_dispatch:
    inputs:
      seed_data:
        description: 'Seed preprod with fresh prod data after deploy?'
        required: false
        type: boolean
        default: false
      snapshot:
        description: 'Create golden snapshot after successful tests?'
        required: false
        type: boolean
        default: false
  push:
    branches: [main]
    paths:
      - 'roles/**'
      - 'playbooks/**'
      - 'inventory/**'
      - 'templates/**'

env:
  ANSIBLE_FORCE_COLOR: "1"

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - run: pip install ansible ansible-lint yamllint
      - run: ansible-galaxy install -r requirements.yml
      - name: YAML Lint
        run: |
          find . \( -name '*.yml' -o -name '*.yaml' \) \
            ! -path './.git/*' ! -path './.venv/*' \
            ! -path '*/molecule/*' ! -path '*/collections/*' \
            ! -name 'secrets.yml' -print0 | xargs -0 yamllint -c .yamllint.yml
      - run: ansible-lint playbooks/site.yml

  deploy:
    name: Deploy to Preprod
    needs: lint
    runs-on: ubuntu-latest
    environment: preprod
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install ansible jmespath
          ansible-galaxy install -r requirements.yml

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.PREPROD_SERVER_IP }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Wait for SSH availability
        run: |
          for i in $(seq 1 12); do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
              root@${{ secrets.PREPROD_SERVER_IP }} echo "SSH ready"; then
              exit 0
            fi
            echo "Waiting for SSH... (attempt $i/12)"
            sleep 5
          done
          echo "SSH timeout" && exit 1

      - name: Create vault password file
        run: |
          printf '%s' "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_password
          chmod 600 .vault_password

      - name: Deploy to permanent preprod server
        run: |
          ansible-playbook playbooks/site.yml \
            -i "${{ secrets.PREPROD_SERVER_IP }}," \
            -e "target_env=preprod" \
            -e "ansible_user=root" \
            --diff

  seed:
    name: Seed Prod Data
    needs: deploy
    if: github.event.inputs.seed_data == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install ansible jmespath
          ansible-galaxy install -r requirements.yml

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.PREPROD_SERVER_IP }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Create vault password file
        run: |
          printf '%s' "${{ secrets.ANSIBLE_VAULT_PASSWORD }}" > .vault_password
          chmod 600 .vault_password

      - name: Seed preprod with prod data
        run: |
          ansible-playbook playbooks/seed-preprod.yml \
            -i "${{ secrets.PREPROD_SERVER_IP }}," \
            -e "target_env=preprod" \
            -e "ansible_user=root" \
            --diff

  smoke-tests:
    name: Smoke Tests
    needs: [deploy, seed]
    if: always() && needs.deploy.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.PREPROD_SERVER_IP }}" >> ~/.ssh/known_hosts 2>/dev/null

      - name: Wait for services to stabilize
        run: sleep 30

      - name: Run public smoke tests from CI
        run: |
          bash scripts/smoke-test.sh \
            --ci \
            "https://${{ secrets.PREPROD_DOMAIN }}"
        env:
          LITELLM_KEY: ${{ secrets.LITELLM_MASTER_KEY }}

      - name: Run full smoke tests on server via SSH
        run: |
          ssh root@${{ secrets.PREPROD_SERVER_IP }} \
            "bash /opt/*/scripts/smoke-test.sh 2>&1" || true

  snapshot:
    name: Create Golden Snapshot
    needs: smoke-tests
    if: >-
      github.event.inputs.snapshot == 'true' &&
      needs.smoke-tests.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Install hcloud CLI
        run: |
          curl -sL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar xz
          sudo mv hcloud /usr/local/bin/

      - name: Find preprod server ID
        id: server
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_CLOUD_TOKEN }}
        run: |
          SERVER_ID=$(hcloud server list --selector project=vpai-preprod \
            -o json | jq -r '.[0].id // empty')
          if [ -z "$SERVER_ID" ]; then
            echo "No preprod server found with label project=vpai-preprod"
            exit 1
          fi
          echo "id=$SERVER_ID" >> "$GITHUB_OUTPUT"

      - name: Create snapshot
        env:
          HCLOUD_TOKEN: ${{ secrets.HETZNER_CLOUD_TOKEN }}
        run: |
          hcloud server create-image \
            --type snapshot \
            --description "Golden $(date +%Y%m%d-%H%M)" \
            --label project=vpai \
            ${{ steps.server.outputs.id }}
