#!/bin/bash
# MinIO bucket provisioning script
# Generated by Ansible — DO NOT edit manually
set -euo pipefail

CONTAINER="{{ project_name }}_plane_minio"
BUCKET="{{ plane_minio_bucket }}"
ENDPOINT="http://localhost:{{ plane_minio_api_port }}"
ACCESS_KEY="{{ plane_minio_access_key }}"
SECRET_KEY="{{ plane_minio_secret_key }}"
MARKER="{{ plane_config_dir }}/.minio-provision-complete"

if [[ -f "${MARKER}" ]]; then
    echo "[MinIO] Already provisioned — skipping"
    exit 0
fi

echo "[MinIO] Configuring mc alias..."
docker exec "${CONTAINER}" \
    mc alias set local "${ENDPOINT}" "${ACCESS_KEY}" "${SECRET_KEY}" --quiet

echo "[MinIO] Creating bucket: ${BUCKET}..."
docker exec "${CONTAINER}" \
    mc mb --ignore-existing "local/${BUCKET}"

echo "[MinIO] Setting bucket policy to download..."
docker exec "${CONTAINER}" \
    mc anonymous set download "local/${BUCKET}"

echo "[MinIO] Bucket '${BUCKET}' provisioned successfully"
touch "${MARKER}"
