{
    email {{ caddy_notification_email }}
    servers {
        protocols h1 h2 h3
    }
    log {
        output file /var/log/caddy/access.log {
            roll_size 50MiB
            roll_keep 3
            roll_keep_for 168h
        }
        format json
        level INFO
    }
}

(vpn_only) {
    @blocked not remote_ip {{ caddy_vpn_cidr }}
    respond @blocked 403
}

{{ caddy_domain }} {
    handle /litellm/* {
        uri strip_prefix /litellm
        reverse_proxy litellm:4000
    }

    handle /health {
        respond "OK" 200
    }

    handle {
        respond "Not Found" 404
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    rate_limit {
        zone global {
            key {remote_host}
            events {{ caddy_rate_limit_events }}
            window {{ caddy_rate_limit_window }}
        }
    }
}

{{ caddy_admin_domain }} {
    import vpn_only

    handle /n8n/* {
        uri strip_prefix /n8n
        reverse_proxy n8n:5678
    }

    handle /grafana/* {
        uri strip_prefix /grafana
        reverse_proxy grafana:3000
    }

    handle /openclaw/* {
        uri strip_prefix /openclaw
        reverse_proxy openclaw:8080
    }

    handle /qdrant/* {
        uri strip_prefix /qdrant
        reverse_proxy qdrant:6333
    }

    handle {
        root * /srv
        try_files {path} /admin-landing.html
        file_server
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
