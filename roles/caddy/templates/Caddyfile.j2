{
    admin localhost:2019
    email {{ caddy_notification_email }}
    servers {
        protocols h1 h2 h3
    }
    log {
        output file /var/log/caddy/access.log {
            roll_size 50MiB
            roll_keep 3
            roll_keep_for 168h
        }
        format json
        level INFO
    }
}

(vpn_only) {
    @blocked not remote_ip {{ caddy_vpn_cidr }}
    handle @blocked {
        root * /srv
        rewrite * /restricted-zone.html
        file_server
    }
}

{{ caddy_domain }} {
    handle /health {
        respond "OK" 200
    }

    handle /litellm/* {
        uri strip_prefix /litellm
        reverse_proxy litellm:4000
    }

    handle {
        respond "Not Found" 404
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"
        -Server
    }

    # NOTE: rate_limit requires caddy-ratelimit plugin (not in stock image)
    # To enable, build custom Caddy image with: xcaddy build --with github.com/mholt/caddy-ratelimit
    # rate_limit {
    #     zone global {
    #         key {remote_host}
    #         events {{ caddy_rate_limit_events }}
    #         window {{ caddy_rate_limit_window }}
    #     }
    # }
}

{{ caddy_admin_domain }} {
    import vpn_only

    handle /grafana/* {
        reverse_proxy grafana:3000
    }

    handle /openclaw/* {
        uri strip_prefix /openclaw
        reverse_proxy openclaw:8080
    }

    handle /qdrant/* {
        uri strip_prefix /qdrant
        reverse_proxy qdrant:6333
    }

{% if n8n_subdomain | default('') | length == 0 %}
    # n8n on admin subdomain sub-path (fallback when no dedicated subdomain)
    handle /n8n/* {
        uri strip_prefix /n8n
        reverse_proxy n8n:5678
    }
{% endif %}

    handle {
        root * /srv
        try_files {path} /admin-landing.html
        file_server
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}

{% if n8n_subdomain | default('') | length > 0 %}
# n8n on dedicated subdomain ({{ caddy_n8n_domain }})
# REX: n8n does NOT support sub-path deployment (GitHub issue #19635)
# A dedicated subdomain is the only reliable approach
{{ caddy_n8n_domain }} {
    import vpn_only

    reverse_proxy n8n:5678

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        -Server
    }
}
{% endif %}
