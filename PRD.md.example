# PRD ‚Äî Self-Hosted AI Infrastructure Stack

> **Version** : 1.0.0  
> **Date** : 11 f√©vrier 2026  
> **Auteur** : Architecture g√©n√©r√©e par Claude Opus 4.6  
> **Statut** : Draft ‚Äî En attente de validation

---

## 1. Vision

D√©ployer une infrastructure AI/automatisation auto-h√©berg√©e, s√©curis√©e et observable sur un VPS unique, orchestr√©e par Ansible avec CI/CD GitHub Actions, backup automatis√© via Zerobyte, et monitoring externe. Le tout con√ßu comme un template portable r√©utilisable sur n'importe quel projet.

---

## 2. Wizard de Configuration ‚Äî Variables du Projet

> **Instructions** : Dupliquer ce fichier et remplir les valeurs `<√Ä_REMPLIR>` avant tout d√©ploiement.
> Ce wizard est la **source unique de v√©rit√©** pour l'ensemble du projet.

### 2.1 Identit√© du Projet

```yaml
# ====================================================================
# WIZARD DE CONFIGURATION ‚Äî Remplir avant tout d√©ploiement
# ====================================================================

# --- Identit√© projet ---
project_name: "<√Ä_REMPLIR>"              # Ex: "seko-ai"
project_display_name: "<√Ä_REMPLIR>"       # Ex: "Seko-AI"
project_description: "Stack AI/automatisation auto-h√©berg√©e"
project_repo_url: "<√Ä_REMPLIR>"           # Ex: "git@github.com:user/seko-ai.git"
project_repo_branch: "main"

# --- Domaine & DNS ---
domain_name: "<√Ä_REMPLIR>"               # Ex: "seko-ai.example.com"
domain_registrar: "ovh"                   # ovh | cloudflare | hetzner
dns_api_endpoint: "ovh-eu"               # ovh-eu | ovh-ca | ovh-us
subdomain_preprod: "preprod"              # Sous-domaine pr√©-prod

# --- VPS Production (OVH) ---
prod_provider: "ovh"
prod_hostname: "<√Ä_REMPLIR>"             # Ex: "vps-prod-01"
prod_ip: "<√Ä_REMPLIR>"                   # IP publique du VPS
prod_os: "debian-13"
prod_ram_gb: 8                            # RAM en GB
prod_cpu_cores: 4
prod_disk_gb: 80                          # Stockage NVMe en GB
prod_ssh_port: 2222                       # Port SSH custom (pas 22)
prod_user: "deploy"                       # Utilisateur de d√©ploiement

# --- VPS VPN (existant) ---
vpn_provider: "<√Ä_REMPLIR>"              # Ex: "hetzner" | "ovh"
vpn_hostname: "<√Ä_REMPLIR>"              # Ex: "seko-vpn"
vpn_headscale_url: "<√Ä_REMPLIR>"         # Ex: "https://vpn.example.com"
vpn_headscale_ip: "<√Ä_REMPLIR>"          # IP Headscale du VPN server
vpn_network_cidr: "100.64.0.0/10"        # CIDR du r√©seau Tailscale/Headscale

# --- Pr√©-production (Hetzner Cloud) ---
preprod_provider: "hetzner"
preprod_server_type: "cx23"               # 2 vCPU / 4GB RAM / 40GB NVMe
preprod_location: "fsn1"                  # Falkenstein, Allemagne
preprod_os_image: "debian-13"

# --- Stockage S3 (Hetzner Object Storage) ---
s3_provider: "hetzner"
s3_region: "fsn1"                         # M√™me DC que pr√©-prod = trafic interne gratuit
s3_bucket_name: "<√Ä_REMPLIR>"            # Ex: "seko-ai-backups"
s3_endpoint: "fsn1.your-objectstorage.com"

# --- Notifications ---
notification_method: "<√Ä_REMPLIR>"        # discord | slack | telegram | email | ntfy
notification_webhook_url: "<√Ä_REMPLIR>"   # URL du webhook
notification_email: "<√Ä_REMPLIR>"         # Email de notification (si applicable)

# --- Timezone ---
timezone: "Europe/Paris"
locale: "fr_FR.UTF-8"
```

### 2.2 Secrets (Ansible Vault)

```yaml
# ====================================================================
# SECRETS ‚Äî Chiffrer avec : ansible-vault encrypt secrets.yml
# ====================================================================

# --- DNS API (OVH) ---
ovh_application_key: "<VAULT>"
ovh_application_secret: "<VAULT>"
ovh_consumer_key: "<VAULT>"

# --- Hetzner Cloud ---
hetzner_cloud_token: "<VAULT>"
hetzner_s3_access_key: "<VAULT>"
hetzner_s3_secret_key: "<VAULT>"

# --- Base de donn√©es ---
postgresql_password: "<VAULT>"            # G√©n√©rer : openssl rand -base64 32
postgresql_db_name: "{{ project_name }}"
redis_password: "<VAULT>"                 # G√©n√©rer : openssl rand -base64 32

# --- Applications ---
n8n_encryption_key: "<VAULT>"             # G√©n√©rer : openssl rand -hex 32
n8n_basic_auth_user: "<VAULT>"
n8n_basic_auth_password: "<VAULT>"
litellm_master_key: "<VAULT>"             # Cl√© ma√Ætre LiteLLM
litellm_api_keys: "<VAULT>"              # Cl√©s API providers (OpenAI, Anthropic...)
openclaw_api_key: "<VAULT>"
grafana_admin_password: "<VAULT>"
qdrant_api_key: "<VAULT>"                 # G√©n√©rer : openssl rand -hex 32

# --- Zerobyte ---
zerobyte_s3_access_key: "{{ hetzner_s3_access_key }}"
zerobyte_s3_secret_key: "{{ hetzner_s3_secret_key }}"

# --- Headscale/Tailscale ---
headscale_auth_key: "<VAULT>"             # Cl√© pr√©-authentification Headscale

# --- SSH ---
ssh_authorized_keys:
  - "<VAULT>"                             # Cl√© publique SSH de l'op√©rateur
```

### 2.3 Versions Applicatives (source unique de v√©rit√©)

```yaml
# ====================================================================
# VERSIONS ‚Äî Images Docker pinn√©es (PAS de :latest)
# V√©rifi√© le : 11 f√©vrier 2026
# ====================================================================

# --- Donn√©es ---
postgresql_image: "postgres:18.1-bookworm"
redis_image: "redis:8.0.10-bookworm"
qdrant_image: "qdrant/qdrant:v1.16.3"

# --- Applications ---
openclaw_image: "ghcr.io/openclaw/openclaw:v2026.2.9"
n8n_image: "docker.n8n.io/n8nio/n8n:2.7.3"
litellm_image: "ghcr.io/berriai/litellm:v1.81.3-stable"

# --- Reverse Proxy ---
caddy_image: "caddy:2.10.2-alpine"

# --- Observabilit√© ---
grafana_image: "grafana/grafana:12.3.2"
victoriametrics_image: "victoriametrics/victoria-metrics:v1.135.0"
loki_image: "grafana/loki:3.6.5"
alloy_image: "grafana/alloy:v1.13.0"

# --- Syst√®me ---
diun_image: "crazymax/diun:4.31.0"
zerobyte_image: "ghcr.io/nicotsx/zerobyte:v0.16"
```

---

## 3. Objectifs et Contraintes

### 3.1 Objectifs Day 1

| # | Objectif | Crit√®re de succ√®s |
|---|----------|-------------------|
| O1 | D√©ploiement automatis√© complet | `ansible-playbook site.yml` d√©ploie la stack enti√®re en < 20 min |
| O2 | 12 services op√©rationnels | Tous les healthchecks passent (HTTP 200 / TCP connect) |
| O3 | Backup automatis√© | Zerobyte ex√©cute un backup complet ‚Üí S3 avec succ√®s |
| O4 | Monitoring externe | Uptime Kuma (Seko-VPN) d√©tecte une panne simul√©e en < 5 min |
| O5 | S√©curit√© r√©seau | SSH VPN-only, admin UIs VPN-only, seul 80/443 public |
| O6 | CI/CD op√©rationnel | Push ‚Üí lint ‚Üí molecule test ‚Üí deploy preprod ‚Üí smoke tests |
| O7 | Config applicative | n8n + LiteLLM + OpenClaw configur√©s et fonctionnels |
| O8 | Documentation compl√®te | README, runbooks, architecture diagrams √† jour |

### 3.2 Contraintes

| Contrainte | D√©tail |
|------------|--------|
| Budget | VPS prod existant + S3 ‚Ç¨5.99/mois + preprod √©ph√©m√®re ~‚Ç¨3.49/mois |
| RAM | 8 GB maximum (prod), 4 GB (preprod) ‚Äî limites Docker obligatoires |
| Single node | Pas de clustering, pas de HA ‚Äî accept√© pour ce stade |
| Ansible only | Pas de Terraform, pas de Kubernetes ‚Äî Ansible + Docker Compose |
| Portabilit√© | Template wizard permet re-d√©ploiement sous autre nom/serveur |

### 3.3 Hors scope (Day 2+)

- NextCloud auto-h√©berg√© (futur remplacement S3 pour le stockage)
- Clustering / HA multi-nodes
- Terraform pour l'IaC cloud
- GPU / inf√©rence locale
- CDN / WAF externe

---

## 4. Architecture Fonctionnelle

### 4.1 Couches Applicatives

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     INTERNET (Ports 80/443)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FRONTEND NETWORK                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                ‚îÇ
‚îÇ  ‚îÇ   Caddy    ‚îÇ  ‚îÇ Grafana  ‚îÇ (dashboard public si souhait√©) ‚îÇ
‚îÇ  ‚îÇ TLS auto   ‚îÇ  ‚îÇ :3000    ‚îÇ                                ‚îÇ
‚îÇ  ‚îÇ Rate limit ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  BACKEND NETWORK (internal ‚Äî jamais expos√©)                  ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                    ‚îÇ
‚îÇ  ‚îÇ OpenClaw ‚îÇ ‚îÇ   n8n    ‚îÇ ‚îÇ LiteLLM  ‚îÇ  Applications      ‚îÇ
‚îÇ  ‚îÇ :8080    ‚îÇ ‚îÇ  :5678   ‚îÇ ‚îÇ  :4000   ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îÇ       ‚îÇ             ‚îÇ            ‚îÇ                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇPostgreSQL‚îÇ ‚îÇ  Redis   ‚îÇ ‚îÇ  Qdrant  ‚îÇ  Donn√©es           ‚îÇ
‚îÇ  ‚îÇ  :5432   ‚îÇ ‚îÇ  :6379   ‚îÇ ‚îÇ  :6333   ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MONITORING NETWORK (internal)                               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                   ‚îÇ
‚îÇ  ‚îÇ  Alloy   ‚îÇ‚Üí‚îÇVictoriaMetrics‚îÇ ‚îÇ Loki ‚îÇ  T√©l√©m√©trie       ‚îÇ
‚îÇ  ‚îÇ collector‚îÇ ‚îÇ   :8428       ‚îÇ ‚îÇ:3100 ‚îÇ                    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SYST√àME (host-level)                                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ  ‚îÇ DIUN ‚îÇ ‚îÇCrowdSec  ‚îÇ ‚îÇFail2ban  ‚îÇ ‚îÇUnattended ‚îÇ         ‚îÇ
‚îÇ  ‚îÇwatch ‚îÇ ‚îÇprotection‚îÇ ‚îÇ  SSH     ‚îÇ ‚îÇ Upgrades  ‚îÇ         ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  SEKO-VPN (serveur distant ‚Äî d√©j√† d√©ploy√©)                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îÇ
‚îÇ  ‚îÇ Headscale ‚îÇ ‚îÇUptime Kuma‚îÇ ‚îÇ Zerobyte ‚îÇ                  ‚îÇ
‚îÇ  ‚îÇ  VPN mesh ‚îÇ ‚îÇ monitoring‚îÇ ‚îÇ backup‚ÜíS3‚îÇ                  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 4.2 Mod√®le R√©seau & S√©curit√©

| Surface | Exposition | Protocole | Cible |
|---------|-----------|-----------|-------|
| Port 80 | üåê Public | HTTP ‚Üí redirect HTTPS | Caddy |
| Port 443 | üåê Public | HTTPS/TLS 1.3 | Caddy ‚Üí reverse proxy |
| Port SSH custom | üîí VPN only | SSH, bind sur IP Headscale | Host sshd |
| Admin UIs | üîí VPN only | HTTPS via Caddy ACL | n8n, Grafana, Zerobyte, OpenClaw |
| Inter-services | üîí Docker internal | TCP | R√©seaux Docker isol√©s |
| Backup | üîí VPN only | HTTPS (S3 API) | Zerobyte ‚Üí Hetzner S3 |
| Monitoring | üîí VPN only | HTTPS | Uptime Kuma ‚Üí healthchecks |

**Principe directeur** : Seul Caddy voit internet. Tout le reste est soit VPN-only, soit Docker-internal.

### 4.3 Flux de Donn√©es

```
[Utilisateur] ‚Üí HTTPS ‚Üí [Caddy :443]
    ‚îú‚îÄ‚îÄ /n8n/*        ‚Üí [n8n :5678]        (VPN ACL)
    ‚îú‚îÄ‚îÄ /grafana/*    ‚Üí [Grafana :3000]    (VPN ACL)
    ‚îú‚îÄ‚îÄ /openclaw/*   ‚Üí [OpenClaw :8080]   (VPN ACL)
    ‚îú‚îÄ‚îÄ /litellm/*    ‚Üí [LiteLLM :4000]    (API key auth)
    ‚îî‚îÄ‚îÄ /qdrant/*     ‚Üí [Qdrant :6333]     (VPN ACL)

[n8n] ‚Üê‚Üí [LiteLLM] ‚Üí [OpenAI / Anthropic / Ollama]
[n8n] ‚Üê‚Üí [OpenClaw] ‚Üê‚Üí [LiteLLM]
[n8n] ‚Üê‚Üí [PostgreSQL] (workflows, credentials)
[OpenClaw] ‚Üê‚Üí [PostgreSQL] + [Qdrant] + [Redis]
[Alloy] ‚Üí scrape all ‚Üí [VictoriaMetrics] (metrics)
[Alloy] ‚Üí collect all ‚Üí [Loki] (logs)
[Grafana] ‚Üê query ‚Üê [VictoriaMetrics] + [Loki]
[DIUN] ‚Üí watch images ‚Üí notification webhook
[Zerobyte@VPN] ‚Üí S3 backup (pg_dump, configs, volumes)
[Uptime Kuma@VPN] ‚Üí healthcheck endpoints ‚Üí alert si down
```

---

## 5. R√¥les Ansible ‚Äî Inventaire

| # | R√¥le | Responsabilit√© | Priorit√© |
|---|------|---------------|----------|
| 1 | `common` | Packages de base, locale, timezone, NTP | P0 |
| 2 | `hardening` | SSH custom port, Fail2ban, CrowdSec, UFW, sysctl | P0 |
| 3 | `docker` | Docker CE, Docker Compose plugin, daemon.json (log rotation) | P0 |
| 4 | `headscale-node` | Enregistrement node Tailscale/Headscale, VLAN config | P0 |
| 5 | `caddy` | Reverse proxy, TLS auto, rate limiting, ACL VPN | P0 |
| 6 | `postgresql` | PostgreSQL, init DB, pg_hba, tuning m√©moire | P0 |
| 7 | `redis` | Redis, auth, maxmemory, persistence | P0 |
| 8 | `qdrant` | Qdrant vector DB, API key, collections | P1 |
| 9 | `n8n` | n8n, config DB, encryption key, webhook URL | P0 |
| 10 | `openclaw` | OpenClaw, config agents/workspaces | P1 |
| 11 | `litellm` | LiteLLM proxy, routes mod√®les, budgets, callbacks | P0 |
| 12 | `monitoring` | VictoriaMetrics + Loki + Alloy + Grafana dashboards | P1 |
| 13 | `diun` | Image watcher, notifications webhook | P2 |
| 14 | `backup-config` | Config Zerobyte c√¥t√© Seko-VPN (volumes, repos, jobs) | P1 |
| 15 | `uptime-config` | Config Uptime Kuma c√¥t√© Seko-VPN (monitors) | P1 |
| 16 | `smoke-tests` | Tests de fum√©e post-d√©ploiement (healthchecks, API calls) | P0 |

---

## 6. Pipeline CI/CD

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Push   ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Lint    ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Molecule ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Deploy  ‚îÇ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Smoke   ‚îÇ
‚îÇ  main    ‚îÇ    ‚îÇ yamllint ‚îÇ    ‚îÇ  Test    ‚îÇ    ‚îÇ Preprod  ‚îÇ    ‚îÇ  Tests   ‚îÇ
‚îÇ          ‚îÇ    ‚îÇ ansible- ‚îÇ    ‚îÇ Docker   ‚îÇ    ‚îÇ Hetzner  ‚îÇ    ‚îÇ HTTP/API ‚îÇ
‚îÇ          ‚îÇ    ‚îÇ lint     ‚îÇ    ‚îÇ in Docker‚îÇ    ‚îÇ ephemeral‚îÇ    ‚îÇ          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                      ‚îÇ
                                                      ‚ñº
                                                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                ‚îÇ  Soak    ‚îÇ
                                                ‚îÇ  48h     ‚îÇ
                                                ‚îÇ monitoring‚îÇ
                                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                      ‚îÇ (manuel)
                                                      ‚ñº
                                                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                                ‚îÇ  Deploy  ‚îÇ
                                                ‚îÇ  Prod    ‚îÇ
                                                ‚îÇ  --diff  ‚îÇ
                                                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 7. Strat√©gie Backup

| Composant | Source | M√©thode | R√©tention | Cible |
|-----------|--------|---------|-----------|-------|
| PostgreSQL | `pg_dump --format=custom` | Zerobyte job (daily 3h) | 7d, 4w, 3m | S3 Hetzner fsn1 |
| Redis | RDB snapshot | Zerobyte job (daily 3h) | 7d | S3 Hetzner fsn1 |
| Qdrant | API snapshot | Zerobyte job (daily 3h15) | 7d, 4w | S3 Hetzner fsn1 |
| n8n | Export workflows JSON | Zerobyte job (daily 3h) | 7d, 4w, 3m | S3 Hetzner fsn1 |
| Grafana | Dashboards + datasources | Zerobyte job (weekly dim 3h) | 4w | S3 Hetzner fsn1 |
| Configs | /opt/{{ project_name }}/ | Zerobyte job (daily 3h30) | 7d, 4w | S3 Hetzner fsn1 |

**Orchestrateur** : Zerobyte sur Seko-VPN, acc√®s via r√©seau Headscale.  
**Test de restauration** : Obligatoire en pr√©-prod avant mise en production.

---

## 8. Monitoring Externe

| Check | Type | Fr√©quence | Seuil alerte | Outil |
|-------|------|-----------|-------------|-------|
| Caddy HTTPS | HTTP(S) | 60s | 2 √©checs cons√©cutifs | Uptime Kuma |
| n8n healthcheck | HTTP | 60s | 3 √©checs | Uptime Kuma |
| PostgreSQL | TCP :5432 via VPN | 120s | 2 √©checs | Uptime Kuma |
| Grafana | HTTP | 120s | 3 √©checs | Uptime Kuma |
| Certificat TLS | TLS expiry | 24h | < 14 jours | Uptime Kuma |
| Backup Zerobyte | Heartbeat | 24h | Manqu√© 1x | Uptime Kuma |

---

## 9. Crit√®res d'Acceptation (Definition of Done)

### Phase Pr√©-production
- [ ] Tous les 16 r√¥les Ansible s'ex√©cutent sans erreur
- [ ] Idempotence : 2√®me ex√©cution = 0 changed
- [ ] 12 containers en √©tat `healthy` ou `running`
- [ ] SSH uniquement via Headscale VPN (port custom)
- [ ] Admin UIs accessibles uniquement via VPN
- [ ] Ports 80/443 r√©pondent avec TLS valide
- [ ] Backup Zerobyte ex√©cut√© et v√©rifi√©
- [ ] Restauration test√©e depuis le backup
- [ ] Uptime Kuma d√©tecte une panne simul√©e
- [ ] Smoke tests passent (HTTP + API + DB connectivity)
- [ ] 48h de soak sans incident

### Phase Production
- [ ] Backup complet de l'existant avant d√©ploiement
- [ ] D√©ploiement via `ansible-playbook site.yml --diff`
- [ ] Tous les crit√®res pr√©-prod valid√©s en prod
- [ ] Monitoring 24h post-d√©ploiement sans alerte
- [ ] Documentation √† jour (README, runbooks, architecture)

---

## 10. Risques et Mitigations

| Risque | Probabilit√© | Impact | Mitigation |
|--------|-------------|--------|------------|
| PostgreSQL 18.1 (major upgrade) | Moyenne | √âlev√© | Test pg_upgrade en preprod, backup avant migration |
| Redis 8.0 (major upgrade) | Moyenne | Moyen | Test compatibilit√© clients, fallback 7.x pr√™t |
| VictoriaMetrics non-LTS | Faible | Faible | Monitoring 48h, rollback vers LTS si instable |
| OOM sur 8GB RAM | Moyenne | √âlev√© | Limites Docker strictes, alertes Grafana √† 80% |
| Perte donn√©es S3 | Tr√®s faible | Critique | Backup rule 3-2-1, test restore mensuel |
| Zerobyte 0.x (early stage) | Moyenne | Moyen | Fallback Restic CLI si Zerobyte instable |

---

## 11. Livrables Attendus

| # | Livrable | Format | Responsable |
|---|----------|--------|-------------|
| L1 | Repository Ansible complet | Git | Claude Code |
| L2 | 16 r√¥les avec Molecule tests | YAML | Claude Code |
| L3 | GitHub Actions CI/CD pipeline | YAML | Claude Code |
| L4 | Docker Compose templatis√© | Jinja2 | Claude Code |
| L5 | Caddyfile templatis√© | Jinja2 | Claude Code |
| L6 | Documentation technique | Markdown | Claude Code |
| L7 | Runbooks op√©rationnels | Markdown | Claude Code |
| L8 | Config LiteLLM (routes, budgets) | YAML | Claude Code |
| L9 | Smoke tests automatis√©s | Shell/Python | Claude Code |
| L10 | Ce PRD valid√© | Markdown | Opus 4.6 review |

---

## 12. Planning

| Phase | Dur√©e estim√©e | Contenu |
|-------|--------------|---------|
| Phase 0 ‚Äî Quick Wins | 2h | Log rotation, restart policies, unattended-upgrades |
| Phase 1 ‚Äî S√©curit√© | 4h | Docker limits, network segmentation, Fail2ban, SSH hardening |
| Phase 2 ‚Äî Backup | 6h | S3 bucket, Zerobyte config, cron, test restore |
| Phase 3 ‚Äî Pr√©-prod | 2-3 jours | Hetzner VM, OVH DNS, deploy, golden snapshot, smoke tests, soak 48h |
| Phase 4 ‚Äî Production | 1 jour | Backup existant, deploy --diff, smoke tests, monitoring 24h |
| Phase 5 ‚Äî Continuous | Continu | Trivy CI, CrowdSec, Grafana alerts, secrets rotation |

---

*Fin du PRD ‚Äî Document de r√©f√©rence pour le d√©veloppement du projet.*
