{
  "__inputs": [
    { "name": "DS_POSTGRESQL", "label": "PostgreSQL", "type": "datasource", "pluginId": "postgres" },
    { "name": "DS_VICTORIAMETRICS", "label": "VictoriaMetrics", "type": "datasource", "pluginId": "prometheus" }
  ],
  "__requires": [
    { "type": "grafana", "id": "grafana", "name": "Grafana", "version": "10.0.0" },
    { "type": "datasource", "id": "postgres", "name": "PostgreSQL", "version": "1.0.0" },
    { "type": "datasource", "id": "prometheus", "name": "Prometheus", "version": "1.0.0" },
    { "type": "panel", "id": "gauge", "name": "Gauge", "version": "" },
    { "type": "panel", "id": "stat", "name": "Stat", "version": "" },
    { "type": "panel", "id": "timeseries", "name": "Time series", "version": "" },
    { "type": "panel", "id": "table", "name": "Table", "version": "" },
    { "type": "panel", "id": "bargauge", "name": "Bar gauge", "version": "" }
  ],
  "description": "Budget IA — LiteLLM spending by provider, model, and agent",
  "editable": true,
  "graphTooltip": 1,
  "id": null,
  "links": [],
  "panels": [
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "id": 100,
      "title": "Budget Global — 24h",
      "type": "row"
    },
    {
      "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "unit": "currencyUSD",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 3.5 },
              { "color": "orange", "value": 4.5 },
              { "color": "red", "value": 5 }
            ]
          },
          "max": 5,
          "min": 0
        }
      },
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 1 },
      "id": 101,
      "options": {
        "orientation": "auto",
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "showThresholdLabels": true,
        "showThresholdMarkers": true
      },
      "title": "Dépense Globale 24h / $5.00",
      "type": "gauge",
      "targets": [
        {
          "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
          "rawSql": "SELECT COALESCE(SUM(spend), 0) AS value FROM litellm_spendlogs WHERE startTime >= NOW() - INTERVAL '24 hours' AND metadata->>'user_api_key' != 'litellm-internal-health-check';",
          "format": "time_series"
        }
      ]
    },
    {
      "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "unit": "currencyUSD",
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 0.5 },
              { "color": "red", "value": 0.8 }
            ]
          }
        }
      },
      "gridPos": { "h": 6, "w": 18, "x": 6, "y": 1 },
      "id": 102,
      "options": {
        "orientation": "horizontal",
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "showUnfilled": true,
        "valueMode": "color"
      },
      "title": "Dépense par Provider (24h)",
      "type": "bargauge",
      "targets": [
        {
          "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
          "rawSql": "SELECT\n  CASE\n    WHEN model LIKE 'anthropic/%' OR model LIKE 'claude%' THEN 'Anthropic'\n    WHEN model LIKE 'openai/%' OR model LIKE 'gpt%' OR model LIKE 'codex%' THEN 'OpenAI'\n    WHEN model LIKE 'openrouter/%' THEN 'OpenRouter'\n    WHEN model LIKE 'gemini/%' OR model LIKE 'veo%' THEN 'Google'\n    ELSE 'Other'\n  END AS metric,\n  NOW() AS time,\n  COALESCE(SUM(spend), 0) AS value\nFROM litellm_spendlogs\nWHERE startTime >= NOW() - INTERVAL '24 hours'\n  AND metadata->>'user_api_key' != 'litellm-internal-health-check'\nGROUP BY 1;",
          "format": "time_series"
        }
      ]
    },
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 7 },
      "id": 200,
      "title": "Dépense dans le temps",
      "type": "row"
    },
    {
      "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "unit": "currencyUSD",
          "custom": { "fillOpacity": 20, "lineWidth": 2 }
        }
      },
      "gridPos": { "h": 8, "w": 24, "x": 0, "y": 8 },
      "id": 201,
      "options": {
        "legend": { "calcs": ["sum", "mean"], "displayMode": "table", "placement": "right" },
        "tooltip": { "mode": "multi", "sort": "desc" }
      },
      "title": "Dépense cumulée par provider (7 jours)",
      "type": "timeseries",
      "targets": [
        {
          "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
          "rawSql": "SELECT\n  DATE_TRUNC('hour', startTime) AS time,\n  CASE\n    WHEN model LIKE 'anthropic/%' OR model LIKE 'claude%' THEN 'Anthropic'\n    WHEN model LIKE 'openai/%' OR model LIKE 'gpt%' THEN 'OpenAI'\n    WHEN model LIKE 'openrouter/%' THEN 'OpenRouter'\n    ELSE 'Other'\n  END AS metric,\n  SUM(spend) AS value\nFROM litellm_spendlogs\nWHERE startTime >= NOW() - INTERVAL '7 days'\n  AND metadata->>'user_api_key' != 'litellm-internal-health-check'\nGROUP BY 1, 2\nORDER BY 1;",
          "format": "time_series"
        }
      ]
    },
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 16 },
      "id": 300,
      "title": "Top Modèles & Assets",
      "type": "row"
    },
    {
      "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
      "fieldConfig": {
        "defaults": { "unit": "currencyUSD" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Requêtes" }, "properties": [ { "id": "unit", "value": "short" } ] }
        ]
      },
      "gridPos": { "h": 8, "w": 12, "x": 0, "y": 17 },
      "id": 301,
      "options": {
        "footer": { "fields": "", "reducer": ["sum"], "show": true },
        "sortBy": [{ "desc": true, "displayName": "Coût total" }]
      },
      "title": "Top 10 Modèles par coût (7j)",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
          "rawSql": "SELECT\n  model AS \"Modèle\",\n  COUNT(*) AS \"Requêtes\",\n  ROUND(SUM(spend)::numeric, 4) AS \"Coût total\",\n  ROUND(AVG(spend)::numeric, 6) AS \"Coût moyen\"\nFROM litellm_spendlogs\nWHERE startTime >= NOW() - INTERVAL '7 days'\n  AND metadata->>'user_api_key' != 'litellm-internal-health-check'\nGROUP BY model\nORDER BY SUM(spend) DESC\nLIMIT 10;",
          "format": "table"
        }
      ]
    },
    {
      "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
      "fieldConfig": {
        "defaults": { "unit": "currencyUSD" },
        "overrides": [
          { "matcher": { "id": "byName", "options": "Assets" }, "properties": [ { "id": "unit", "value": "short" } ] }
        ]
      },
      "gridPos": { "h": 8, "w": 12, "x": 12, "y": 17 },
      "id": 302,
      "options": {
        "footer": { "fields": "", "reducer": ["sum"], "show": true },
        "sortBy": [{ "desc": true, "displayName": "Coût total" }]
      },
      "title": "Coût Assets Générés par provider (7j)",
      "type": "table",
      "targets": [
        {
          "datasource": { "type": "postgres", "uid": "${DS_POSTGRESQL}" },
          "rawSql": "SELECT\n  provider AS \"Provider\",\n  type AS \"Type\",\n  COUNT(*) AS \"Assets\",\n  ROUND(SUM(cost_usd)::numeric, 4) AS \"Coût total\",\n  ROUND(AVG(cost_usd)::numeric, 6) AS \"Coût moyen\"\nFROM asset_provenance\nWHERE generated_at >= NOW() - INTERVAL '7 days'\nGROUP BY provider, type\nORDER BY SUM(cost_usd) DESC;",
          "format": "table"
        }
      ]
    }
  ],
  "refresh": "5m",
  "schemaVersion": 38,
  "tags": ["budget", "ai", "litellm", "finance"],
  "templating": { "list": [] },
  "time": { "from": "now-24h", "to": "now" },
  "timepicker": {},
  "timezone": "browser",
  "title": "Budget IA",
  "uid": "budget-ai",
  "version": 1
}
