-- {{ ansible_managed }}
-- PostgreSQL init script

{% for db in postgresql_databases %}
CREATE DATABASE {{ db.name }};
CREATE USER {{ db.user }} WITH ENCRYPTED PASSWORD '{{ postgresql_password }}';
GRANT ALL PRIVILEGES ON DATABASE {{ db.name }} TO {{ db.user }};
ALTER DATABASE {{ db.name }} OWNER TO {{ db.user }};

\c {{ db.name }}
{% for ext in db.extensions %}
CREATE EXTENSION IF NOT EXISTS "{{ ext }}";
{% endfor %}
GRANT ALL ON SCHEMA public TO {{ db.user }};

{% endfor %}

-- Plane production database (for fresh PostgreSQL deployments only)
-- On existing containers, this is provisioned via docker exec task
CREATE DATABASE plane_production;
CREATE USER plane WITH ENCRYPTED PASSWORD '{{ postgresql_password }}';
GRANT ALL PRIVILEGES ON DATABASE plane_production TO plane;
ALTER DATABASE plane_production OWNER TO plane;
\c plane_production
GRANT ALL ON SCHEMA public TO plane;
