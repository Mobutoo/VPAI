---
# playbooks/workstation.yml â€” Deploiement Workstation Pi
#
# Usage:
#   ansible-playbook playbooks/workstation.yml
#   ansible-playbook playbooks/workstation.yml --tags "opencode"
#   ansible-playbook playbooks/workstation.yml --tags "claude-code"
#   ansible-playbook playbooks/workstation.yml --tags "codex-cli"
#   ansible-playbook playbooks/workstation.yml --tags "gemini-cli"
#   ansible-playbook playbooks/workstation.yml --tags "comfyui"
#   ansible-playbook playbooks/workstation.yml --tags "remotion"
#   ansible-playbook playbooks/workstation.yml --tags "opencut"
#   ansible-playbook playbooks/workstation.yml --tags "workstation-caddy"
#
# Prerequis :
#   - Pi boothe sous Ubuntu Server 24.04 LTS ARM64
#   - SSH accessible via LAN (192.168.1.8)
#   - workstation_pi_ip defini dans vault (vault_workstation_pi_ip)
#   - headscale_auth_key valide dans vault (cle preauth Headscale)

- name: Deploy Workstation Pi
  hosts: workstation
  gather_facts: true

  pre_tasks:
    - name: Display deployment info
      ansible.builtin.debug:
        msg: |
          ========================================
          Workstation: {{ inventory_hostname }}
          Date: {{ ansible_facts['date_time']['iso8601'] }}
          ========================================
      tags: [always]

    - name: Verify ARM64 architecture
      ansible.builtin.assert:
        that:
          - ansible_facts['architecture'] == 'aarch64'
        fail_msg: >-
          This playbook is for ARM64 (Raspberry Pi).
          Current: {{ ansible_facts['architecture'] }}
      tags: [always]

    - name: Verify Ubuntu 24.04
      ansible.builtin.assert:
        that:
          - ansible_facts['distribution'] == 'Ubuntu'
          - ansible_facts['distribution_major_version'] | int >= 24
        fail_msg: >-
          This playbook requires Ubuntu 24.04+.
          Current: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}
      tags: [always]

  roles:
    - role: workstation-common
      tags: [workstation-common]

    - role: headscale-node
      tags: [headscale-node]
      vars:
        headscale_hostname: "{{ workstation_pi_hostname }}"

    - role: opencode
      tags: [opencode]

    - role: claude-code
      tags: [claude-code]

    - role: codex-cli
      tags: [codex-cli]

    - role: gemini-cli
      tags: [gemini-cli]

    - role: comfyui
      tags: [comfyui]

    - role: remotion
      tags: [remotion]

    - role: opencut
      tags: [opencut]

    - role: workstation-caddy
      tags: [workstation-caddy]

    - role: workstation-monitoring
      tags: [workstation-monitoring]

    - role: obsidian-collector-pi
      tags: [obsidian-collector-pi]
