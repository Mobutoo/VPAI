{
    admin localhost:{{ workstation_caddy_admin_port }}

    servers {
        trusted_proxies static private_ranges
    }
}

# OpenCode Server
{{ workstation_oc_domain }} {
    tls {
        # DNS-01 via OVH + bypass systemd-resolved (NOTIMP sur requêtes NS/SOA)
        dns ovh {
            endpoint {{ ovh_endpoint }}
            application_key {env.OVH_APPLICATION_KEY}
            application_secret {env.OVH_APPLICATION_SECRET}
            consumer_key {env.OVH_CONSUMER_KEY}
        }
        resolvers 8.8.8.8 1.1.1.1
    }

    reverse_proxy localhost:{{ opencode_port | default(3456) }}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        -Server
    }
}

# ComfyUI — AI image generation (CPU-only, Docker)
{% if comfyui_subdomain | default('') | length > 0 %}
{{ comfyui_subdomain }}.{{ domain_name }} {
    tls {
        dns ovh {
            endpoint {{ ovh_endpoint }}
            application_key {env.OVH_APPLICATION_KEY}
            application_secret {env.OVH_APPLICATION_SECRET}
            consumer_key {env.OVH_CONSUMER_KEY}
        }
        resolvers 8.8.8.8 1.1.1.1
    }

    reverse_proxy localhost:{{ comfyui_port | default(8188) }}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        -Server
    }
}
{% endif %}

# Remotion — Video rendering server (Docker)
{% if remotion_subdomain | default('') | length > 0 %}
{{ remotion_subdomain }}.{{ domain_name }} {
    tls {
        dns ovh {
            endpoint {{ ovh_endpoint }}
            application_key {env.OVH_APPLICATION_KEY}
            application_secret {env.OVH_APPLICATION_SECRET}
            consumer_key {env.OVH_CONSUMER_KEY}
        }
        resolvers 8.8.8.8 1.1.1.1
    }

    reverse_proxy localhost:{{ remotion_port | default(3200) }}

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains"
        X-Content-Type-Options "nosniff"
        -Server
    }
}
{% endif %}
