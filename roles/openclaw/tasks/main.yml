---
# openclaw — tasks
# OpenClaw is a personal AI assistant Gateway (WebSocket on port 18789)
# It does NOT use PostgreSQL/Redis/Qdrant directly — it's file-based
# Models are routed through LiteLLM proxy via models.providers config
#
# Volume isolation (moltworker pattern):
#   system/  (ro) — openclaw.json, agents/, skills/ (immutable at runtime)
#   workspace/ (rw) — user livrables (books, prospection, output)
#   state/ (rw) — sessions, canvas, cron, memory (runtime data)

- name: Create OpenClaw config directory
  ansible.builtin.file:
    path: "{{ openclaw_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

# --- Volume Isolation: 3-layer directory structure ---
- name: Create OpenClaw system directory (immutable at runtime)
  ansible.builtin.file:
    path: "{{ openclaw_system_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  when: openclaw_volume_isolation | default(false)

- name: Create OpenClaw system subdirectories
  ansible.builtin.file:
    path: "{{ openclaw_system_dir }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop:
    - agents
    - skills
    - plugins
  when: openclaw_volume_isolation | default(false)

- name: Create OpenClaw workspace directory (user livrables)
  ansible.builtin.file:
    path: "{{ openclaw_workspace_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  when: openclaw_volume_isolation | default(false)

- name: Create OpenClaw workspace subdirectories
  ansible.builtin.file:
    path: "{{ openclaw_workspace_dir }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop: "{{ openclaw_workspace_subdirs }}"
  when: openclaw_volume_isolation | default(false)

- name: Create OpenClaw state directory (runtime data)
  ansible.builtin.file:
    path: "{{ openclaw_state_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  when: openclaw_volume_isolation | default(false)

- name: Create OpenClaw state subdirectories
  ansible.builtin.file:
    path: "{{ openclaw_state_dir }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop: "{{ openclaw_state_subdirs }}"
  when: openclaw_volume_isolation | default(false)

# --- Legacy flat layout (fallback when isolation disabled) ---
- name: Create OpenClaw flat data directory (legacy)
  ansible.builtin.file:
    path: "{{ openclaw_data_dir }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  when: not (openclaw_volume_isolation | default(false))

- name: Create OpenClaw flat subdirectories (legacy)
  ansible.builtin.file:
    path: "{{ openclaw_data_dir }}/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop:
    - workspace
    - canvas
    - cron
  when: not (openclaw_volume_isolation | default(false))

# --- Migration: flat -> 3-layer (one-shot, non-destructive) ---
# Copies data from old flat layout to new structure if old dir exists
# Old directory is NOT deleted (safe rollback)
- name: Check if legacy flat OpenClaw data exists
  ansible.builtin.stat:
    path: "{{ openclaw_data_dir }}/openclaw.json"
  register: openclaw_legacy_check
  become: true
  when: openclaw_volume_isolation | default(false)

- name: Migrate legacy OpenClaw data to isolated layout
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      SRC="{{ openclaw_data_dir }}"
      SYS="{{ openclaw_system_dir }}"
      WRK="{{ openclaw_workspace_dir }}"
      STA="{{ openclaw_state_dir }}"

      MIGRATED=0

      # Migrate system files (config, agents, skills)
      for item in openclaw.json agents skills plugins; do
        if [ -e "${SRC}/${item}" ] && [ ! -e "${SYS}/${item}" ]; then
          cp -a "${SRC}/${item}" "${SYS}/${item}"
          MIGRATED=1
        fi
      done

      # Migrate workspace content
      if [ -d "${SRC}/workspace" ]; then
        cp -a "${SRC}/workspace/"* "${WRK}/" 2>/dev/null || true
        MIGRATED=1
      fi

      # Migrate state directories
      for item in sessions canvas cron memory; do
        if [ -d "${SRC}/${item}" ] && [ ! -d "${STA}/${item}" ]; then
          mkdir -p "${STA}/${item}"
          cp -a "${SRC}/${item}/"* "${STA}/${item}/" 2>/dev/null || true
          MIGRATED=1
        fi
      done

      # Fix ownership
      chown -R 1000:1000 "${SYS}" "${WRK}" "${STA}"

      if [ "${MIGRATED}" -eq 1 ]; then
        echo "MIGRATED"
      else
        echo "NOTHING_TO_MIGRATE"
      fi
  become: true
  register: openclaw_migration
  changed_when: "'MIGRATED' in openclaw_migration.stdout"
  when:
    - openclaw_volume_isolation | default(false)
    - openclaw_legacy_check.stat.exists | default(false)

- name: Show OpenClaw migration result
  ansible.builtin.debug:
    msg: "OpenClaw migration: {{ openclaw_migration.stdout | default('skipped') }}"
  when:
    - openclaw_volume_isolation | default(false)
    - openclaw_migration is not skipped

# --- Deploy configurations ---
- name: Deploy OpenClaw Gateway configuration (openclaw.json)
  ansible.builtin.template:
    src: openclaw.json.j2
    dest: "{{ openclaw_system_dir if (openclaw_volume_isolation | default(false)) else openclaw_data_dir }}/openclaw.json"
    owner: "1000"
    group: "1000"
    mode: "0600"
  become: true
  notify: Restart openclaw stack

# Create agent directories in system/ for persona files
- name: Create agent persona directories
  ansible.builtin.file:
    path: "{{ openclaw_system_dir }}/agents/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop:
    - "{{ openclaw_agent_concierge_name }}"
    - "{{ openclaw_agent_builder_name }}"
    - "{{ openclaw_agent_writer_name }}"
    - "{{ openclaw_agent_artist_name }}"
    - "{{ openclaw_agent_tutor_name }}"
    - "{{ openclaw_agent_explorer_name }}"
    - "{{ openclaw_agent_cfo_name }}"
    - "{{ openclaw_agent_maintainer_name }}"
    - "{{ openclaw_agent_messenger_name }}"
    - "{{ openclaw_agent_marketer_name }}"
  when: openclaw_volume_isolation | default(false)

# Deploy agent IDENTITY.md files (only with volume isolation)
- name: Deploy agent persona files
  ansible.builtin.template:
    src: "agents/{{ item }}/IDENTITY.md.j2"
    dest: "{{ openclaw_system_dir }}/agents/{{ item }}/IDENTITY.md"
    owner: "1000"
    group: "1000"
    mode: "0644"
  become: true
  loop:
    - "{{ openclaw_agent_concierge_name }}"
    - "{{ openclaw_agent_builder_name }}"
    - "{{ openclaw_agent_writer_name }}"
    - "{{ openclaw_agent_artist_name }}"
    - "{{ openclaw_agent_tutor_name }}"
    - "{{ openclaw_agent_explorer_name }}"
    - "{{ openclaw_agent_cfo_name }}"
    - "{{ openclaw_agent_maintainer_name }}"
    - "{{ openclaw_agent_messenger_name }}"
    - "{{ openclaw_agent_marketer_name }}"
  when: openclaw_volume_isolation | default(false)
  notify: Restart openclaw stack

# Deploy concierge IDENTITY.md to workspace root
# OpenClaw injects workspace/IDENTITY.md into the system prompt for the default agent.
# agents/<id>/IDENTITY.md is only used for subagent spawn contexts.
- name: Deploy concierge persona to workspace root
  ansible.builtin.template:
    src: "agents/{{ openclaw_agent_concierge_name }}/IDENTITY.md.j2"
    dest: "{{ openclaw_workspace_dir }}/IDENTITY.md"
    owner: "1000"
    group: "1000"
    mode: "0644"
  become: true
  when: openclaw_volume_isolation | default(false)
  notify: Restart openclaw stack

# Deploy HEARTBEAT.md to workspace root
# OpenClaw reads workspace/HEARTBEAT.md on each heartbeat activation.
- name: Deploy heartbeat instructions to workspace root
  ansible.builtin.template:
    src: "HEARTBEAT.md.j2"
    dest: "{{ openclaw_workspace_dir }}/HEARTBEAT.md"
    owner: "1000"
    group: "1000"
    mode: "0644"
  become: true
  when: openclaw_volume_isolation | default(false)
  notify: Restart openclaw stack

# Deploy skill directories (OpenClaw expects skills/<name>/SKILL.md)
- name: Create OpenClaw skill directories
  ansible.builtin.file:
    path: "{{ openclaw_system_dir }}/skills/{{ item }}"
    state: directory
    owner: "1000"
    group: "1000"
    mode: "0755"
  become: true
  loop: "{{ openclaw_skills }}"
  when:
    - openclaw_volume_isolation | default(false)
    - openclaw_n8n_integration | default(false)

- name: Deploy OpenClaw skill files
  ansible.builtin.template:
    src: "skills/{{ item }}/SKILL.md.j2"
    dest: "{{ openclaw_system_dir }}/skills/{{ item }}/SKILL.md"
    owner: "1000"
    group: "1000"
    mode: "0644"
  become: true
  loop: "{{ openclaw_skills }}"
  when:
    - openclaw_volume_isolation | default(false)
    - openclaw_n8n_integration | default(false)
  notify: Restart openclaw stack

- name: Clean up legacy flat skill files
  ansible.builtin.file:
    path: "{{ openclaw_system_dir }}/skills/{{ item }}.md"
    state: absent
  become: true
  loop: "{{ openclaw_skills }}"
  when:
    - openclaw_volume_isolation | default(false)
    - openclaw_n8n_integration | default(false)

- name: Deploy OpenClaw environment file
  ansible.builtin.template:
    src: openclaw.env.j2
    dest: "{{ openclaw_config_dir }}/openclaw.env"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0600"
  become: true
  notify: Restart openclaw stack

# --- Build openclaw-sandbox image ---
# OpenClaw uses dockerode (HTTP REST via /var/run/docker.sock) to spawn sandbox containers.
# The sandbox image must be pre-built on the host; it is embedded as Dockerfile.sandbox
# inside the openclaw main image (ghcr.io/openclaw/openclaw). The sandbox image itself
# is NOT available as a standalone pull — it must be extracted and built locally.
# REX-49: "spawn docker EACCES" when subagents are launched = this image is missing.
- name: Check if openclaw-sandbox image already exists
  ansible.builtin.command:
    cmd: docker image inspect {{ openclaw_sandbox_image }}
  register: openclaw_sandbox_image_check
  changed_when: false
  failed_when: false
  become: true
  when: openclaw_sandbox_mode | default('non-main') != 'off'

- name: Check if sandbox has required extra packages
  ansible.builtin.command:
    cmd: docker run --rm {{ openclaw_sandbox_image }} which redis-cli
  register: openclaw_sandbox_tools_check
  changed_when: false
  failed_when: false
  become: true
  when:
    - openclaw_sandbox_mode | default('non-main') != 'off'
    - openclaw_sandbox_image_check.rc | default(0) == 0
    - openclaw_sandbox_extra_packages | default([]) | length > 0

- name: Determine if sandbox build is needed
  ansible.builtin.set_fact:
    openclaw_sandbox_needs_build: >-
      {{ (openclaw_sandbox_image_check.rc | default(0) != 0)
         or (openclaw_sandbox_tools_check.rc | default(0) != 0) }}
  when: openclaw_sandbox_mode | default('non-main') != 'off'

- name: Create openclaw-sandbox build directory
  ansible.builtin.file:
    path: "{{ openclaw_config_dir }}/build/openclaw-sandbox"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when:
    - openclaw_sandbox_mode | default('non-main') != 'off'
    - openclaw_sandbox_needs_build | default(false) | bool

- name: Extract Dockerfile.sandbox from openclaw image
  ansible.builtin.command:
    cmd: >
      docker run --rm --entrypoint cat
      {{ openclaw_image }} /app/Dockerfile.sandbox
  register: openclaw_dockerfile_sandbox
  changed_when: false
  failed_when: >
    openclaw_dockerfile_sandbox.rc != 0
    or openclaw_dockerfile_sandbox.stdout | length == 0
  become: true
  when:
    - openclaw_sandbox_mode | default('non-main') != 'off'
    - openclaw_sandbox_needs_build | default(false) | bool

- name: Write Dockerfile.sandbox to build directory
  ansible.builtin.copy:
    content: "{{ openclaw_dockerfile_sandbox.stdout }}"
    dest: "{{ openclaw_config_dir }}/build/openclaw-sandbox/Dockerfile"
    owner: root
    group: root
    mode: "0644"
  become: true
  when:
    - openclaw_sandbox_mode | default('non-main') != 'off'
    - openclaw_sandbox_needs_build | default(false) | bool

- name: Append extra packages to Dockerfile.sandbox
  ansible.builtin.blockinfile:
    path: "{{ openclaw_config_dir }}/build/openclaw-sandbox/Dockerfile"
    marker: "# {mark} ANSIBLE MANAGED — extra sandbox packages"
    block: |
      USER root
      RUN apt-get update && apt-get install -y --no-install-recommends \
          {{ openclaw_sandbox_extra_packages | join(' ') }} \
       && rm -rf /var/lib/apt/lists/*
      USER sandbox
  become: true
  when:
    - openclaw_sandbox_mode | default('non-main') != 'off'
    - openclaw_sandbox_needs_build | default(false) | bool
    - openclaw_sandbox_extra_packages | default([]) | length > 0

- name: Build openclaw-sandbox image from embedded Dockerfile
  community.docker.docker_image:
    name: "{{ openclaw_sandbox_image.split(':')[0] }}"
    tag: "{{ openclaw_sandbox_image.split(':')[1] }}"
    build:
      path: "{{ openclaw_config_dir }}/build/openclaw-sandbox"
      pull: false
    source: build
    force_source: "{{ openclaw_sandbox_tools_check.rc | default(0) != 0 }}"
  become: true
  when:
    - openclaw_sandbox_mode | default('non-main') != 'off'
    - openclaw_sandbox_needs_build | default(false) | bool
