---
# postgresql — tasks

- name: Create PostgreSQL config directory
  ansible.builtin.file:
    path: "{{ postgresql_config_dir }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Create PostgreSQL data directory
  ansible.builtin.file:
    path: "{{ postgresql_data_dir }}"
    state: directory
    owner: "999"
    group: "999"
    mode: "0700"
  become: true

- name: Deploy PostgreSQL init script
  ansible.builtin.template:
    src: init.sql.j2
    dest: "{{ postgresql_config_dir }}/init.sql"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0644"
  become: true

- name: Deploy pg_hba.conf
  ansible.builtin.template:
    src: pg_hba.conf.j2
    dest: "{{ postgresql_config_dir }}/pg_hba.conf"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0644"
  become: true
  notify: Restart postgresql stack

- name: Deploy postgresql.conf
  ansible.builtin.template:
    src: postgresql.conf.j2
    dest: "{{ postgresql_config_dir }}/postgresql.conf"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0644"
  become: true
  notify: Restart postgresql stack

# --- Migrations (idempotent via IF NOT EXISTS) ---
- name: Create migrations directory on server
  ansible.builtin.file:
    path: "{{ postgresql_config_dir }}/migrations"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Copy SQL migration files to server
  ansible.builtin.copy:
    src: "migrations/{{ item }}"
    dest: "{{ postgresql_config_dir }}/migrations/{{ item }}"
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0644"
  become: true
  loop:
    - 001_asset_provenance.sql

- name: Apply SQL migrations (idempotent)
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      FILE="{{ postgresql_config_dir }}/migrations/{{ item }}"
      MD5_FILE="{{ postgresql_config_dir }}/migrations/{{ item }}.applied"
      NEW_MD5=$(md5sum "$FILE" | cut -d' ' -f1)

      if [ -f "$MD5_FILE" ] && [ "$(cat "$MD5_FILE")" = "$NEW_MD5" ]; then
        echo "UNCHANGED: {{ item }}"
        exit 0
      fi

      # REX: passer le SQL via stdin (docker exec -i) — pas besoin de monter
      # le dossier migrations dans le container. Le fichier reste sur l'hôte.
      docker exec -i {{ project_name }}_postgresql \
        psql -U postgres -d postgres \
        < "$FILE" 2>&1

      echo "$NEW_MD5" > "$MD5_FILE"
      echo "APPLIED: {{ item }}"
  become: true
  register: postgresql_migration_result
  changed_when: "'APPLIED:' in postgresql_migration_result.stdout"
  failed_when:
    - postgresql_migration_result.rc != 0
    - >-
      'already exists' not in (postgresql_migration_result.stderr | default(''))
      and 'already exists' not in (postgresql_migration_result.stdout | default(''))
    - >-
      'No such container' not in (postgresql_migration_result.stderr | default(''))
      and 'No such container' not in (postgresql_migration_result.stdout | default(''))
  loop:
    - 001_asset_provenance.sql

# --- Plane Database Provisioning (on existing container) ---
# CRITICAL: init.sql.j2 only executes on FIRST PostgreSQL container initialization.
# On existing containers (like Sese-AI production), this task provisions the database.
- name: Create Plane database on existing PostgreSQL container
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      docker exec -i {{ project_name }}_postgresql psql -U postgres << 'EOF'
      SELECT 'CREATE DATABASE plane_production' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'plane_production')\gexec
      DO $$ BEGIN CREATE USER plane WITH PASSWORD '{{ postgresql_password }}'; EXCEPTION WHEN duplicate_object THEN null; END $$;
      GRANT ALL PRIVILEGES ON DATABASE plane_production TO plane;
      ALTER DATABASE plane_production OWNER TO plane;
      EOF
      docker exec -i {{ project_name }}_postgresql psql -U postgres -d plane_production -c 'GRANT ALL ON SCHEMA public TO plane;'
  become: true
  register: postgresql_plane_db_result
  changed_when: "'CREATE DATABASE' in postgresql_plane_db_result.stdout"
  failed_when:
    - postgresql_plane_db_result.rc != 0
    - "'already exists' not in (postgresql_plane_db_result.stderr | default(''))"
    - "'No such container' not in (postgresql_plane_db_result.stderr | default(''))"
  tags: [postgresql, plane]
