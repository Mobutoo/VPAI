---
# common â€” tasks

# --- Deployment user ---
- name: Create deployment user
  ansible.builtin.user:
    name: "{{ prod_user }}"
    shell: /bin/bash
    groups: sudo
    append: true
    create_home: true
    state: present
  become: true

# --- Debian 13 minimal repos fix ---
- name: Check Debian repos completeness
  ansible.builtin.command:
    cmd: apt-cache policy gnupg
  changed_when: false
  failed_when: false
  register: common_repo_check
  become: true

- name: Fix Debian 13 minimal repos if needed
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/debian.sources
    content: |
      Types: deb
      URIs: http://deb.debian.org/debian
      Suites: trixie trixie-updates
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg

      Types: deb
      URIs: http://deb.debian.org/debian-security
      Suites: trixie-security
      Components: main contrib non-free non-free-firmware
      Signed-By: /usr/share/keyrings/debian-archive-keyring.gpg
    mode: "0644"
  become: true
  when: >
    (common_repo_check.rc != 0) or
    ('Candidate: (none)' in common_repo_check.stdout | default(''))
  notify: Update apt cache

- name: Flush handlers to update apt cache before package installs
  ansible.builtin.meta: flush_handlers

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  become: true

- name: Install common packages
  ansible.builtin.apt:
    name: "{{ common_packages }}"
    state: present
  become: true

- name: Configure locale
  community.general.locale_gen:
    name: "{{ common_locale }}"
    state: present
  become: true

- name: Set timezone
  community.general.timezone:
    name: "{{ common_timezone }}"
  become: true
  notify: Restart systemd-timesyncd

- name: Configure systemd-timesyncd
  ansible.builtin.template:
    src: timesyncd.conf.j2
    dest: /etc/systemd/timesyncd.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Restart systemd-timesyncd

- name: Enable and start systemd-timesyncd
  ansible.builtin.systemd:
    name: systemd-timesyncd
    state: started
    enabled: true
  become: true

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ common_hostname }}"
  become: true

- name: Add Headscale hostname to /etc/hosts
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: ".*{{ common_headscale_hostname }}$"
    line: "{{ common_headscale_ip }} {{ common_headscale_hostname }}"
    state: present
  become: true

- name: Configure sysctl parameters
  ansible.posix.sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: true
    state: present
    reload: true
  loop: "{{ common_sysctl_settings | dict2items }}"
  become: true

- name: Configure journald log limits
  ansible.builtin.template:
    src: journald.conf.j2
    dest: /etc/systemd/journald.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Restart systemd-journald

# --- Swap conditionnel (preprod 4 Go RAM) ---
- name: Check if swap file exists
  ansible.builtin.stat:
    path: "{{ common_swap_file }}"
  register: common_swap_file_check
  become: true
  when: common_swap_enable and ansible_memtotal_mb < 6144

- name: Create swap file
  ansible.builtin.command:
    cmd: "dd if=/dev/zero of={{ common_swap_file }} bs=1M count={{ common_swap_size_mb }}"
    creates: "{{ common_swap_file }}"
  become: true
  changed_when: true
  when:
    - common_swap_enable
    - ansible_memtotal_mb < 6144
    - not (common_swap_file_check.stat.exists | default(false))

- name: Set swap file permissions
  ansible.builtin.file:
    path: "{{ common_swap_file }}"
    owner: root
    group: root
    mode: "0600"
  become: true
  when: common_swap_enable and ansible_memtotal_mb < 6144

- name: Format swap file
  ansible.builtin.command:
    cmd: "mkswap {{ common_swap_file }}"
  become: true
  changed_when: true
  when:
    - common_swap_enable
    - ansible_memtotal_mb < 6144
    - not (common_swap_file_check.stat.exists | default(false))

- name: Enable swap file
  ansible.builtin.command:
    cmd: "swapon {{ common_swap_file }}"
  become: true
  changed_when: true
  failed_when: false
  when: common_swap_enable and ansible_memtotal_mb < 6144

- name: Add swap to fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: "^{{ common_swap_file }}"
    line: "{{ common_swap_file }} none swap sw 0 0"
    state: present
  become: true
  when: common_swap_enable and ansible_memtotal_mb < 6144

- name: Create project base directory
  ansible.builtin.file:
    path: "{{ common_project_base }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  become: true

- name: Create project subdirectories
  ansible.builtin.file:
    path: "{{ common_project_base }}/{{ item }}"
    state: directory
    owner: "{{ prod_user }}"
    group: "{{ prod_user }}"
    mode: "0755"
  loop: "{{ common_project_dirs }}"
  become: true
