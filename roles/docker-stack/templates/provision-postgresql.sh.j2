#!/bin/bash
# {{ ansible_managed }}
# PostgreSQL provisioning script — idempotent
# Creates databases and users if they don't exist

set -euo pipefail

CONTAINER="{{ project_name }}_postgresql"

{% for db in postgresql_databases %}
# === Database: {{ db.name }} ===
DB_EXISTS=$(docker exec "${CONTAINER}" psql -U postgres -tAc \
  "SELECT 1 FROM pg_database WHERE datname='{{ db.name }}'") || DB_EXISTS=""
if [ "$DB_EXISTS" != "1" ]; then
  echo "Creating database {{ db.name }}..."
  docker exec "${CONTAINER}" psql -U postgres -c \
    "CREATE DATABASE {{ db.name }};"
fi

USER_EXISTS=$(docker exec "${CONTAINER}" psql -U postgres -tAc \
  "SELECT 1 FROM pg_roles WHERE rolname='{{ db.user }}'") || USER_EXISTS=""
if [ "$USER_EXISTS" != "1" ]; then
  echo "Creating user {{ db.user }}..."
  docker exec "${CONTAINER}" psql -U postgres -c \
    "CREATE USER {{ db.user }} WITH ENCRYPTED PASSWORD '{{ postgresql_password }}';"
fi

docker exec "${CONTAINER}" psql -U postgres -c \
  "GRANT ALL PRIVILEGES ON DATABASE {{ db.name }} TO {{ db.user }};"
docker exec "${CONTAINER}" psql -U postgres -c \
  "ALTER DATABASE {{ db.name }} OWNER TO {{ db.user }};"
docker exec "${CONTAINER}" psql -U postgres -d {{ db.name }} -c \
  "GRANT ALL ON SCHEMA public TO {{ db.user }};"
{% for ext in db.extensions %}
docker exec "${CONTAINER}" psql -U postgres -d {{ db.name }} -c \
  "CREATE EXTENSION IF NOT EXISTS \"{{ ext }}\";"
{% endfor %}

{% endfor %}

# === Model Scores table (in n8n database) ===
# Used by the AI Model Scoring n8n workflow — PostgreSQL as source of truth
echo "Provisioning model_scores table in n8n database..."
docker exec "${CONTAINER}" psql -U n8n -d n8n -c "
CREATE TABLE IF NOT EXISTS model_scores (
  model       TEXT PRIMARY KEY,
  total_calls     INTEGER DEFAULT 0,
  successful_calls INTEGER DEFAULT 0,
  failed_calls    INTEGER DEFAULT 0,
  total_tokens    BIGINT DEFAULT 0,
  total_cost      DOUBLE PRECISION DEFAULT 0,
  total_latency_ms DOUBLE PRECISION DEFAULT 0,
  likes           INTEGER DEFAULT 0,
  dislikes        INTEGER DEFAULT 0,
  score           INTEGER DEFAULT 50,
  avg_cost_per_call DOUBLE PRECISION DEFAULT 0,
  avg_latency_ms  DOUBLE PRECISION DEFAULT 0,
  source          TEXT DEFAULT 'unknown',
  first_seen      TIMESTAMPTZ DEFAULT NOW(),
  last_updated    TIMESTAMPTZ DEFAULT NOW()
);
"

echo "PostgreSQL provisioning complete."
