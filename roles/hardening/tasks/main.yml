---
# hardening — tasks

- name: Install hardening packages
  ansible.builtin.apt:
    name:
      - openssh-server
      - fail2ban
      - ufw
      - unattended-upgrades
      - apt-listchanges
      - auditd
    state: present
  become: true

# === ANTI-LOCKOUT GUARD ===
# Detect if Tailscale VPN is connected before restricting SSH.
# If VPN is down or force_open is set, SSH stays open on all interfaces.
- name: "GUARD: Check Tailscale connectivity"
  ansible.builtin.command:
    cmd: tailscale status --json
  become: true
  changed_when: false
  failed_when: false
  register: hardening_tailscale_check

- name: "GUARD: Determine SSH lockdown mode"
  ansible.builtin.set_fact:
    hardening_vpn_ready: >-
      {{ (not hardening_ssh_force_open) and
         (hardening_tailscale_check.rc == 0) and
         (hardening_tailscale_check.stdout | from_json).BackendState | default('') == 'Running' }}

- name: "GUARD: SSH lockdown status"
  ansible.builtin.debug:
    msg: >-
      {{ 'SSH LOCKDOWN: VPN active, restricting SSH to VPN only (ListenAddress '
         ~ hardening_ssh_listen_address ~ ')'
         if hardening_vpn_ready | bool else
         'SSH OPEN: VPN not ready or force_open=true, SSH listens on 0.0.0.0 (all interfaces). '
         ~ 'Run with hardening_ssh_force_open=false once VPN is confirmed working.' }}

# === SSH ===
- name: Deploy SSH authorized keys
  ansible.posix.authorized_key:
    user: "{{ hardening_ssh_allowed_user }}"
    key: "{{ item }}"
    state: present
  loop: "{{ hardening_ssh_authorized_keys }}"
  become: true

- name: Deploy sshd_config
  ansible.builtin.template:
    src: sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"
    validate: "sshd -t -f %s"
  become: true
  notify: Restart sshd

# === FAIL2BAN ===
- name: Deploy Fail2Ban Caddy auth filter
  ansible.builtin.template:
    src: caddy-auth.conf.j2
    dest: /etc/fail2ban/filter.d/caddy-auth.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Restart fail2ban

- name: Deploy Fail2Ban Caddy botsearch filter
  ansible.builtin.template:
    src: caddy-botsearch.conf.j2
    dest: /etc/fail2ban/filter.d/caddy-botsearch.conf
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Restart fail2ban

- name: Configure Fail2ban jail
  ansible.builtin.template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: "0644"
  become: true
  notify: Restart fail2ban

- name: Enable and start Fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    state: started
    enabled: true
  become: true

# === CROWDSEC ===
- name: Install CrowdSec GPG key
  ansible.builtin.apt_key:
    url: https://packagecloud.io/crowdsec/crowdsec/gpgkey
    state: present
  become: true

- name: Add CrowdSec repository
  ansible.builtin.apt_repository:
    repo: "deb https://packagecloud.io/crowdsec/crowdsec/debian/ {{ ansible_distribution_release }} main"
    state: present
    filename: crowdsec
  become: true

- name: Install CrowdSec
  ansible.builtin.apt:
    name:
      - crowdsec
      - crowdsec-firewall-bouncer-iptables
    state: present
    update_cache: true
  become: true

- name: Install CrowdSec collections
  ansible.builtin.command:
    cmd: "cscli collections install {{ item }}"
  loop: "{{ hardening_crowdsec_collections }}"
  become: true
  changed_when: false

- name: Enable and start CrowdSec
  ansible.builtin.systemd:
    name: crowdsec
    state: started
    enabled: true
  become: true

# === UFW FIREWALL ===
- name: UFW — Reset to defaults
  community.general.ufw:
    state: reset
  become: true

- name: UFW — Set default deny incoming
  community.general.ufw:
    default: deny
    direction: incoming
  become: true

- name: UFW — Set default allow outgoing
  community.general.ufw:
    default: allow
    direction: outgoing
  become: true

- name: UFW — Allow HTTP and HTTPS
  community.general.ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop: "{{ hardening_ufw_allowed_tcp_ports }}"
  become: true

- name: UFW — Allow SSH from VPN only (locked down)
  community.general.ufw:
    rule: allow
    port: "{{ hardening_ssh_port }}"
    proto: tcp
    from_ip: "{{ hardening_ufw_vpn_network }}"
  become: true
  when: hardening_vpn_ready | bool

- name: UFW — Allow SSH from anywhere (open mode)
  community.general.ufw:
    rule: allow
    port: "{{ hardening_ssh_port }}"
    proto: tcp
  become: true
  when: not (hardening_vpn_ready | bool)

- name: UFW — Allow Tailscale UDP
  community.general.ufw:
    rule: allow
    port: "{{ hardening_ufw_tailscale_port }}"
    proto: udp
  become: true

- name: UFW — Enable firewall
  community.general.ufw:
    state: enabled
  become: true

# === UNATTENDED UPGRADES ===
- name: Configure unattended-upgrades
  ansible.builtin.template:
    src: 50unattended-upgrades.j2
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: "0644"
  become: true

- name: Enable automatic updates
  ansible.builtin.template:
    src: 20auto-upgrades.j2
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: "0644"
  become: true

# === AUDITD ===
- name: Configure auditd rules
  ansible.builtin.template:
    src: audit.rules.j2
    dest: /etc/audit/rules.d/hardening.rules
    owner: root
    group: root
    mode: "0640"
  become: true
  notify: Restart auditd

- name: Enable and start auditd
  ansible.builtin.systemd:
    name: auditd
    state: started
    enabled: true
  become: true
