#!/usr/bin/env python3
# {{ ansible_managed }}
# Workstation custom metrics collector â€” ComfyUI + Remotion
# Exports Prometheus metrics to textfile collector for node_exporter
# Runs as systemd service (workstation-metrics)

import time
import json
import os
import requests

TEXTFILE_DIR = "{{ node_exporter_textfile_dir }}"
INTERVAL = {{ workstation_metrics_interval }}
COMFYUI_URL = "http://localhost:{{ comfyui_port | default('8188') }}"
REMOTION_URL = "http://localhost:{{ remotion_port | default('3200') }}"
METRICS_FILE = os.path.join(TEXTFILE_DIR, "workstation.prom")


def fetch_comfyui_metrics():
    """Fetch ComfyUI system_stats and queue metrics."""
    metrics = {}
    try:
        r = requests.get(f"{COMFYUI_URL}/system_stats", timeout=5)
        if r.status_code == 200:
            data = r.json()
            # System info
            metrics["comfyui_up"] = 1
            system = data.get("system", {})
            metrics["comfyui_ram_used_bytes"] = system.get("ram_used", 0) * 1024 * 1024
            metrics["comfyui_ram_total_bytes"] = system.get("ram_total", 0) * 1024 * 1024
        else:
            metrics["comfyui_up"] = 0
    except Exception:
        metrics["comfyui_up"] = 0

    try:
        r = requests.get(f"{COMFYUI_URL}/queue", timeout=5)
        if r.status_code == 200:
            data = r.json()
            queue_running = data.get("queue_running", [])
            queue_pending = data.get("queue_pending", [])
            metrics["comfyui_queue_running"] = len(queue_running)
            metrics["comfyui_queue_pending"] = len(queue_pending)
    except Exception:
        metrics.setdefault("comfyui_queue_running", 0)
        metrics.setdefault("comfyui_queue_pending", 0)

    return metrics


def fetch_remotion_metrics():
    """Fetch Remotion /status metrics."""
    metrics = {}
    try:
        r = requests.get(f"{REMOTION_URL}/status", timeout=5)
        if r.status_code == 200:
            data = r.json()
            metrics["remotion_up"] = 1
            metrics["remotion_renders_active"] = data.get("active_renders", 0)
            metrics["remotion_renders_total"] = data.get("total_renders", 0)
        else:
            metrics["remotion_up"] = 0
    except Exception:
        metrics["remotion_up"] = 0
        metrics["remotion_renders_active"] = 0
        metrics["remotion_renders_total"] = 0

    return metrics


def write_metrics(all_metrics):
    """Write metrics to Prometheus textfile format."""
    lines = [
        "# HELP comfyui_up ComfyUI service is up (1) or down (0)",
        "# TYPE comfyui_up gauge",
        f"comfyui_up {all_metrics.get('comfyui_up', 0)}",
        "# HELP comfyui_ram_used_bytes ComfyUI RAM used in bytes",
        "# TYPE comfyui_ram_used_bytes gauge",
        f"comfyui_ram_used_bytes {all_metrics.get('comfyui_ram_used_bytes', 0)}",
        "# HELP comfyui_ram_total_bytes ComfyUI total RAM in bytes",
        "# TYPE comfyui_ram_total_bytes gauge",
        f"comfyui_ram_total_bytes {all_metrics.get('comfyui_ram_total_bytes', 0)}",
        "# HELP comfyui_queue_pending ComfyUI pending queue length",
        "# TYPE comfyui_queue_pending gauge",
        f"comfyui_queue_pending {all_metrics.get('comfyui_queue_pending', 0)}",
        "# HELP comfyui_queue_running ComfyUI running queue length",
        "# TYPE comfyui_queue_running gauge",
        f"comfyui_queue_running {all_metrics.get('comfyui_queue_running', 0)}",
        "# HELP remotion_up Remotion service is up (1) or down (0)",
        "# TYPE remotion_up gauge",
        f"remotion_up {all_metrics.get('remotion_up', 0)}",
        "# HELP remotion_renders_active Active Remotion renders",
        "# TYPE remotion_renders_active gauge",
        f"remotion_renders_active {all_metrics.get('remotion_renders_active', 0)}",
        "# HELP remotion_renders_total Total Remotion renders since startup",
        "# TYPE remotion_renders_total counter",
        f"remotion_renders_total {all_metrics.get('remotion_renders_total', 0)}",
    ]
    tmp_file = METRICS_FILE + ".tmp"
    with open(tmp_file, "w") as f:
        f.write("\n".join(lines) + "\n")
    os.replace(tmp_file, METRICS_FILE)


if __name__ == "__main__":
    while True:
        try:
            metrics = {}
            metrics.update(fetch_comfyui_metrics())
            metrics.update(fetch_remotion_metrics())
            write_metrics(metrics)
        except Exception as e:
            pass
        time.sleep(INTERVAL)
