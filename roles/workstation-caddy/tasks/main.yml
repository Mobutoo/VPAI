---
# workstation-caddy — tasks
# Caddy natif sur le Pi (pas Docker) — reverse proxy TLS pour MC + OpenCode
# TLS via ACME DNS-01 (OVH API) — memes credentials que le prod
# Caddy custom build via xcaddy (module dns.providers.ovh requis)

# --- Install Go >= 1.24 (requis pour caddy-dns/ovh v1.1.0 et xcaddy) ---
# Ubuntu 24.04 fournit Go 1.22 — insuffisant pour Caddy v2.10.x + plugin OVH
# On installe Go officiel depuis go.dev/dl (ARM64) dans /usr/local/go
- name: Check current Go version
  ansible.builtin.command:
    cmd: /usr/local/go/bin/go version
  register: workstation_go_version
  changed_when: false
  failed_when: false
  become: true

- name: Download and install Go {{ workstation_go_official_version }} ARM64
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      curl -fsSL "https://dl.google.com/go/go{{ workstation_go_official_version }}.linux-arm64.tar.gz" \
        -o /tmp/go{{ workstation_go_official_version }}.linux-arm64.tar.gz
      rm -rf /usr/local/go
      tar -C /usr/local -xzf /tmp/go{{ workstation_go_official_version }}.linux-arm64.tar.gz
      rm /tmp/go{{ workstation_go_official_version }}.linux-arm64.tar.gz
      echo "INSTALLED:$(/usr/local/go/bin/go version)"
  args:
    creates: /usr/local/go/bin/go
  register: workstation_go_install
  changed_when: "'INSTALLED:' in workstation_go_install.stdout"
  become: true
  when: workstation_go_version.rc != 0 or workstation_go_official_version not in workstation_go_version.stdout

# --- Install xcaddy ---
# creates: idempotent — ne re-installe pas si binaire present
- name: Install xcaddy via Go install
  ansible.builtin.command:
    cmd: /usr/local/go/bin/go install github.com/caddyserver/xcaddy/cmd/xcaddy@{{ workstation_xcaddy_version }}
  args:
    creates: "{{ workstation_xcaddy_gobin }}/xcaddy"
  environment:
    GOPATH: "{{ workstation_xcaddy_gopath }}"
    GOBIN: "{{ workstation_xcaddy_gobin }}"
    HOME: /root
    PATH: /usr/local/go/bin:/usr/bin:/bin
  changed_when: false
  become: true

# --- Build Caddy avec module OVH DNS ---
# Construit /usr/local/bin/caddy-ovh si absent ou version differente
- name: Check if Caddy OVH binary exists with correct version
  ansible.builtin.command:
    cmd: /usr/bin/caddy version
  register: workstation_caddy_current_version
  changed_when: false
  failed_when: false
  become: true

- name: Build Caddy with OVH DNS module via xcaddy
  ansible.builtin.shell:
    executable: /bin/bash
    cmd: |
      set -euo pipefail
      {{ workstation_xcaddy_gobin }}/xcaddy build {{ workstation_caddy_version }} \
        --with github.com/caddy-dns/ovh \
        --output /usr/bin/caddy
      chmod 755 /usr/bin/caddy
      echo "BUILT:$(caddy version)"
  register: workstation_caddy_build
  changed_when: "'BUILT:' in workstation_caddy_build.stdout"
  failed_when: workstation_caddy_build.rc != 0
  environment:
    GOPATH: "{{ workstation_xcaddy_gopath }}"
    GOBIN: "{{ workstation_xcaddy_gobin }}"
    HOME: /root
    PATH: /usr/local/go/bin:/usr/bin:/bin
  become: true
  when: >-
    workstation_caddy_current_version.rc != 0
    or workstation_caddy_version not in workstation_caddy_current_version.stdout

- name: Display Caddy build result
  ansible.builtin.debug:
    msg: "{{ workstation_caddy_build.stdout | default('skipped (already up to date)') }}"

# --- Directories ---
- name: Create Caddy config directory
  ansible.builtin.file:
    path: "{{ workstation_caddy_config_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

- name: Create Caddy data directory
  ansible.builtin.file:
    path: "{{ workstation_caddy_data_dir }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true

# --- Configuration ---
- name: Deploy Caddyfile
  ansible.builtin.template:
    src: Caddyfile-workstation.j2
    dest: "{{ workstation_caddy_config_dir }}/Caddyfile"
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - Validate Caddyfile
    - Reload caddy-workstation

# --- Systemd service ---
- name: Deploy caddy-workstation systemd service
  ansible.builtin.template:
    src: caddy-workstation.service.j2
    dest: /etc/systemd/system/caddy-workstation.service
    owner: root
    group: root
    mode: "0644"
  become: true
  notify:
    - Reload systemd
    - Restart caddy-workstation

# Desactiver le service caddy par defaut seulement s il existe (I5 fix)
- name: Check if default caddy service exists
  ansible.builtin.stat:
    path: /lib/systemd/system/caddy.service
  register: workstation_default_caddy_service

- name: Disable default Caddy service (if present)
  ansible.builtin.systemd:
    name: caddy
    state: stopped
    enabled: false
    daemon_reload: true
  become: true
  when: workstation_default_caddy_service.stat.exists

- name: Enable and start caddy-workstation service
  ansible.builtin.systemd:
    name: caddy-workstation
    state: started
    enabled: true
    daemon_reload: true
  become: true
